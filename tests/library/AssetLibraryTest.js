var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var BitmapImage2D = require("awayjs-core/lib/data/BitmapImage2D");
var AssetEvent = require("awayjs-core/lib/events/AssetEvent");
var LoaderEvent = require("awayjs-core/lib/events/LoaderEvent");
var AssetLibrary = require("awayjs-core/lib/library/AssetLibrary");
var URLRequest = require("awayjs-core/lib/net/URLRequest");
var ParserBase = require("awayjs-core/lib/parsers/ParserBase");
var ParserDataFormat = require("awayjs-core/lib/parsers/ParserDataFormat");
var AssetLibraryTest = (function () {
    function AssetLibraryTest() {
        var _this = this;
        this.height = 0;
        AssetLibrary.enableParser(JSONTextureParser);
        this.token = AssetLibrary.load(new URLRequest('assets/JSNParserTest.json'));
        this.token.addEventListener(LoaderEvent.RESOURCE_COMPLETE, function (event) { return _this.onResourceComplete(event); });
        this.token.addEventListener(AssetEvent.ASSET_COMPLETE, function (event) { return _this.onAssetComplete(event); });
        this.token = AssetLibrary.load(new URLRequest('assets/1024x1024.png'));
        this.token.addEventListener(LoaderEvent.RESOURCE_COMPLETE, function (event) { return _this.onResourceComplete(event); });
        this.token.addEventListener(AssetEvent.ASSET_COMPLETE, function (event) { return _this.onAssetComplete(event); });
        this.token = AssetLibrary.load(new URLRequest('assets/atlas.xml'));
        this.token.addEventListener(LoaderEvent.RESOURCE_COMPLETE, function (event) { return _this.onResourceComplete(event); });
        this.token.addEventListener(AssetEvent.ASSET_COMPLETE, function (event) { return _this.onAssetComplete(event); });
    }
    AssetLibraryTest.prototype.onAssetComplete = function (event) {
        console.log('------------------------------------------------------------------------------');
        console.log('AssetEvent.ASSET_COMPLETE', event.asset);
        console.log('------------------------------------------------------------------------------');
        if (event.asset.isAsset(BitmapImage2D)) {
            var bitmapData = event.asset;
            document.body.appendChild(bitmapData.getCanvas());
            bitmapData.getCanvas().style.position = 'absolute';
            bitmapData.getCanvas().style.top = this.height + 'px';
            this.height += (bitmapData.getCanvas().height + 10);
        }
    };
    AssetLibraryTest.prototype.onResourceComplete = function (event) {
        var loader = event.target;
        console.log('------------------------------------------------------------------------------');
        console.log('LoaderEvent.RESOURCE_COMPLETE', event);
        console.log('------------------------------------------------------------------------------');
    };
    return AssetLibraryTest;
})();
/**
* ImageParser provides a "parser" for natively supported image types (jpg, png). While it simply loads bytes into
* a loader object, it wraps it in a BitmapImage2DResource so resource management can happen consistently without
* exception cases.
*/
var JSONTextureParser = (function (_super) {
    __extends(JSONTextureParser, _super);
    /**
     * Creates a new ImageParser object.
     * @param uri The url or id of the data or file to be parsed.
     * @param extra The holder for extra contextual data that the parser might need.
     */
    function JSONTextureParser() {
        _super.call(this, ParserDataFormat.PLAIN_TEXT);
        this.STATE_PARSE_DATA = 0;
        this.STATE_LOAD_IMAGES = 1;
        this.STATE_COMPLETE = 2;
        this._state = -1;
        this._dependencyCount = 0;
        this._loadedTextures = new Array();
        this._state = this.STATE_PARSE_DATA;
    }
    /**
     * Indicates whether or not a given file extension is supported by the parser.
     * @param extension The file extension of a potential file to be parsed.
     * @return Whether or not the given file type is supported.
     */
    JSONTextureParser.supportsType = function (extension) {
        extension = extension.toLowerCase();
        return extension == "json";
    };
    /**
     * Tests whether a data block can be parsed by the parser.
     * @param data The data block to potentially be parsed.
     * @return Whether or not the given data is supported.
     */
    JSONTextureParser.supportsData = function (data) {
        try {
            var obj = JSON.parse(data);
            if (obj)
                return true;
            return false;
        }
        catch (e) {
            return false;
        }
        return false;
    };
    /**
     * @inheritDoc
     */
    JSONTextureParser.prototype._iResolveDependency = function (resourceDependency) {
        var resource = resourceDependency.assets[0];
        this._pFinalizeAsset(resource, resourceDependency._iLoader.url);
        this._loadedTextures.push(resource);
        //console.log( 'JSONTextureParser._iResolveDependency' , resourceDependency );
        //console.log( 'JSONTextureParser._iResolveDependency resource: ' , resource );
        this._dependencyCount--;
        if (this._dependencyCount == 0)
            this._state = this.STATE_COMPLETE;
    };
    /**
     * @inheritDoc
     */
    JSONTextureParser.prototype._iResolveDependencyFailure = function (resourceDependency) {
        this._dependencyCount--;
        if (this._dependencyCount == 0)
            this._state = this.STATE_COMPLETE;
    };
    JSONTextureParser.prototype.parseJson = function () {
        if (JSONTextureParser.supportsData(this.data)) {
            try {
                var json = JSON.parse(this.data);
                var data = json.data;
                var rec;
                var rq;
                for (var c = 0; c < data.length; c++) {
                    rec = data[c];
                    var uri = rec.image;
                    var id = rec.id;
                    rq = new URLRequest(uri);
                    this._pAddDependency('JSON_ID_' + id, rq, false, null, true);
                }
                this._dependencyCount = data.length;
                this._state = this.STATE_LOAD_IMAGES;
                this._pPauseAndRetrieveDependencies();
            }
            catch (e) {
                this._state = this.STATE_COMPLETE;
            }
        }
    };
    /**
     * @inheritDoc
     */
    JSONTextureParser.prototype._pProceedParsing = function () {
        console.log('JSONTextureParser._pProceedParsing', this._state);
        switch (this._state) {
            case this.STATE_PARSE_DATA:
                this.parseJson();
                return ParserBase.MORE_TO_PARSE;
                break;
            case this.STATE_LOAD_IMAGES:
                break;
            case this.STATE_COMPLETE:
                return ParserBase.PARSING_DONE;
                break;
        }
        return ParserBase.MORE_TO_PARSE;
    };
    return JSONTextureParser;
})(ParserBase);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYnJhcnkvQXNzZXRMaWJyYXJ5VGVzdC50cyJdLCJuYW1lcyI6WyJBc3NldExpYnJhcnlUZXN0IiwiQXNzZXRMaWJyYXJ5VGVzdC5jb25zdHJ1Y3RvciIsIkFzc2V0TGlicmFyeVRlc3Qub25Bc3NldENvbXBsZXRlIiwiQXNzZXRMaWJyYXJ5VGVzdC5vblJlc291cmNlQ29tcGxldGUiLCJKU09OVGV4dHVyZVBhcnNlciIsIkpTT05UZXh0dXJlUGFyc2VyLmNvbnN0cnVjdG9yIiwiSlNPTlRleHR1cmVQYXJzZXIuc3VwcG9ydHNUeXBlIiwiSlNPTlRleHR1cmVQYXJzZXIuc3VwcG9ydHNEYXRhIiwiSlNPTlRleHR1cmVQYXJzZXIuX2lSZXNvbHZlRGVwZW5kZW5jeSIsIkpTT05UZXh0dXJlUGFyc2VyLl9pUmVzb2x2ZURlcGVuZGVuY3lGYWlsdXJlIiwiSlNPTlRleHR1cmVQYXJzZXIucGFyc2VKc29uIiwiSlNPTlRleHR1cmVQYXJzZXIuX3BQcm9jZWVkUGFyc2luZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxhQUFhLFdBQVksb0NBQW9DLENBQUMsQ0FBQztBQUN0RSxJQUFPLFVBQVUsV0FBYSxtQ0FBbUMsQ0FBQyxDQUFDO0FBQ25FLElBQU8sV0FBVyxXQUFhLG9DQUFvQyxDQUFDLENBQUM7QUFFckUsSUFBTyxZQUFZLFdBQWEsc0NBQXNDLENBQUMsQ0FBQztBQUl4RSxJQUFPLFVBQVUsV0FBYSxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQ2hFLElBQU8sVUFBVSxXQUFhLG9DQUFvQyxDQUFDLENBQUM7QUFDcEUsSUFBTyxnQkFBZ0IsV0FBWSwwQ0FBMEMsQ0FBQyxDQUFDO0FBRy9FLElBQU0sZ0JBQWdCO0lBTXJCQSxTQU5LQSxnQkFBZ0JBO1FBQXRCQyxpQkF1RENBO1FBcERRQSxXQUFNQSxHQUFZQSxDQUFDQSxDQUFDQTtRQU0zQkEsWUFBWUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxDQUFDQTtRQUU3Q0EsSUFBSUEsQ0FBQ0Es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QUFVQSxDQUFDQSxZQUFZQSxDQUFDQTtnQkFDL0JBLEtBQUtBLENBQUNBO1FBQ1JBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLGFBQWFBLENBQUNBO0lBQ2pDQSxDQUFDQTtJQUNGUCx3QkFBQ0E7QUFBREEsQ0E3SUEsQUE2SUNBLEVBN0krQixVQUFVLEVBNkl6QyIsImZpbGUiOiJsaWJyYXJ5L0Fzc2V0TGlicmFyeVRlc3QuanMiLCJzb3VyY2VSb290IjoiLi90ZXN0cyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCaXRtYXBJbWFnZTJEXHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9kYXRhL0JpdG1hcEltYWdlMkRcIik7XG5pbXBvcnQgQXNzZXRFdmVudFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ldmVudHMvQXNzZXRFdmVudFwiKTtcbmltcG9ydCBMb2FkZXJFdmVudFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ldmVudHMvTG9hZGVyRXZlbnRcIik7XG5pbXBvcnQgUGFyc2VyRXZlbnRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZXZlbnRzL1BhcnNlckV2ZW50XCIpO1xuaW1wb3J0IEFzc2V0TGlicmFyeVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9saWJyYXJ5L0Fzc2V0TGlicmFyeVwiKTtcbmltcG9ydCBBc3NldExvYWRlclx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9saWJyYXJ5L0Fzc2V0TG9hZGVyXCIpO1xuaW1wb3J0IEFzc2V0TG9hZGVyVG9rZW5cdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2xpYnJhcnkvQXNzZXRMb2FkZXJUb2tlblwiKTtcbmltcG9ydCBJQXNzZXRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9saWJyYXJ5L0lBc3NldFwiKTtcbmltcG9ydCBVUkxSZXF1ZXN0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL25ldC9VUkxSZXF1ZXN0XCIpO1xuaW1wb3J0IFBhcnNlckJhc2VcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvcGFyc2Vycy9QYXJzZXJCYXNlXCIpO1xuaW1wb3J0IFBhcnNlckRhdGFGb3JtYXRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3BhcnNlcnMvUGFyc2VyRGF0YUZvcm1hdFwiKTtcbmltcG9ydCBSZXNvdXJjZURlcGVuZGVuY3lcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9wYXJzZXJzL1Jlc291cmNlRGVwZW5kZW5jeVwiKTtcblxuY2xhc3MgQXNzZXRMaWJyYXJ5VGVzdFxue1xuXG5cdHByaXZhdGUgaGVpZ2h0IDogbnVtYmVyID0gMDtcblxuXHRwcml2YXRlIHRva2VuIDogQXNzZXRMb2FkZXJUb2tlbjtcblx0Y29uc3RydWN0b3IoKVxuXHR7XG5cblx0XHRBc3NldExpYnJhcnkuZW5hYmxlUGFyc2VyKEpTT05UZXh0dXJlUGFyc2VyKTtcblxuXHRcdHRoaXMudG9rZW4gPSBBc3NldExpYnJhcnkubG9hZChuZXcgVVJMUmVxdWVzdCgnYXNzZXRzL0pTTlBhcnNlclRlc3QuanNvbicpICk7XG5cdFx0dGhpcy50b2tlbi5hZGRFdmVudExpc3RlbmVyKCBMb2FkZXJFdmVudC5SRVNPVVJDRV9DT01QTEVURSAsIChldmVudDpMb2FkZXJFdmVudCkgPT4gdGhpcy5vblJlc291cmNlQ29tcGxldGUoZXZlbnQpICk7XG5cdFx0dGhpcy50b2tlbi5hZGRFdmVudExpc3RlbmVyKEFzc2V0RXZlbnQuQVNTRVRfQ09NUExFVEUgLCAoZXZlbnQ6QXNzZXRFdmVudCkgPT4gdGhpcy5vbkFzc2V0Q29tcGxldGUoZXZlbnQpICk7XG5cblx0XHR0aGlzLnRva2VuID0gQXNzZXRMaWJyYXJ5LmxvYWQobmV3IFVSTFJlcXVlc3QoJ2Fzc2V0cy8xMDI0eDEwMjQucG5nJykgKTtcblx0XHR0aGlzLnRva2VuLmFkZEV2ZW50TGlzdGVuZXIoIExvYWRlckV2ZW50LlJFU09VUkNFX0NPTVBMRVRFICwgKGV2ZW50OkxvYWRlckV2ZW50KSA9PiB0aGlzLm9uUmVzb3VyY2VDb21wbGV0ZShldmVudCkgKTtcblx0XHR0aGlzLnRva2VuLmFkZEV2ZW50TGlzdGVuZXIoQXNzZXRFdmVudC5BU1NFVF9DT01QTEVURSAsIChldmVudDpBc3NldEV2ZW50KSA9PiB0aGlzLm9uQXNzZXRDb21wbGV0ZShldmVudCkgKTtcblxuXHRcdHRoaXMudG9rZW4gPSBBc3NldExpYnJhcnkubG9hZChuZXcgVVJMUmVxdWVzdCgnYXNzZXRzL2F0bGFzLnhtbCcpICk7XG5cdFx0dGhpcy50b2tlbi5hZGRFdmVudExpc3RlbmVyKCBMb2FkZXJFdmVudC5SRVNPVVJDRV9DT01QTEVURSAsIChldmVudDpMb2FkZXJFdmVudCkgPT4gdGhpcy5vblJlc291cmNlQ29tcGxldGUoZXZlbnQpICk7XG5cdFx0dGhpcy50b2tlbi5hZGRFdmVudExpc3RlbmVyKEFzc2V0RXZlbnQuQVNTRVRfQ09NUExFVEUgLCAoZXZlbnQ6QXNzZXRFdmVudCkgPT4gdGhpcy5vbkFzc2V0Q29tcGxldGUoZXZlbnQpICk7XG5cblx0fVxuXG5cdHB1YmxpYyBvbkFzc2V0Q29tcGxldGUoZXZlbnQ6QXNzZXRFdmVudClcblx0e1xuXG5cdFx0Y29uc29sZS5sb2coICctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nKTtcblx0XHRjb25zb2xlLmxvZyggJ0Fzc2V0RXZlbnQuQVNTRVRfQ09NUExFVEUnICwgZXZlbnQuYXNzZXQpO1xuXHRcdGNvbnNvbGUubG9nKCAnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJyk7XG5cblx0XHRpZiAoZXZlbnQuYXNzZXQuaXNBc3NldChCaXRtYXBJbWFnZTJEKSkge1xuXHRcdFx0dmFyIGJpdG1hcERhdGEgOiBCaXRtYXBJbWFnZTJEID0gPEJpdG1hcEltYWdlMkQ+IGV2ZW50LmFzc2V0O1xuXG5cdFx0XHRkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKCBiaXRtYXBEYXRhLmdldENhbnZhcygpICk7XG5cblx0XHRcdGJpdG1hcERhdGEuZ2V0Q2FudmFzKCkuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xuXHRcdFx0Yml0bWFwRGF0YS5nZXRDYW52YXMoKS5zdHlsZS50b3AgPSB0aGlzLmhlaWdodCArICdweCc7XG5cblxuXHRcdFx0dGhpcy5oZWlnaHQgKz0gKCBiaXRtYXBEYXRhLmdldENhbnZhcygpLmhlaWdodCArIDEwICkgO1xuXHRcdH1cblx0fVxuXHRwdWJsaWMgb25SZXNvdXJjZUNvbXBsZXRlKGV2ZW50OkxvYWRlckV2ZW50KVxuXHR7XG5cblx0XHR2YXIgbG9hZGVyIDogQXNzZXRMb2FkZXIgPSA8QXNzZXRMb2FkZXI+IGV2ZW50LnRhcmdldDtcblxuXHRcdGNvbnNvbGUubG9nKCAnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJyk7XG5cdFx0Y29uc29sZS5sb2coICdMb2FkZXJFdmVudC5SRVNPVVJDRV9DT01QTEVURScgLCBldmVudCAgKTtcblx0XHRjb25zb2xlLmxvZyggJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpO1xuXG5cdH1cblxufVxuXG4vKipcbiogSW1hZ2VQYXJzZXIgcHJvdmlkZXMgYSBcInBhcnNlclwiIGZvciBuYXRpdmVseSBzdXBwb3J0ZWQgaW1hZ2UgdHlwZXMgKGpwZywgcG5nKS4gV2hpbGUgaXQgc2ltcGx5IGxvYWRzIGJ5dGVzIGludG9cbiogYSBsb2FkZXIgb2JqZWN0LCBpdCB3cmFwcyBpdCBpbiBhIEJpdG1hcEltYWdlMkRSZXNvdXJjZSBzbyByZXNvdXJjZSBtYW5hZ2VtZW50IGNhbiBoYXBwZW4gY29uc2lzdGVudGx5IHdpdGhvdXRcbiogZXhjZXB0aW9uIGNhc2VzLlxuKi9cbmNsYXNzIEpTT05UZXh0dXJlUGFyc2VyIGV4dGVuZHMgUGFyc2VyQmFzZVxue1xuXHRwcml2YXRlIFNUQVRFX1BBUlNFX0RBVEE6bnVtYmVyID0gMDtcblx0cHJpdmF0ZSBTVEFURV9MT0FEX0lNQUdFUzpudW1iZXIgPSAxO1xuXHRwcml2YXRlIFNUQVRFX0NPTVBMRVRFOm51bWJlciA9IDI7XG5cblx0cHJpdmF0ZSBfc3RhdGU6bnVtYmVyID0gLTE7XG5cdHByaXZhdGUgX3N0YXJ0ZWRQYXJzaW5nOmJvb2xlYW47XG5cdHByaXZhdGUgX2RvbmVQYXJzaW5nOmJvb2xlYW47XG5cdHByaXZhdGUgX2RlcGVuZGVuY3lDb3VudDpudW1iZXIgPSAwO1xuXHRwcml2YXRlIF9sb2FkZWRUZXh0dXJlczpBcnJheTxCaXRtYXBJbWFnZTJEPjtcblxuXHQvKipcblx0ICogQ3JlYXRlcyBhIG5ldyBJbWFnZVBhcnNlciBvYmplY3QuXG5cdCAqIEBwYXJhbSB1cmkgVGhlIHVybCBvciBpZCBvZiB0aGUgZGF0YSBvciBmaWxlIHRvIGJlIHBhcnNlZC5cblx0ICogQHBhcmFtIGV4dHJhIFRoZSBob2xkZXIgZm9yIGV4dHJhIGNvbnRleHR1YWwgZGF0YSB0aGF0IHRoZSBwYXJzZXIgbWlnaHQgbmVlZC5cblx0ICovXG5cdGNvbnN0cnVjdG9yKClcblx0e1xuXHRcdHN1cGVyKFBhcnNlckRhdGFGb3JtYXQuUExBSU5fVEVYVCk7XG5cblx0XHR0aGlzLl9sb2FkZWRUZXh0dXJlcyA9IG5ldyBBcnJheTxCaXRtYXBJbWFnZTJEPigpO1xuXHRcdHRoaXMuX3N0YXRlID0gdGhpcy5TVEFURV9QQVJTRV9EQVRBO1xuXHR9XG5cblx0LyoqXG5cdCAqIEluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCBhIGdpdmVuIGZpbGUgZXh0ZW5zaW9uIGlzIHN1cHBvcnRlZCBieSB0aGUgcGFyc2VyLlxuXHQgKiBAcGFyYW0gZXh0ZW5zaW9uIFRoZSBmaWxlIGV4dGVuc2lvbiBvZiBhIHBvdGVudGlhbCBmaWxlIHRvIGJlIHBhcnNlZC5cblx0ICogQHJldHVybiBXaGV0aGVyIG9yIG5vdCB0aGUgZ2l2ZW4gZmlsZSB0eXBlIGlzIHN1cHBvcnRlZC5cblx0ICovXG5cblx0cHVibGljIHN0YXRpYyBzdXBwb3J0c1R5cGUoZXh0ZW5zaW9uIDogc3RyaW5nKSA6IGJvb2xlYW5cblx0e1xuXHRcdGV4dGVuc2lvbiA9IGV4dGVuc2lvbi50b0xvd2VyQ2FzZSgpO1xuXHRcdHJldHVybiBleHRlbnNpb24gPT0gXCJqc29uXCI7XG5cdH1cblxuXHQvKipcblx0ICogVGVzdHMgd2hldGhlciBhIGRhdGEgYmxvY2sgY2FuIGJlIHBhcnNlZCBieSB0aGUgcGFyc2VyLlxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgZGF0YSBibG9jayB0byBwb3RlbnRpYWxseSBiZSBwYXJzZWQuXG5cdCAqIEByZXR1cm4gV2hldGhlciBvciBub3QgdGhlIGdpdmVuIGRhdGEgaXMgc3VwcG9ydGVkLlxuXHQgKi9cblx0cHVibGljIHN0YXRpYyBzdXBwb3J0c0RhdGEoZGF0YSA6IGFueSkgOiBib29sZWFuXG5cdHtcblx0XHR0cnkge1xuXHRcdFx0dmFyIG9iaiA9IEpTT04ucGFyc2UoZGF0YSk7XG5cblx0XHRcdGlmIChvYmopXG5cdFx0XHRcdHJldHVybiB0cnVlO1xuXG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fSBjYXRjaCAoIGUgKSB7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX2lSZXNvbHZlRGVwZW5kZW5jeShyZXNvdXJjZURlcGVuZGVuY3k6UmVzb3VyY2VEZXBlbmRlbmN5KVxuXHR7XG5cdFx0dmFyIHJlc291cmNlIDogQml0bWFwSW1hZ2UyRCA9IDxCaXRtYXBJbWFnZTJEPiByZXNvdXJjZURlcGVuZGVuY3kuYXNzZXRzWzBdO1xuXG5cdFx0dGhpcy5fcEZpbmFsaXplQXNzZXQoPElBc3NldD4gcmVzb3VyY2UsIHJlc291cmNlRGVwZW5kZW5jeS5faUxvYWRlci51cmwpO1xuXG5cdFx0dGhpcy5fbG9hZGVkVGV4dHVyZXMucHVzaCggcmVzb3VyY2UgKTtcblxuXHRcdC8vY29uc29sZS5sb2coICdKU09OVGV4dHVyZVBhcnNlci5faVJlc29sdmVEZXBlbmRlbmN5JyAsIHJlc291cmNlRGVwZW5kZW5jeSApO1xuXHRcdC8vY29uc29sZS5sb2coICdKU09OVGV4dHVyZVBhcnNlci5faVJlc29sdmVEZXBlbmRlbmN5IHJlc291cmNlOiAnICwgcmVzb3VyY2UgKTtcblxuXHRcdHRoaXMuX2RlcGVuZGVuY3lDb3VudC0tO1xuXG5cdFx0aWYgKCB0aGlzLl9kZXBlbmRlbmN5Q291bnQgPT0gMClcblx0XHRcdHRoaXMuX3N0YXRlID0gdGhpcy5TVEFURV9DT01QTEVURTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pUmVzb2x2ZURlcGVuZGVuY3lGYWlsdXJlKHJlc291cmNlRGVwZW5kZW5jeTpSZXNvdXJjZURlcGVuZGVuY3kpXG5cdHtcblx0XHR0aGlzLl9kZXBlbmRlbmN5Q291bnQtLTtcblxuXHRcdGlmICggdGhpcy5fZGVwZW5kZW5jeUNvdW50ID09IDApXG5cdFx0XHR0aGlzLl9zdGF0ZSA9IHRoaXMuU1RBVEVfQ09NUExFVEU7XG5cdH1cblxuXHRwcml2YXRlIHBhcnNlSnNvbiggKSA6IHZvaWRcblx0e1xuXHRcdGlmIChKU09OVGV4dHVyZVBhcnNlci5zdXBwb3J0c0RhdGEodGhpcy5kYXRhKSkge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0dmFyIGpzb246YW55ID0gSlNPTi5wYXJzZSh0aGlzLmRhdGEpO1xuXHRcdFx0XHR2YXIgZGF0YTpBcnJheTxhbnk+ID0gPEFycmF5PGFueT4+IGpzb24uZGF0YTtcblxuXHRcdFx0XHR2YXIgcmVjOmFueTtcblx0XHRcdFx0dmFyIHJxOlVSTFJlcXVlc3Q7XG5cblx0XHRcdFx0Zm9yICh2YXIgYyA6IG51bWJlciA9IDA7IGMgPCBkYXRhLmxlbmd0aDsgYyArKykge1xuXHRcdFx0XHRcdHJlYyA9IGRhdGFbY107XG5cblx0XHRcdFx0XHR2YXIgdXJpOnN0cmluZyA9IDxzdHJpbmc+IHJlYy5pbWFnZTtcblx0XHRcdFx0XHR2YXIgaWQ6c3RyaW5nID0gPHN0cmluZz4gcmVjLmlkO1xuXG5cdFx0XHRcdFx0cnEgPSBuZXcgVVJMUmVxdWVzdCh1cmkpO1xuXG5cdFx0XHRcdFx0dGhpcy5fcEFkZERlcGVuZGVuY3koJ0pTT05fSURfJyArIGlkLCBycSwgZmFsc2UsIG51bGwsIHRydWUpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0dGhpcy5fZGVwZW5kZW5jeUNvdW50ID0gZGF0YS5sZW5ndGg7XG5cdFx0XHRcdHRoaXMuX3N0YXRlID0gdGhpcy5TVEFURV9MT0FEX0lNQUdFUztcblxuXHRcdFx0XHR0aGlzLl9wUGF1c2VBbmRSZXRyaWV2ZURlcGVuZGVuY2llcygpO1xuXG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdHRoaXMuX3N0YXRlID0gdGhpcy5TVEFURV9DT01QTEVURTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX3BQcm9jZWVkUGFyc2luZygpIDogYm9vbGVhblxuXHR7XG5cdFx0Y29uc29sZS5sb2coICdKU09OVGV4dHVyZVBhcnNlci5fcFByb2NlZWRQYXJzaW5nJyAsIHRoaXMuX3N0YXRlICk7XG5cblx0XHRzd2l0Y2ggKHRoaXMuX3N0YXRlKSB7XG5cdFx0XHRjYXNlIHRoaXMuU1RBVEVfUEFSU0VfREFUQTpcblx0XHRcdFx0dGhpcy5wYXJzZUpzb24oKTtcblx0XHRcdFx0cmV0dXJuIFBhcnNlckJhc2UuTU9SRV9UT19QQVJTRTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIHRoaXMuU1RBVEVfTE9BRF9JTUFHRVM6XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSB0aGlzLlNUQVRFX0NPTVBMRVRFOlxuXHRcdFx0XHRyZXR1cm4gUGFyc2VyQmFzZS5QQVJTSU5HX0RPTkU7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdH1cblxuXHRcdHJldHVybiBQYXJzZXJCYXNlLk1PUkVfVE9fUEFSU0U7XG5cdH1cbn0iXX0=