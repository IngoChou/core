var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var AssetEvent = require("awayjs-core/lib/events/AssetEvent");
var LoaderEvent = require("awayjs-core/lib/events/LoaderEvent");

var AssetLibrary = require("awayjs-core/lib/core/library/AssetLibrary");

var URLRequest = require("awayjs-core/lib/core/net/URLRequest");

var ParserBase = require("awayjs-core/lib/parsers/ParserBase");
var ParserDataFormat = require("awayjs-core/lib/parsers/ParserDataFormat");

var AssetLibraryTest = (function () {
    function AssetLibraryTest() {
        var _this = this;
        this.height = 0;
        AssetLibrary.enableParser(JSONTextureParser);

        this.token = AssetLibrary.load(new URLRequest('assets/JSNParserTest.json'));
        this.token.addEventListener(LoaderEvent.RESOURCE_COMPLETE, function (event) {
            return _this.onResourceComplete(event);
        });
        this.token.addEventListener(AssetEvent.ASSET_COMPLETE, function (event) {
            return _this.onAssetComplete(event);
        });

        this.token = AssetLibrary.load(new URLRequest('assets/1024x1024.png'));
        this.token.addEventListener(LoaderEvent.RESOURCE_COMPLETE, function (event) {
            return _this.onResourceComplete(event);
        });
        this.token.addEventListener(AssetEvent.ASSET_COMPLETE, function (event) {
            return _this.onAssetComplete(event);
        });
    }
    AssetLibraryTest.prototype.onAssetComplete = function (event) {
        console.log('------------------------------------------------------------------------------');
        console.log('AssetEvent.ASSET_COMPLETE', AssetLibrary.getAsset(event.asset.name));
        console.log('------------------------------------------------------------------------------');

        var imageTexture = AssetLibrary.getAsset(event.asset.name);

        document.body.appendChild(imageTexture.htmlImageElement);

        imageTexture.htmlImageElement.style.position = 'absolute';
        imageTexture.htmlImageElement.style.top = this.height + 'px';

        this.height += (imageTexture.htmlImageElement.height + 10);
    };
    AssetLibraryTest.prototype.onResourceComplete = function (event) {
        var loader = event.target;

        console.log('------------------------------------------------------------------------------');
        console.log('LoaderEvent.RESOURCE_COMPLETE', event);
        console.log('------------------------------------------------------------------------------');
    };
    return AssetLibraryTest;
})();

/**
* ImageParser provides a "parser" for natively supported image types (jpg, png). While it simply loads bytes into
* a loader object, it wraps it in a BitmapDataResource so resource management can happen consistently without
* exception cases.
*/
var JSONTextureParser = (function (_super) {
    __extends(JSONTextureParser, _super);
    /**
    * Creates a new ImageParser object.
    * @param uri The url or id of the data or file to be parsed.
    * @param extra The holder for extra contextual data that the parser might need.
    */
    function JSONTextureParser() {
        _super.call(this, ParserDataFormat.PLAIN_TEXT);
        this.STATE_PARSE_DATA = 0;
        this.STATE_LOAD_IMAGES = 1;
        this.STATE_COMPLETE = 2;
        this._state = -1;
        this._dependencyCount = 0;

        this._loadedTextures = new Array();
        this._state = this.STATE_PARSE_DATA;
    }
    /**
    * Indicates whether or not a given file extension is supported by the parser.
    * @param extension The file extension of a potential file to be parsed.
    * @return Whether or not the given file type is supported.
    */
    JSONTextureParser.supportsType = function (extension) {
        extension = extension.toLowerCase();
        return extension == "json";
    };

    /**
    * Tests whether a data block can be parsed by the parser.
    * @param data The data block to potentially be parsed.
    * @return Whether or not the given data is supported.
    */
    JSONTextureParser.supportsData = function (data) {
        try  {
            var obj = JSON.parse(data);

            if (obj)
                return true;

            return false;
        } catch (e) {
            return false;
        }

        return false;
    };

    /**
    * @inheritDoc
    */
    JSONTextureParser.prototype._iResolveDependency = function (resourceDependency) {
        var resource = resourceDependency.assets[0];

        this._pFinalizeAsset(resource, resourceDependency._iLoader.url);

        this._loadedTextures.push(resource);

        //console.log( 'JSONTextureParser._iResolveDependency' , resourceDependency );
        //console.log( 'JSONTextureParser._iResolveDependency resource: ' , resource );
        this._dependencyCount--;

        if (this._dependencyCount == 0)
            this._state = this.STATE_COMPLETE;
    };

    /**
    * @inheritDoc
    */
    JSONTextureParser.prototype._iResolveDependencyFailure = function (resourceDependency) {
        this._dependencyCount--;

        if (this._dependencyCount == 0)
            this._state = this.STATE_COMPLETE;
    };

    JSONTextureParser.prototype.parseJson = function () {
        if (JSONTextureParser.supportsData(this.data)) {
            try  {
                var json = JSON.parse(this.data);
                var data = json.data;

                var rec;
                var rq;

                for (var c = 0; c < data.length; c++) {
                    rec = data[c];

                    var uri = rec.image;
                    var id = rec.id;

                    rq = new URLRequest(uri);

                    this._pAddDependency('JSON_ID_' + id, rq, false, null, true);
                }

                this._dependencyCount = data.length;
                this._state = this.STATE_LOAD_IMAGES;

                this._pPauseAndRetrieveDependencies();
            } catch (e) {
                this._state = this.STATE_COMPLETE;
            }
        }
    };

    /**
    * @inheritDoc
    */
    JSONTextureParser.prototype._pProceedParsing = function () {
        console.log('JSONTextureParser._pProceedParsing', this._state);

        switch (this._state) {
            case this.STATE_PARSE_DATA:
                this.parseJson();
                return ParserBase.MORE_TO_PARSE;
                break;
            case this.STATE_LOAD_IMAGES:
                break;
            case this.STATE_COMPLETE:
                return ParserBase.PARSING_DONE;
                break;
        }

        return ParserBase.MORE_TO_PARSE;
    };
    return JSONTextureParser;
})(ParserBase);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYnJhcnkvQXNzZXRMaWJyYXJ5VGVzdC50cyJdLCJuYW1lcyI6WyJBc3NldExpYnJhcnlUZXN0IiwiQXNzZXRMaWJyYXJ5VGVzdC5jb25zdHJ1Y3RvciIsIkFzc2V0TGlicmFyeVRlc3Qub25Bc3NldENvbXBsZXRlIiwiQXNzZXRMaWJyYXJ5VGVzdC5vblJlc291cmNlQ29tcGxldGUiLCJKU09OVGV4dHVyZVBhcnNlciIsIkpTT05UZXh0dXJlUGFyc2VyLmNvbnN0cnVjdG9yIiwiSlNPTlRleHR1cmVQYXJzZXIuc3VwcG9ydHNUeXBlIiwiSlNPTlRleHR1cmVQYXJzZXIuc3VwcG9ydHNEYXRhIiwiSlNPTlRleHR1cmVQYXJzZXIuX2lSZXNvbHZlRGVwZW5kZW5jeSIsIkpTT05UZXh0dXJlUGFyc2VyLl9pUmVzb2x2ZURlcGVuZGVuY3lGYWlsdXJlIiwiSlNPTlRleHR1cmVQYXJzZXIucGFyc2VKc29uIiwiSlNPTlRleHR1cmVQYXJzZXIuX3BQcm9jZWVkUGFyc2luZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNkRBQW1FO0FBQ25FLCtEQUFxRTs7QUFFckUsdUVBQTZFOztBQUk3RSwrREFBcUU7O0FBR3JFLDhEQUFvRTtBQUNwRSwwRUFBK0U7O0FBRy9FO0lBTUNBO1FBQUFDLGlCQWFDQTtRQWhCREEsS0FBUUEsTUFBTUEsR0FBWUEsQ0FBQ0EsQ0FBQ0E7UUFNM0JBLFlBQVlBLENBQUNBLFlBQVlBLENBQUNBLGlCQUFpQkEsQ0FBQ0E7O1FBRTVDQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxZQUFZQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxVQUFVQSxDQUFDQSwyQkFBMkJBLENBQUNBLENBQUVBO1FBQzVFQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLENBQUVBLFdBQVdBLENBQUNBLGlCQUFpQkEsRUFBR0EsVUFBQ0EsS0FBaUJBO21CQUFLQSxLQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLEtBQUtBLENBQUNBO1FBQTlCQSxDQUE4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QUNBLGlCQUFpQkE7O2dCQUVwQ0EsSUFBSUEsQ0FBQ0EsOEJBQThCQSxDQUFDQSxDQUFDQTthQUVyQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBRUE7Z0JBQ1hBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBLGNBQWNBO2FBQ2pDQTtTQUNEQTtJQUNGQSxDQUFDQTs7SUFJRE47O01BREdBO21EQUNIQTtRQUVDTyxPQUFPQSxDQUFDQSxHQUFHQSxDQUFFQSxvQ0FBb0NBLEVBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUVBOztRQUVqRUEsUUFBUUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7WUFDbkJBLEtBQUtBLElBQUlBLENBQUNBLGdCQUFnQkE7Z0JBQ3pCQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQTtnQkFDaEJBLE9BQU9BLFVBQVVBLENBQUNBLGFBQWFBO2dCQUMvQkEsS0FBTUE7QUFBQUEsWUFDUEEsS0FBS0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQTtnQkFDMUJBLEtBQU1BO0FBQUFBLFlBQ1BBLEtBQUtBLElBQUlBLENBQUNBLGNBQWNBO2dCQUN2QkEsT0FBT0EsVUFBVUEsQ0FBQ0EsWUFBWUE7Z0JBQzlCQSxLQUFNQTtBQUFBQSxTQUNQQTs7UUFFREEsT0FBT0EsVUFBVUEsQ0FBQ0EsYUFBYUE7SUFDaENBLENBQUNBO0lBQ0ZQLHlCQUFDQTtBQUFEQSxDQUFDQSxFQTdJK0IsVUFBVSxFQTZJekM7QUFBQSIsImZpbGUiOiJsaWJyYXJ5L0Fzc2V0TGlicmFyeVRlc3QuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL3JvYmJhdGVtYW4vV2Vic3Rvcm1Qcm9qZWN0cy9hd2F5anMtY29yZS8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQXNzZXRFdmVudFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ldmVudHMvQXNzZXRFdmVudFwiKTtcbmltcG9ydCBMb2FkZXJFdmVudFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ldmVudHMvTG9hZGVyRXZlbnRcIik7XG5pbXBvcnQgUGFyc2VyRXZlbnRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZXZlbnRzL1BhcnNlckV2ZW50XCIpO1xuaW1wb3J0IEFzc2V0TGlicmFyeVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2xpYnJhcnkvQXNzZXRMaWJyYXJ5XCIpO1xuaW1wb3J0IEFzc2V0TG9hZGVyXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvbGlicmFyeS9Bc3NldExvYWRlclwiKTtcbmltcG9ydCBBc3NldExvYWRlclRva2VuXHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2xpYnJhcnkvQXNzZXRMb2FkZXJUb2tlblwiKTtcbmltcG9ydCBJQXNzZXRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2xpYnJhcnkvSUFzc2V0XCIpO1xuaW1wb3J0IFVSTFJlcXVlc3RcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9uZXQvVVJMUmVxdWVzdFwiKTtcbmltcG9ydCBJbWFnZVRleHR1cmVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvSW1hZ2VUZXh0dXJlXCIpO1xuaW1wb3J0IFRleHR1cmUyREJhc2VcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3RleHR1cmVzL1RleHR1cmUyREJhc2VcIik7XG5pbXBvcnQgUGFyc2VyQmFzZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9wYXJzZXJzL1BhcnNlckJhc2VcIik7XG5pbXBvcnQgUGFyc2VyRGF0YUZvcm1hdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvcGFyc2Vycy9QYXJzZXJEYXRhRm9ybWF0XCIpO1xuaW1wb3J0IFJlc291cmNlRGVwZW5kZW5jeVx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3BhcnNlcnMvUmVzb3VyY2VEZXBlbmRlbmN5XCIpO1xuXG5jbGFzcyBBc3NldExpYnJhcnlUZXN0XG57XG5cblx0cHJpdmF0ZSBoZWlnaHQgOiBudW1iZXIgPSAwO1xuXG5cdHByaXZhdGUgdG9rZW4gOiBBc3NldExvYWRlclRva2VuO1xuXHRjb25zdHJ1Y3RvcigpXG5cdHtcblxuXHRcdEFzc2V0TGlicmFyeS5lbmFibGVQYXJzZXIoSlNPTlRleHR1cmVQYXJzZXIpIDtcblxuXHRcdHRoaXMudG9rZW4gPSBBc3NldExpYnJhcnkubG9hZChuZXcgVVJMUmVxdWVzdCgnYXNzZXRzL0pTTlBhcnNlclRlc3QuanNvbicpICk7XG5cdFx0dGhpcy50b2tlbi5hZGRFdmVudExpc3RlbmVyKCBMb2FkZXJFdmVudC5SRVNPVVJDRV9DT01QTEVURSAsIChldmVudDpMb2FkZXJFdmVudCkgPT4gdGhpcy5vblJlc291cmNlQ29tcGxldGUoZXZlbnQpICk7XG5cdFx0dGhpcy50b2tlbi5hZGRFdmVudExpc3RlbmVyKEFzc2V0RXZlbnQuQVNTRVRfQ09NUExFVEUgLCAoZXZlbnQ6QXNzZXRFdmVudCkgPT4gdGhpcy5vbkFzc2V0Q29tcGxldGUoZXZlbnQpICk7XG5cblx0XHR0aGlzLnRva2VuID0gQXNzZXRMaWJyYXJ5LmxvYWQobmV3IFVSTFJlcXVlc3QoJ2Fzc2V0cy8xMDI0eDEwMjQucG5nJykgKTtcblx0XHR0aGlzLnRva2VuLmFkZEV2ZW50TGlzdGVuZXIoIExvYWRlckV2ZW50LlJFU09VUkNFX0NPTVBMRVRFICwgKGV2ZW50OkxvYWRlckV2ZW50KSA9PiB0aGlzLm9uUmVzb3VyY2VDb21wbGV0ZShldmVudCkgKTtcblx0XHR0aGlzLnRva2VuLmFkZEV2ZW50TGlzdGVuZXIoQXNzZXRFdmVudC5BU1NFVF9DT01QTEVURSAsIChldmVudDpBc3NldEV2ZW50KSA9PiB0aGlzLm9uQXNzZXRDb21wbGV0ZShldmVudCkgKTtcblxuXHR9XG5cblx0cHVibGljIG9uQXNzZXRDb21wbGV0ZShldmVudDpBc3NldEV2ZW50KVxuXHR7XG5cblx0XHRjb25zb2xlLmxvZyggJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpO1xuXHRcdGNvbnNvbGUubG9nKCAnQXNzZXRFdmVudC5BU1NFVF9DT01QTEVURScgLCBBc3NldExpYnJhcnkuZ2V0QXNzZXQoZXZlbnQuYXNzZXQubmFtZSkgKTtcblx0XHRjb25zb2xlLmxvZyggJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpO1xuXG5cdFx0dmFyIGltYWdlVGV4dHVyZSA6IEltYWdlVGV4dHVyZSA9IDxJbWFnZVRleHR1cmU+IEFzc2V0TGlicmFyeS5nZXRBc3NldChldmVudC5hc3NldC5uYW1lKTtcblxuXHRcdGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoIGltYWdlVGV4dHVyZS5odG1sSW1hZ2VFbGVtZW50ICk7XG5cblx0XHRpbWFnZVRleHR1cmUuaHRtbEltYWdlRWxlbWVudC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7XG5cdFx0aW1hZ2VUZXh0dXJlLmh0bWxJbWFnZUVsZW1lbnQuc3R5bGUudG9wID0gdGhpcy5oZWlnaHQgKyAncHgnO1xuXG5cblx0XHR0aGlzLmhlaWdodCArPSAoIGltYWdlVGV4dHVyZS5odG1sSW1hZ2VFbGVtZW50LmhlaWdodCArIDEwICkgO1xuXG5cdH1cblx0cHVibGljIG9uUmVzb3VyY2VDb21wbGV0ZShldmVudDpMb2FkZXJFdmVudClcblx0e1xuXG5cdFx0dmFyIGxvYWRlciA6IEFzc2V0TG9hZGVyID0gPEFzc2V0TG9hZGVyPiBldmVudC50YXJnZXQ7XG5cblx0XHRjb25zb2xlLmxvZyggJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpO1xuXHRcdGNvbnNvbGUubG9nKCAnTG9hZGVyRXZlbnQuUkVTT1VSQ0VfQ09NUExFVEUnICwgZXZlbnQgICk7XG5cdFx0Y29uc29sZS5sb2coICctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nKTtcblxuXHR9XG5cbn1cblxuLyoqXG4qIEltYWdlUGFyc2VyIHByb3ZpZGVzIGEgXCJwYXJzZXJcIiBmb3IgbmF0aXZlbHkgc3VwcG9ydGVkIGltYWdlIHR5cGVzIChqcGcsIHBuZykuIFdoaWxlIGl0IHNpbXBseSBsb2FkcyBieXRlcyBpbnRvXG4qIGEgbG9hZGVyIG9iamVjdCwgaXQgd3JhcHMgaXQgaW4gYSBCaXRtYXBEYXRhUmVzb3VyY2Ugc28gcmVzb3VyY2UgbWFuYWdlbWVudCBjYW4gaGFwcGVuIGNvbnNpc3RlbnRseSB3aXRob3V0XG4qIGV4Y2VwdGlvbiBjYXNlcy5cbiovXG5jbGFzcyBKU09OVGV4dHVyZVBhcnNlciBleHRlbmRzIFBhcnNlckJhc2Vcbntcblx0cHJpdmF0ZSBTVEFURV9QQVJTRV9EQVRBOm51bWJlciA9IDA7XG5cdHByaXZhdGUgU1RBVEVfTE9BRF9JTUFHRVM6bnVtYmVyID0gMTtcblx0cHJpdmF0ZSBTVEFURV9DT01QTEVURTpudW1iZXIgPSAyO1xuXG5cdHByaXZhdGUgX3N0YXRlOm51bWJlciA9IC0xO1xuXHRwcml2YXRlIF9zdGFydGVkUGFyc2luZzpib29sZWFuO1xuXHRwcml2YXRlIF9kb25lUGFyc2luZzpib29sZWFuO1xuXHRwcml2YXRlIF9kZXBlbmRlbmN5Q291bnQ6bnVtYmVyID0gMDtcblx0cHJpdmF0ZSBfbG9hZGVkVGV4dHVyZXM6QXJyYXk8VGV4dHVyZTJEQmFzZT47XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgSW1hZ2VQYXJzZXIgb2JqZWN0LlxuXHQgKiBAcGFyYW0gdXJpIFRoZSB1cmwgb3IgaWQgb2YgdGhlIGRhdGEgb3IgZmlsZSB0byBiZSBwYXJzZWQuXG5cdCAqIEBwYXJhbSBleHRyYSBUaGUgaG9sZGVyIGZvciBleHRyYSBjb250ZXh0dWFsIGRhdGEgdGhhdCB0aGUgcGFyc2VyIG1pZ2h0IG5lZWQuXG5cdCAqL1xuXHRjb25zdHJ1Y3RvcigpXG5cdHtcblx0XHRzdXBlcihQYXJzZXJEYXRhRm9ybWF0LlBMQUlOX1RFWFQpO1xuXG5cdFx0dGhpcy5fbG9hZGVkVGV4dHVyZXMgPSBuZXcgQXJyYXk8VGV4dHVyZTJEQmFzZT4oKTtcblx0XHR0aGlzLl9zdGF0ZSA9IHRoaXMuU1RBVEVfUEFSU0VfREFUQTtcblx0fVxuXG5cdC8qKlxuXHQgKiBJbmRpY2F0ZXMgd2hldGhlciBvciBub3QgYSBnaXZlbiBmaWxlIGV4dGVuc2lvbiBpcyBzdXBwb3J0ZWQgYnkgdGhlIHBhcnNlci5cblx0ICogQHBhcmFtIGV4dGVuc2lvbiBUaGUgZmlsZSBleHRlbnNpb24gb2YgYSBwb3RlbnRpYWwgZmlsZSB0byBiZSBwYXJzZWQuXG5cdCAqIEByZXR1cm4gV2hldGhlciBvciBub3QgdGhlIGdpdmVuIGZpbGUgdHlwZSBpcyBzdXBwb3J0ZWQuXG5cdCAqL1xuXG5cdHB1YmxpYyBzdGF0aWMgc3VwcG9ydHNUeXBlKGV4dGVuc2lvbiA6IHN0cmluZykgOiBib29sZWFuXG5cdHtcblx0XHRleHRlbnNpb24gPSBleHRlbnNpb24udG9Mb3dlckNhc2UoKTtcblx0XHRyZXR1cm4gZXh0ZW5zaW9uID09IFwianNvblwiO1xuXHR9XG5cblx0LyoqXG5cdCAqIFRlc3RzIHdoZXRoZXIgYSBkYXRhIGJsb2NrIGNhbiBiZSBwYXJzZWQgYnkgdGhlIHBhcnNlci5cblx0ICogQHBhcmFtIGRhdGEgVGhlIGRhdGEgYmxvY2sgdG8gcG90ZW50aWFsbHkgYmUgcGFyc2VkLlxuXHQgKiBAcmV0dXJuIFdoZXRoZXIgb3Igbm90IHRoZSBnaXZlbiBkYXRhIGlzIHN1cHBvcnRlZC5cblx0ICovXG5cdHB1YmxpYyBzdGF0aWMgc3VwcG9ydHNEYXRhKGRhdGEgOiBhbnkpIDogYm9vbGVhblxuXHR7XG5cdFx0dHJ5IHtcblx0XHRcdHZhciBvYmogPSBKU09OLnBhcnNlKGRhdGEpO1xuXG5cdFx0XHRpZiAob2JqKVxuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblxuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH0gY2F0Y2ggKCBlICkge1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblxuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pUmVzb2x2ZURlcGVuZGVuY3kocmVzb3VyY2VEZXBlbmRlbmN5OlJlc291cmNlRGVwZW5kZW5jeSlcblx0e1xuXHRcdHZhciByZXNvdXJjZSA6IFRleHR1cmUyREJhc2UgPSA8VGV4dHVyZTJEQmFzZT4gcmVzb3VyY2VEZXBlbmRlbmN5LmFzc2V0c1swXTtcblxuXHRcdHRoaXMuX3BGaW5hbGl6ZUFzc2V0KDxJQXNzZXQ+IHJlc291cmNlLCByZXNvdXJjZURlcGVuZGVuY3kuX2lMb2FkZXIudXJsKTtcblxuXHRcdHRoaXMuX2xvYWRlZFRleHR1cmVzLnB1c2goIHJlc291cmNlICk7XG5cblx0XHQvL2NvbnNvbGUubG9nKCAnSlNPTlRleHR1cmVQYXJzZXIuX2lSZXNvbHZlRGVwZW5kZW5jeScgLCByZXNvdXJjZURlcGVuZGVuY3kgKTtcblx0XHQvL2NvbnNvbGUubG9nKCAnSlNPTlRleHR1cmVQYXJzZXIuX2lSZXNvbHZlRGVwZW5kZW5jeSByZXNvdXJjZTogJyAsIHJlc291cmNlICk7XG5cblx0XHR0aGlzLl9kZXBlbmRlbmN5Q291bnQtLTtcblxuXHRcdGlmICggdGhpcy5fZGVwZW5kZW5jeUNvdW50ID09IDApXG5cdFx0XHR0aGlzLl9zdGF0ZSA9IHRoaXMuU1RBVEVfQ09NUExFVEU7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfaVJlc29sdmVEZXBlbmRlbmN5RmFpbHVyZShyZXNvdXJjZURlcGVuZGVuY3k6UmVzb3VyY2VEZXBlbmRlbmN5KVxuXHR7XG5cdFx0dGhpcy5fZGVwZW5kZW5jeUNvdW50LS07XG5cblx0XHRpZiAoIHRoaXMuX2RlcGVuZGVuY3lDb3VudCA9PSAwKVxuXHRcdFx0dGhpcy5fc3RhdGUgPSB0aGlzLlNUQVRFX0NPTVBMRVRFO1xuXHR9XG5cblx0cHJpdmF0ZSBwYXJzZUpzb24oICkgOiB2b2lkXG5cdHtcblx0XHRpZiAoSlNPTlRleHR1cmVQYXJzZXIuc3VwcG9ydHNEYXRhKHRoaXMuZGF0YSkpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdHZhciBqc29uOmFueSA9IEpTT04ucGFyc2UodGhpcy5kYXRhKTtcblx0XHRcdFx0dmFyIGRhdGE6QXJyYXk8YW55PiA9IDxBcnJheTxhbnk+PiBqc29uLmRhdGE7XG5cblx0XHRcdFx0dmFyIHJlYzphbnk7XG5cdFx0XHRcdHZhciBycTpVUkxSZXF1ZXN0O1xuXG5cdFx0XHRcdGZvciAodmFyIGMgOiBudW1iZXIgPSAwOyBjIDwgZGF0YS5sZW5ndGg7IGMgKyspIHtcblx0XHRcdFx0XHRyZWMgPSBkYXRhW2NdO1xuXG5cdFx0XHRcdFx0dmFyIHVyaTpzdHJpbmcgPSA8c3RyaW5nPiByZWMuaW1hZ2U7XG5cdFx0XHRcdFx0dmFyIGlkOnN0cmluZyA9IDxzdHJpbmc+IHJlYy5pZDtcblxuXHRcdFx0XHRcdHJxID0gbmV3IFVSTFJlcXVlc3QodXJpKTtcblxuXHRcdFx0XHRcdHRoaXMuX3BBZGREZXBlbmRlbmN5KCdKU09OX0lEXycgKyBpZCwgcnEsIGZhbHNlLCBudWxsLCB0cnVlKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHRoaXMuX2RlcGVuZGVuY3lDb3VudCA9IGRhdGEubGVuZ3RoO1xuXHRcdFx0XHR0aGlzLl9zdGF0ZSA9IHRoaXMuU1RBVEVfTE9BRF9JTUFHRVM7XG5cblx0XHRcdFx0dGhpcy5fcFBhdXNlQW5kUmV0cmlldmVEZXBlbmRlbmNpZXMoKTtcblxuXHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHR0aGlzLl9zdGF0ZSA9IHRoaXMuU1RBVEVfQ09NUExFVEU7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9wUHJvY2VlZFBhcnNpbmcoKSA6IGJvb2xlYW5cblx0e1xuXHRcdGNvbnNvbGUubG9nKCAnSlNPTlRleHR1cmVQYXJzZXIuX3BQcm9jZWVkUGFyc2luZycgLCB0aGlzLl9zdGF0ZSApO1xuXG5cdFx0c3dpdGNoICh0aGlzLl9zdGF0ZSkge1xuXHRcdFx0Y2FzZSB0aGlzLlNUQVRFX1BBUlNFX0RBVEE6XG5cdFx0XHRcdHRoaXMucGFyc2VKc29uKCk7XG5cdFx0XHRcdHJldHVybiBQYXJzZXJCYXNlLk1PUkVfVE9fUEFSU0U7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSB0aGlzLlNUQVRFX0xPQURfSU1BR0VTOlxuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgdGhpcy5TVEFURV9DT01QTEVURTpcblx0XHRcdFx0cmV0dXJuIFBhcnNlckJhc2UuUEFSU0lOR19ET05FO1xuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cblx0XHRyZXR1cm4gUGFyc2VyQmFzZS5NT1JFX1RPX1BBUlNFO1xuXHR9XG59Il19