var BitmapData = require("awayjs-core/lib/base/BitmapData");
var Matrix = require("awayjs-core/lib/geom/Matrix");
var Rectangle = require("awayjs-core/lib/geom/Rectangle");
/**
 * MipmapGenerator is a helper class that uploads BitmapData to a Texture including mipmap levels.
 */
var MipmapGenerator = (function () {
    function MipmapGenerator() {
    }
    MipmapGenerator.generateMipMaps = function (source, output, alpha) {
        if (alpha === void 0) { alpha = false; }
        var w = source.width;
        var h = source.height;
        var i = 0;
        var mipmap;
        MipmapGenerator._rect.width = w;
        MipmapGenerator._rect.height = h;
        while (w >= 1 && h >= 1) {
            mipmap = output[i] = MipmapGenerator._getMipmapHolder(output[i], w, h);
            if (alpha)
                mipmap.fillRect(MipmapGenerator._rect, 0);
            MipmapGenerator._matrix.a = MipmapGenerator._rect.width / source.width;
            MipmapGenerator._matrix.d = MipmapGenerator._rect.height / source.height;
            mipmap.draw(source, MipmapGenerator._matrix); //TODO: smoothing?
            w >>= 1;
            h >>= 1;
            MipmapGenerator._rect.width = w > 1 ? w : 1;
            MipmapGenerator._rect.height = h > 1 ? h : 1;
            i++;
        }
    };
    MipmapGenerator._getMipmapHolder = function (mipMapHolder, newW, newH) {
        if (mipMapHolder) {
            if (mipMapHolder.width == newW && mipMapHolder.height == newH)
                return mipMapHolder;
            MipmapGenerator.freeMipMapHolder(mipMapHolder);
        }
        if (!MipmapGenerator._mipMaps[newW]) {
            MipmapGenerator._mipMaps[newW] = [];
            MipmapGenerator._mipMapUses[newW] = [];
        }
        if (!MipmapGenerator._mipMaps[newW][newH]) {
            mipMapHolder = MipmapGenerator._mipMaps[newW][newH] = new BitmapData(newW, newH, true);
            MipmapGenerator._mipMapUses[newW][newH] = 1;
        }
        else {
            MipmapGenerator._mipMapUses[newW][newH] = MipmapGenerator._mipMapUses[newW][newH] + 1;
            mipMapHolder = MipmapGenerator._mipMaps[newW][newH];
        }
        return mipMapHolder;
    };
    MipmapGenerator.freeMipMapHolder = function (mipMapHolder) {
        var holderWidth = mipMapHolder.width;
        var holderHeight = mipMapHolder.height;
        if (--MipmapGenerator._mipMapUses[holderWidth][holderHeight] == 0) {
            MipmapGenerator._mipMaps[holderWidth][holderHeight].dispose();
            MipmapGenerator._mipMaps[holderWidth][holderHeight] = null;
        }
    };
    MipmapGenerator._mipMaps = [];
    MipmapGenerator._mipMapUses = [];
    MipmapGenerator._matrix = new Matrix();
    MipmapGenerator._rect = new Rectangle();
    return MipmapGenerator;
})();
module.exports = MipmapGenerator;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1jb3JlL2xpYi90ZXh0dXJlcy9taXBtYXBnZW5lcmF0b3IudHMiXSwibmFtZXMiOlsiTWlwbWFwR2VuZXJhdG9yIiwiTWlwbWFwR2VuZXJhdG9yLmNvbnN0cnVjdG9yIiwiTWlwbWFwR2VuZXJhdG9yLmdlbmVyYXRlTWlwTWFwcyIsIk1pcG1hcEdlbmVyYXRvci5fZ2V0TWlwbWFwSG9sZGVyIiwiTWlwbWFwR2VuZXJhdG9yLmZyZWVNaXBNYXBIb2xkZXIiXSwibWFwcGluZ3MiOiJBQUFBLElBQU8sVUFBVSxXQUFjLGlDQUFpQyxDQUFDLENBQUM7QUFDbEUsSUFBTyxNQUFNLFdBQWUsNkJBQTZCLENBQUMsQ0FBQztBQUMzRCxJQUFPLFNBQVMsV0FBYyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBRWhFLEFBR0E7O0dBREc7SUFDRyxlQUFlO0lBQXJCQSxTQUFNQSxlQUFlQTtJQXNGckJDLENBQUNBO0lBcEVjRCwrQkFBZUEsR0FBN0JBLFVBQThCQSxNQUFVQSxFQUFFQSxNQUF5QkEsRUFBRUEsS0FBcUJBO1FBQXJCRSxxQkFBcUJBLEdBQXJCQSxhQUFxQkE7UUFFekZBLElBQUlBLENBQUNBLEdBQVVBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO1FBQzVCQSxJQUFJQSxDQUFDQSxHQUFVQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUM3QkEsSUFBSUEsQ0FBQ0EsR0FBVUEsQ0FBQ0EsQ0FBQ0E7UUFFakJBLElBQUlBLE1BQWlCQSxDQUFDQTtRQUV0QkEsZUFBZUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDaENBLGVBQWVBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBO1FBRWpDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUV6QkEsTUFBTUEsR0FBR0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsZUFBZUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUV2RUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0E7Z0JBQ1RBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLGVBQWVBLENBQUNBLEtBQUtBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBRTNDQSxlQUFlQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxHQUFHQSxlQUFlQSxDQUFDQSxLQUFLQSxDQUFDQSxLQUFLQSxHQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtZQUNyRUEsZUFBZUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsZUFBZUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsR0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7WUFFdkVBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLGVBQWVBLENBQUNBLE9BQU9BLENBQUNBLEVBQUVBLGtCQUFrQkE7WUFFaEVBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBQ1JBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBRVJBLGVBQWVBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLEdBQUVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1lBQzNDQSxlQUFlQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUU1Q0EsQ0FBQ0EsRUFBRUEsQ0FBQ0E7UUFDTEEsQ0FBQ0E7SUFDRkEsQ0FBQ0E7SUFFY0YsZ0NBQWdCQSxHQUEvQkEsVUFBZ0NBLFlBQXVCQSxFQUFFQSxJQUFXQSxFQUFFQSxJQUFXQTtRQUVoRkcsRUFBRUEsQ0FBQ0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbEJBLEVBQUVBLENBQUNBLENBQUNBLFlBQVlBLENBQUNBLEtBQUtBLElBQUlBLElBQUlBLElBQUlBLFlBQVlBLENBQUNBLE1BQU1BLElBQUlBLElBQUlBLENBQUNBO2dCQUM3REEsTUFBTUEsQ0FBQ0EsWUFBWUEsQ0FBQ0E7WUFFckJBLGVBQWVBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0E7UUFDaERBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLGVBQWVBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3JDQSxlQUFlQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUNwQ0EsZUFBZUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFDeENBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLGVBQWVBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQzNDQSxZQUFZQSxHQUFHQSxlQUFlQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQSxVQUFVQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUN2RkEsZUFBZUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDN0NBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ1BBLGVBQWVBLENBQUNBLFdBQVdBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLGVBQWVBLENBQUNBLFdBQVdBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1lBQ3RGQSxZQUFZQSxHQUFHQSxlQUFlQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNyREEsQ0FBQ0E7UUFFREEsTUFBTUEsQ0FBQ0EsWUFBWUEsQ0FBQ0E7SUFDckJBLENBQUNBO0lBRWFILGdDQUFnQkEsR0FBOUJBLFVBQStCQSxZQUF1QkE7UUFFckRJLElBQUlBLFdBQVdBLEdBQVVBLFlBQVlBLENBQUNBLEtBQUtBLENBQUNBO1FBQzVDQSxJQUFJQSxZQUFZQSxHQUFVQSxZQUFZQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUU5Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsZUFBZUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbkVBLGVBQWVBLENBQUNBLFFBQVFBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLFlBQVlBLENBQUNBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBO1lBQzlEQSxlQUFlQSxDQUFDQSxRQUFRQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxZQUFZQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUM1REEsQ0FBQ0E7SUFDRkEsQ0FBQ0E7SUFuRmNKLHdCQUFRQSxHQUFHQSxFQUFFQSxDQUFDQTtJQUNkQSwyQkFBV0EsR0FBR0EsRUFBRUEsQ0FBQ0E7SUFFakJBLHVCQUFPQSxHQUFVQSxJQUFJQSxNQUFNQSxFQUFFQSxDQUFDQTtJQUM5QkEscUJBQUtBLEdBQWFBLElBQUlBLFNBQVNBLEVBQUVBLENBQUNBO0lBZ0ZsREEsc0JBQUNBO0FBQURBLENBdEZBLEFBc0ZDQSxJQUFBO0FBRUQsQUFBeUIsaUJBQWhCLGVBQWUsQ0FBQyIsImZpbGUiOiJ0ZXh0dXJlcy9NaXBtYXBHZW5lcmF0b3IuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJpdG1hcERhdGFcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9iYXNlL0JpdG1hcERhdGFcIik7XG5pbXBvcnQgTWF0cml4XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL01hdHJpeFwiKTtcbmltcG9ydCBSZWN0YW5nbGVcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL1JlY3RhbmdsZVwiKTtcblxuLyoqXG4gKiBNaXBtYXBHZW5lcmF0b3IgaXMgYSBoZWxwZXIgY2xhc3MgdGhhdCB1cGxvYWRzIEJpdG1hcERhdGEgdG8gYSBUZXh0dXJlIGluY2x1ZGluZyBtaXBtYXAgbGV2ZWxzLlxuICovXG5jbGFzcyBNaXBtYXBHZW5lcmF0b3Jcbntcblx0cHJpdmF0ZSBzdGF0aWMgX21pcE1hcHMgPSBbXTtcblx0cHJpdmF0ZSBzdGF0aWMgX21pcE1hcFVzZXMgPSBbXTtcblxuXHRwcml2YXRlIHN0YXRpYyBfbWF0cml4Ok1hdHJpeCA9IG5ldyBNYXRyaXgoKTtcblx0cHJpdmF0ZSBzdGF0aWMgX3JlY3Q6UmVjdGFuZ2xlID0gbmV3IFJlY3RhbmdsZSgpO1xuXHRwcml2YXRlIHN0YXRpYyBfc291cmNlOkJpdG1hcERhdGE7XG5cblx0LyoqXG5cdCAqIFVwbG9hZHMgYSBCaXRtYXBEYXRhIHdpdGggbWlwIG1hcHMgdG8gYSB0YXJnZXQgVGV4dHVyZSBvYmplY3QuXG5cdCAqIEBwYXJhbSBzb3VyY2UgVGhlIHNvdXJjZSB0byB1cGxvYWQuXG5cdCAqIEBwYXJhbSB0YXJnZXQgVGhlIHRhcmdldCBUZXh0dXJlIHRvIHVwbG9hZCB0by5cblx0ICogQHBhcmFtIG1pcG1hcCBBbiBvcHRpb25hbCBtaXAgbWFwIGhvbGRlciB0byBhdm9pZHMgY3JlYXRpbmcgbmV3IGluc3RhbmNlcyBmb3IgZmUgYW5pbWF0ZWQgbWF0ZXJpYWxzLlxuXHQgKiBAcGFyYW0gYWxwaGEgSW5kaWNhdGUgd2hldGhlciBvciBub3QgdGhlIHVwbG9hZGVkIGJpdG1hcERhdGEgaXMgdHJhbnNwYXJlbnQuXG5cdCAqL1xuXHRwdWJsaWMgc3RhdGljIGdlbmVyYXRlTWlwTWFwcyhzb3VyY2U6SFRNTEltYWdlRWxlbWVudCwgb3V0cHV0PzpBcnJheTxCaXRtYXBEYXRhPiwgYWxwaGE/OmJvb2xlYW4pO1xuXHRwdWJsaWMgc3RhdGljIGdlbmVyYXRlTWlwTWFwcyhzb3VyY2U6Qml0bWFwRGF0YSwgb3V0cHV0PzpBcnJheTxCaXRtYXBEYXRhPiwgYWxwaGE/OmJvb2xlYW4pO1xuXHRwdWJsaWMgc3RhdGljIGdlbmVyYXRlTWlwTWFwcyhzb3VyY2U6YW55LCBvdXRwdXQ/OkFycmF5PEJpdG1hcERhdGE+LCBhbHBoYTpib29sZWFuID0gZmFsc2UpXG5cdHtcblx0XHR2YXIgdzpudW1iZXIgPSBzb3VyY2Uud2lkdGg7XG5cdFx0dmFyIGg6bnVtYmVyID0gc291cmNlLmhlaWdodDtcblx0XHR2YXIgaTpudW1iZXIgPSAwO1xuXG5cdFx0dmFyIG1pcG1hcDpCaXRtYXBEYXRhO1xuXG5cdFx0TWlwbWFwR2VuZXJhdG9yLl9yZWN0LndpZHRoID0gdztcblx0XHRNaXBtYXBHZW5lcmF0b3IuX3JlY3QuaGVpZ2h0ID0gaDtcblxuXHRcdHdoaWxlICh3ID49IDEgJiYgaCA+PSAxKSB7XG5cblx0XHRcdG1pcG1hcCA9IG91dHB1dFtpXSA9IE1pcG1hcEdlbmVyYXRvci5fZ2V0TWlwbWFwSG9sZGVyKG91dHB1dFtpXSwgdywgaCk7XG5cblx0XHRcdGlmIChhbHBoYSlcblx0XHRcdFx0bWlwbWFwLmZpbGxSZWN0KE1pcG1hcEdlbmVyYXRvci5fcmVjdCwgMCk7XG5cblx0XHRcdE1pcG1hcEdlbmVyYXRvci5fbWF0cml4LmEgPSBNaXBtYXBHZW5lcmF0b3IuX3JlY3Qud2lkdGgvc291cmNlLndpZHRoO1xuXHRcdFx0TWlwbWFwR2VuZXJhdG9yLl9tYXRyaXguZCA9IE1pcG1hcEdlbmVyYXRvci5fcmVjdC5oZWlnaHQvc291cmNlLmhlaWdodDtcblxuXHRcdFx0bWlwbWFwLmRyYXcoc291cmNlLCBNaXBtYXBHZW5lcmF0b3IuX21hdHJpeCk7IC8vVE9ETzogc21vb3RoaW5nP1xuXG5cdFx0XHR3ID4+PSAxO1xuXHRcdFx0aCA+Pj0gMTtcblxuXHRcdFx0TWlwbWFwR2VuZXJhdG9yLl9yZWN0LndpZHRoID0gdyA+IDE/IHcgOiAxO1xuXHRcdFx0TWlwbWFwR2VuZXJhdG9yLl9yZWN0LmhlaWdodCA9IGggPiAxPyBoIDogMTtcblxuXHRcdFx0aSsrO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgc3RhdGljIF9nZXRNaXBtYXBIb2xkZXIobWlwTWFwSG9sZGVyOkJpdG1hcERhdGEsIG5ld1c6bnVtYmVyLCBuZXdIOm51bWJlcik6Qml0bWFwRGF0YVxuXHR7XG5cdFx0aWYgKG1pcE1hcEhvbGRlcikge1xuXHRcdFx0aWYgKG1pcE1hcEhvbGRlci53aWR0aCA9PSBuZXdXICYmIG1pcE1hcEhvbGRlci5oZWlnaHQgPT0gbmV3SClcblx0XHRcdFx0cmV0dXJuIG1pcE1hcEhvbGRlcjtcblxuXHRcdFx0TWlwbWFwR2VuZXJhdG9yLmZyZWVNaXBNYXBIb2xkZXIobWlwTWFwSG9sZGVyKTtcblx0XHR9XG5cblx0XHRpZiAoIU1pcG1hcEdlbmVyYXRvci5fbWlwTWFwc1tuZXdXXSkge1xuXHRcdFx0TWlwbWFwR2VuZXJhdG9yLl9taXBNYXBzW25ld1ddID0gW107XG5cdFx0XHRNaXBtYXBHZW5lcmF0b3IuX21pcE1hcFVzZXNbbmV3V10gPSBbXTtcblx0XHR9XG5cblx0XHRpZiAoIU1pcG1hcEdlbmVyYXRvci5fbWlwTWFwc1tuZXdXXVtuZXdIXSkge1xuXHRcdFx0bWlwTWFwSG9sZGVyID0gTWlwbWFwR2VuZXJhdG9yLl9taXBNYXBzW25ld1ddW25ld0hdID0gbmV3IEJpdG1hcERhdGEobmV3VywgbmV3SCwgdHJ1ZSk7XG5cdFx0XHRNaXBtYXBHZW5lcmF0b3IuX21pcE1hcFVzZXNbbmV3V11bbmV3SF0gPSAxO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRNaXBtYXBHZW5lcmF0b3IuX21pcE1hcFVzZXNbbmV3V11bbmV3SF0gPSBNaXBtYXBHZW5lcmF0b3IuX21pcE1hcFVzZXNbbmV3V11bbmV3SF0gKyAxO1xuXHRcdFx0bWlwTWFwSG9sZGVyID0gTWlwbWFwR2VuZXJhdG9yLl9taXBNYXBzW25ld1ddW25ld0hdO1xuXHRcdH1cblxuXHRcdHJldHVybiBtaXBNYXBIb2xkZXI7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGZyZWVNaXBNYXBIb2xkZXIobWlwTWFwSG9sZGVyOkJpdG1hcERhdGEpXG5cdHtcblx0XHR2YXIgaG9sZGVyV2lkdGg6bnVtYmVyID0gbWlwTWFwSG9sZGVyLndpZHRoO1xuXHRcdHZhciBob2xkZXJIZWlnaHQ6bnVtYmVyID0gbWlwTWFwSG9sZGVyLmhlaWdodDtcblxuXHRcdGlmICgtLU1pcG1hcEdlbmVyYXRvci5fbWlwTWFwVXNlc1tob2xkZXJXaWR0aF1baG9sZGVySGVpZ2h0XSA9PSAwKSB7XG5cdFx0XHRNaXBtYXBHZW5lcmF0b3IuX21pcE1hcHNbaG9sZGVyV2lkdGhdW2hvbGRlckhlaWdodF0uZGlzcG9zZSgpO1xuXHRcdFx0TWlwbWFwR2VuZXJhdG9yLl9taXBNYXBzW2hvbGRlcldpZHRoXVtob2xkZXJIZWlnaHRdID0gbnVsbDtcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0ID0gTWlwbWFwR2VuZXJhdG9yOyJdfQ==