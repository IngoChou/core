var Vector3D = require("awayjs-core/lib/core/geom/Vector3D");

var AwayMouseEvent = require("awayjs-core/lib/events/MouseEvent");

/**
* MouseManager enforces a singleton pattern and is not intended to be instanced.
* it provides a manager class for detecting mouse hits on scene objects and sending out mouse events.
*/
var MouseManager = (function () {
    /**
    * Creates a new <code>MouseManager</code> object.
    */
    function MouseManager() {
        var _this = this;
        this._viewLookup = new Array();
        this._nullVector = new Vector3D();
        this._queuedEvents = new Array();
        this._mouseUp = new AwayMouseEvent(AwayMouseEvent.MOUSE_UP);
        this._mouseClick = new AwayMouseEvent(AwayMouseEvent.CLICK);
        this._mouseOut = new AwayMouseEvent(AwayMouseEvent.MOUSE_OUT);
        this._mouseDown = new AwayMouseEvent(AwayMouseEvent.MOUSE_DOWN);
        this._mouseMove = new AwayMouseEvent(AwayMouseEvent.MOUSE_MOVE);
        this._mouseOver = new AwayMouseEvent(AwayMouseEvent.MOUSE_OVER);
        this._mouseWheel = new AwayMouseEvent(AwayMouseEvent.MOUSE_WHEEL);
        this._mouseDoubleClick = new AwayMouseEvent(AwayMouseEvent.DOUBLE_CLICK);
        this.onClickDelegate = function (event) {
            return _this.onClick(event);
        };
        this.onDoubleClickDelegate = function (event) {
            return _this.onDoubleClick(event);
        };
        this.onMouseDownDelegate = function (event) {
            return _this.onMouseDown(event);
        };
        this.onMouseMoveDelegate = function (event) {
            return _this.onMouseMove(event);
        };
        this.onMouseUpDelegate = function (event) {
            return _this.onMouseUp(event);
        };
        this.onMouseWheelDelegate = function (event) {
            return _this.onMouseWheel(event);
        };
        this.onMouseOverDelegate = function (event) {
            return _this.onMouseOver(event);
        };
        this.onMouseOutDelegate = function (event) {
            return _this.onMouseOut(event);
        };
    }
    MouseManager.getInstance = function () {
        if (this._instance)
            return this._instance;

        return (this._instance = new MouseManager());
    };

    MouseManager.prototype.fireMouseEvents = function (forceMouseMove) {
        // If colliding object has changed, queue over/out events.
        if (this._iCollidingObject != this._previousCollidingObject) {
            if (this._previousCollidingObject)
                this.queueDispatch(this._mouseOut, this._mouseMoveEvent, this._previousCollidingObject);

            if (this._iCollidingObject)
                this.queueDispatch(this._mouseOver, this._mouseMoveEvent);
        }

        // Fire mouse move events here if forceMouseMove is on.
        if (forceMouseMove && this._iCollidingObject)
            this.queueDispatch(this._mouseMove, this._mouseMoveEvent);

        var event;
        var dispatcher;

        // Dispatch all queued events.
        var len = this._queuedEvents.length;
        for (var i = 0; i < len; ++i) {
            // Only dispatch from first implicitly enabled object ( one that is not a child of a mouseChildren = false hierarchy ).
            event = this._queuedEvents[i];
            dispatcher = event.object;

            while (dispatcher && !dispatcher._iIsMouseEnabled())
                dispatcher = dispatcher.parent;

            if (dispatcher)
                dispatcher.dispatchEvent(event);
        }

        this._queuedEvents.length = 0;

        this._previousCollidingObject = this._iCollidingObject;

        this._iUpdateDirty = false;
    };

    //		public addViewLayer(view:View)
    //		{
    //			var stg:Stage = view.stage;
    //
    //			// Add instance to mouse3dmanager to fire mouse events for multiple views
    //			if (!view.stageGL.mouse3DManager)
    //				view.stageGL.mouse3DManager = this;
    //
    //			if (!hasKey(view))
    //				_view3Ds[view] = 0;
    //
    //			_childDepth = 0;
    //			traverseDisplayObjects(stg);
    //			_viewCount = _childDepth;
    //		}
    MouseManager.prototype.registerView = function (view) {
        view.htmlElement.addEventListener("click", this.onClickDelegate);
        view.htmlElement.addEventListener("dblclick", this.onDoubleClickDelegate);
        view.htmlElement.addEventListener("mousedown", this.onMouseDownDelegate);
        view.htmlElement.addEventListener("mousemove", this.onMouseMoveDelegate);
        view.htmlElement.addEventListener("mouseup", this.onMouseUpDelegate);
        view.htmlElement.addEventListener("mousewheel", this.onMouseWheelDelegate);
        view.htmlElement.addEventListener("mouseover", this.onMouseOverDelegate);
        view.htmlElement.addEventListener("mouseout", this.onMouseOutDelegate);

        this._viewLookup.push(view);
    };

    MouseManager.prototype.unregisterView = function (view) {
        view.htmlElement.removeEventListener("click", this.onClickDelegate);
        view.htmlElement.removeEventListener("dblclick", this.onDoubleClickDelegate);
        view.htmlElement.removeEventListener("mousedown", this.onMouseDownDelegate);
        view.htmlElement.removeEventListener("mousemove", this.onMouseMoveDelegate);
        view.htmlElement.removeEventListener("mouseup", this.onMouseUpDelegate);
        view.htmlElement.removeEventListener("mousewheel", this.onMouseWheelDelegate);
        view.htmlElement.removeEventListener("mouseover", this.onMouseOverDelegate);
        view.htmlElement.removeEventListener("mouseout", this.onMouseOutDelegate);

        this._viewLookup.slice(this._viewLookup.indexOf(view), 1);
    };

    // ---------------------------------------------------------------------
    // Private.
    // ---------------------------------------------------------------------
    MouseManager.prototype.queueDispatch = function (event, sourceEvent, collider) {
        if (typeof collider === "undefined") { collider = null; }
        // 2D properties.
        if (sourceEvent) {
            event.ctrlKey = sourceEvent.ctrlKey;
            event.altKey = sourceEvent.altKey;
            event.shiftKey = sourceEvent.shiftKey;
            event.screenX = sourceEvent.clientX;
            event.screenY = sourceEvent.clientY;
        }

        if (collider == null)
            collider = this._iCollidingObject;

        // 3D properties.
        if (collider) {
            // Object.
            event.object = collider.displayObject;
            event.materialOwner = collider.materialOwner;

            // UV.
            event.uv = collider.uv;

            // Position.
            event.localPosition = collider.localPosition ? collider.localPosition.clone() : null;

            // Normal.
            event.localNormal = collider.localNormal ? collider.localNormal.clone() : null;

            // Face index.
            event.index = collider.index;
        } else {
            // Set all to null.
            event.uv = null;
            event.object = null;
            event.localPosition = this._nullVector;
            event.localNormal = this._nullVector;
            event.index = 0;
            event.subGeometryIndex = 0;
        }

        // Store event to be dispatched later.
        this._queuedEvents.push(event);
    };

    // ---------------------------------------------------------------------
    // Listeners.
    // ---------------------------------------------------------------------
    MouseManager.prototype.onMouseMove = function (event) {
        this.updateColliders(event);

        if (this._iCollidingObject)
            this.queueDispatch(this._mouseMove, this._mouseMoveEvent = event);
    };

    MouseManager.prototype.onMouseOut = function (event) {
        this._iActiveDiv = null;

        this.updateColliders(event);

        if (this._iCollidingObject)
            this.queueDispatch(this._mouseOut, event);
    };

    MouseManager.prototype.onMouseOver = function (event) {
        this._iActiveDiv = event.target;

        this.updateColliders(event);

        if (this._iCollidingObject)
            this.queueDispatch(this._mouseOver, event);
    };

    MouseManager.prototype.onClick = function (event) {
        this.updateColliders(event);

        if (this._iCollidingObject)
            this.queueDispatch(this._mouseClick, event);
    };

    MouseManager.prototype.onDoubleClick = function (event) {
        this.updateColliders(event);

        if (this._iCollidingObject)
            this.queueDispatch(this._mouseDoubleClick, event);
    };

    MouseManager.prototype.onMouseDown = function (event) {
        this._iActiveDiv = event.target;

        this.updateColliders(event);

        if (this._iCollidingObject)
            this.queueDispatch(this._mouseDown, event);
    };

    MouseManager.prototype.onMouseUp = function (event) {
        this.updateColliders(event);

        if (this._iCollidingObject)
            this.queueDispatch(this._mouseUp, event);
    };

    MouseManager.prototype.onMouseWheel = function (event) {
        this.updateColliders(event);

        if (this._iCollidingObject)
            this.queueDispatch(this._mouseWheel, event);
    };

    MouseManager.prototype.updateColliders = function (event) {
        if (this._iUpdateDirty)
            return;

        var view;
        var bounds;
        var mouseX = event.clientX;
        var mouseY = event.clientY;
        var len = this._viewLookup.length;
        for (var i = 0; i < len; i++) {
            view = this._viewLookup[i];
            bounds = view.htmlElement.getBoundingClientRect();
            if (mouseX < bounds.left || mouseX > bounds.right || mouseY < bounds.top || mouseY > bounds.bottom) {
                view._pMouseX = null;
                view._pMouseY = null;
            } else {
                view._pMouseX = mouseX + bounds.left;
                view._pMouseY = mouseY + bounds.top;
                view.updateCollider();

                if (view.layeredView && this._iCollidingObject)
                    break;
            }
        }

        this._iUpdateDirty = true;
    };
    return MouseManager;
})();

module.exports = MouseManager;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hbmFnZXJzL01vdXNlTWFuYWdlci50cyJdLCJuYW1lcyI6WyJNb3VzZU1hbmFnZXIiLCJNb3VzZU1hbmFnZXIuY29uc3RydWN0b3IiLCJNb3VzZU1hbmFnZXIuZ2V0SW5zdGFuY2UiLCJNb3VzZU1hbmFnZXIuZmlyZU1vdXNlRXZlbnRzIiwiTW91c2VNYW5hZ2VyLnJlZ2lzdGVyVmlldyIsIk1vdXNlTWFuYWdlci51bnJlZ2lzdGVyVmlldyIsIk1vdXNlTWFuYWdlci5xdWV1ZURpc3BhdGNoIiwiTW91c2VNYW5hZ2VyLm9uTW91c2VNb3ZlIiwiTW91c2VNYW5hZ2VyLm9uTW91c2VPdXQiLCJNb3VzZU1hbmFnZXIub25Nb3VzZU92ZXIiLCJNb3VzZU1hbmFnZXIub25DbGljayIsIk1vdXNlTWFuYWdlci5vbkRvdWJsZUNsaWNrIiwiTW91c2VNYW5hZ2VyLm9uTW91c2VEb3duIiwiTW91c2VNYW5hZ2VyLm9uTW91c2VVcCIsIk1vdXNlTWFuYWdlci5vbk1vdXNlV2hlZWwiLCJNb3VzZU1hbmFnZXIudXBkYXRlQ29sbGlkZXJzIl0sIm1hcHBpbmdzIjoiQUFBQSw0REFFcUU7O0FBRXJFLGlFQUF3RTs7QUFFeEU7OztFQUdHO0FBQ0g7SUFxQ0NBOztNQURHQTtJQUNIQTtRQUFBQyxpQkFVQ0E7UUEzQ0RBLEtBQVFBLFdBQVdBLEdBQWVBLElBQUlBLEtBQUtBLENBQU9BLENBQUNBLENBQUNBO1FBTXBEQSxLQUFRQSxXQUFXQSxHQUFZQSxJQUFJQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUU5Q0EsS0FBUUEsYUFBYUEsR0FBeUJBLElBQUlBLEtBQUtBLENBQWlCQSxDQUFDQSxDQUFDQTtRQUkxRUEsS0FBUUEsUUFBUUEsR0FBa0JBLElBQUlBLGNBQWNBLENBQUNBLGNBQWNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO1FBQzlFQSxLQUFRQSxXQUFXQSxHQUFrQkEsSUFBSUEsY0FBY0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDOUVBLEtBQVFBLFNBQVNBLEdBQWtCQSxJQUFJQSxjQUFjQSxDQUFDQSxjQUFjQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQTtRQUNoRkEsS0FBUUEsVUFBVUEsR0FBa0JBLElBQUlBLGNBQWNBLENBQUNBLGNBQWNBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO1FBQ2xGQSxLQUFRQSxVQUFVQSxHQUFrQkEsSUFBSUEsY0FBY0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0E7UUFDbEZBLEtBQVFBLFVBQVVBLEdBQWtCQSxJQUFJQSxjQUFjQSxDQUFDQSxjQUFjQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUNsRkEsS0FBUUEsV0FBV0EsR0FBa0JBLElBQUlBLGNBQWNBLENBQUNBLGNBQWNBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO1FBQ3BGQSxLQUFRQSxpQkFBaUJBLEdBQWtCQSxJQUFJQSxjQUFjQSxDQUFDQSxjQUFjQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtRQWdCMUZBLElBQUlBLENBQUNBLGVBQWVBLEdBQUdBLFVBQUNBLEtBQWdCQTttQkFBS0EsS0FBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0E7UUFBbkJBLENBQW1CQTtRQUNoRUEsSUFBSUEsQ0FBQ0EscUJBQXFCQSxHQUFHQSxVQUFDQSxLQUFnQkE7bUJBQUtBLEtBQUlBLENBQUNBLGFBQWFBLENBQUNBLEtBQUtBLENBQUNBO1FBQXpCQSxDQUF5QkE7UUFDNUVBLElBQUlBLENBQUNBLG1CQUFtQkEsR0FBR0EsVUFBQ0EsS0FBZ0JBO21CQUFLQSxLQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUF2QkEsQ0FBdUJBO1FBQ3hFQSxJQUFJQSxDQUFDQSxtQkFBbUJBLEdBQUdBLFVBQUNBLEtBQWdCQTttQkFBS0EsS0FBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsS0FBS0EsQ0FBQ0E7UUFBdkJBLENBQXVCQTtRQUN4RUEsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxHQUFHQSxVQUFDQSxLQUFnQkE7bUJBQUtBLEtBQUlBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLENBQUNBO1FBQXJCQSxDQUFxQkE7UUFDcEVBLElBQUlBLENBQUNBLG9CQUFvQkEsR0FBR0EsVUFBQ0EsS0FBZ0JBO21CQUFLQSxLQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUF4QkEsQ0FBd0JBO1FBQzFFQSxJQUFJQSxDQUFDQSxtQkFBbUJBLEdBQUdBLFVBQUNBLEtBQWdCQTttQkFBS0EsS0FBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsS0FBS0EsQ0FBQ0E7UUFBdkJBLENBQXVCQTtRQUN4RUEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxVQUFDQSxLQUFnQkE7bUJBQUtBLEtBQUlBLENBQUNBLFVBQVVBLENBQUNBLEtBQUtBLENBQUNBO1FBQXRCQSxDQUFzQkE7SUFDdkVBLENBQUNBO0lBRURELDJCQUFBQTtRQUVDRSxJQUFJQSxJQUFJQSxDQUFDQSxTQUFTQTtZQUNqQkEsT0FBT0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0E7O1FBRXZCQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxHQUFHQSxJQUFJQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUM3Q0EsQ0FBQ0E7O0lBRURGLHlDQUFBQSxVQUF1QkEsY0FBc0JBO1FBRTNDRywwREFBMERBO1FBQzNEQSxJQUFJQSxJQUFJQSxDQUFDQSxpQkFBaUJBLElBQUlBLElBQUlBLENBQUNBLHdCQUF3QkEsQ0FBRUE7WUFDNURBLElBQUlBLElBQUlBLENBQUNBLHdCQUF3QkE7Z0JBQ2hDQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxFQUFFQSxJQUFJQSxDQUFDQSxlQUFlQSxFQUFFQSxJQUFJQSxDQUFDQSx3QkFBd0JBLENBQUNBLENBQUNBOztZQUV6RkEsSUFBSUEsSUFBSUEsQ0FBQ0EsaUJBQWlCQTtnQkFDekJBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBO1NBQzNEQTs7UUFFQUEsdURBQXVEQTtRQUN4REEsSUFBSUEsY0FBY0EsSUFBSUEsSUFBSUEsQ0FBQ0EsaUJBQWlCQTtZQUMzQ0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBRUEsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsQ0FBQ0E7O1FBRTVEQSxJQUFJQSxLQUFLQTtRQUNUQSxJQUFJQSxVQUFVQTs7UUFFYkEsOEJBQThCQTtRQUMvQkEsSUFBSUEsR0FBR0EsR0FBVUEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsTUFBTUE7UUFDMUNBLEtBQUtBLElBQUlBLENBQUNBLEdBQVVBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLEdBQUdBLEVBQUVBLEVBQUVBLENBQUNBLENBQUVBO1lBQ3BDQSx1SEFBdUhBO1lBQ3ZIQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM3QkEsVUFBVUEsR0FBR0EsS0FBS0EsQ0FBQ0EsTUFBTUE7O1lBRXpCQSxPQUFPQSxVQUFVQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBO2dCQUNsREEsVUFBVUEsR0FBR0EsVUFBVUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7O1lBRWhDQSxJQUFJQSxVQUFVQTtnQkFDYkEsVUFBVUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7U0FDakNBOztRQUVEQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQTs7UUFFN0JBLElBQUlBLENBQUNBLHdCQUF3QkEsR0FBR0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQTs7UUFFdERBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLEtBQUtBO0lBQzNCQSxDQUFDQTs7SUFrQkRILGtDQWhCaUNBO0lBQ2xDQSxLQUFLQTtJQUNMQSxnQ0FBZ0NBO0lBQ2hDQSxFQUFFQTtJQUNGQSw4RUFBOEVBO0lBQzlFQSxzQ0FBc0NBO0lBQ3RDQSx5Q0FBeUNBO0lBQ3pDQSxFQUFFQTtJQUNGQSx1QkFBdUJBO0lBQ3ZCQSx5QkFBeUJBO0lBQ3pCQSxFQUFFQTtJQUNGQSxxQkFBcUJBO0lBQ3JCQSxpQ0FBaUNBO0lBQ2pDQSw4QkFBOEJBO0lBQzlCQSxLQUFLQTswQ0FFSkEsVUFBb0JBLElBQVNBO1FBRTVCSSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxnQkFBZ0JBLENBQUNBLE9BQU9BLEVBQUVBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBO1FBQ2hFQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxnQkFBZ0JBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLENBQUNBLHFCQUFxQkEsQ0FBQ0E7UUFDekVBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsV0FBV0EsRUFBRUEsSUFBSUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQTtRQUN4RUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxXQUFXQSxFQUFFQSxJQUFJQSxDQUFDQSxtQkFBbUJBLENBQUNBO1FBQ3hFQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxnQkFBZ0JBLENBQUNBLFNBQVNBLEVBQUVBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0E7UUFDcEVBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsWUFBWUEsRUFBRUEsSUFBSUEsQ0FBQ0Esb0JBQW9CQSxDQUFDQTtRQUMxRUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxXQUFXQSxFQUFFQSxJQUFJQSxDQUFDQSxtQkFBbUJBLENBQUNBO1FBQ3hFQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxnQkFBZ0JBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0E7O1FBRXRFQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQTtJQUM1QkEsQ0FBQ0E7O0lBRURKLHdDQUFBQSxVQUFzQkEsSUFBU0E7UUFFOUJLLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0E7UUFDbkVBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsVUFBVUEsRUFBRUEsSUFBSUEsQ0FBQ0EscUJBQXFCQSxDQUFDQTtRQUM1RUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxXQUFXQSxFQUFFQSxJQUFJQSxDQUFDQSxtQkFBbUJBLENBQUNBO1FBQzNFQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxtQkFBbUJBLENBQUNBLFdBQVdBLEVBQUVBLElBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0E7UUFDM0VBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsU0FBU0EsRUFBRUEsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQTtRQUN2RUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxZQUFZQSxFQUFFQSxJQUFJQSxDQUFDQSxvQkFBb0JBLENBQUNBO1FBQzdFQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxtQkFBbUJBLENBQUNBLFdBQVdBLEVBQUVBLElBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0E7UUFDM0VBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsVUFBVUEsRUFBRUEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQTs7UUFFekVBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBO0lBQzFEQSxDQUFDQTs7SUFNREwsd0VBSndFQTtJQUN4RUEsV0FBV0E7SUFDWEEsd0VBQXdFQTsyQ0FFeEVBLFVBQXNCQSxLQUFvQkEsRUFBRUEsV0FBc0JBLEVBQUVBLFFBQWtDQTtRQUFsQ00sdUNBQUFBLFFBQVFBLEdBQXNCQSxJQUFJQTtBQUFBQSxRQUVyR0EsaUJBQWlCQTtRQUNqQkEsSUFBSUEsV0FBV0EsQ0FBRUE7WUFDaEJBLEtBQUtBLENBQUNBLE9BQU9BLEdBQUdBLFdBQVdBLENBQUNBLE9BQU9BO1lBQ25DQSxLQUFLQSxDQUFDQSxNQUFNQSxHQUFHQSxXQUFXQSxDQUFDQSxNQUFNQTtZQUNqQ0EsS0FBS0EsQ0FBQ0EsUUFBUUEsR0FBR0EsV0FBV0EsQ0FBQ0EsUUFBUUE7WUFDckNBLEtBQUtBLENBQUNBLE9BQU9BLEdBQUdBLFdBQVdBLENBQUNBLE9BQU9BO1lBQ25DQSxLQUFLQSxDQUFDQSxPQUFPQSxHQUFHQSxXQUFXQSxDQUFDQSxPQUFPQTtTQUNuQ0E7O1FBRURBLElBQUlBLFFBQVFBLElBQUlBLElBQUlBO1lBQ25CQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBOztRQUVuQ0EsaUJBQWlCQTtRQUNqQkEsSUFBSUEsUUFBUUEsQ0FBRUE7WUFDYkEsVUFBVUE7WUFDVkEsS0FBS0EsQ0FBQ0EsTUFBTUEsR0FBR0EsUUFBUUEsQ0FBQ0EsYUFBYUE7WUFDckNBLEtBQUtBLENBQUNBLGFBQWFBLEdBQUdBLFFBQVFBLENBQUNBLGFBQWFBOztZQUM1Q0EsTUFBTUE7WUFDTkEsS0FBS0EsQ0FBQ0EsRUFBRUEsR0FBR0EsUUFBUUEsQ0FBQ0EsRUFBRUE7O1lBQ3RCQSxZQUFZQTtZQUNaQSxLQUFLQSxDQUFDQSxhQUFhQSxHQUFHQSxRQUFRQSxDQUFDQSxhQUFhQSxHQUFFQSxRQUFRQSxDQUFDQSxhQUFhQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQTs7WUFDbkZBLFVBQVVBO1lBQ1ZBLEtBQUtBLENBQUNBLFdBQVdBLEdBQUdBLFFBQVFBLENBQUNBLFdBQVdBLEdBQUVBLFFBQVFBLENBQUNBLFdBQVdBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBOztZQUM3RUEsY0FBY0E7WUFDZEEsS0FBS0EsQ0FBQ0EsS0FBS0EsR0FBR0EsUUFBUUEsQ0FBQ0EsS0FBS0E7U0FDNUJBLEtBQU1BO1lBQ05BLG1CQUFtQkE7WUFDbkJBLEtBQUtBLENBQUNBLEVBQUVBLEdBQUdBLElBQUlBO1lBQ2ZBLEtBQUtBLENBQUNBLE1BQU1BLEdBQUdBLElBQUlBO1lBQ25CQSxLQUFLQSxDQUFDQSxhQUFhQSxHQUFHQSxJQUFJQSxDQUFDQSxXQUFXQTtZQUN0Q0EsS0FBS0EsQ0FBQ0EsV0FBV0EsR0FBR0EsSUFBSUEsQ0FBQ0EsV0FBV0E7WUFDcENBLEtBQUtBLENBQUNBLEtBQUtBLEdBQUdBLENBQUNBO1lBQ2ZBLEtBQUtBLENBQUNBLGdCQUFnQkEsR0FBR0EsQ0FBQ0E7U0FDMUJBOztRQUVEQSxzQ0FBc0NBO1FBQ3RDQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQTtJQUMvQkEsQ0FBQ0E7O0lBTUROLHdFQUp3RUE7SUFDeEVBLGFBQWFBO0lBQ2JBLHdFQUF3RUE7eUNBRXhFQSxVQUFvQkEsS0FBZ0JBO1FBRW5DTyxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxLQUFLQSxDQUFDQTs7UUFFM0JBLElBQUlBLElBQUlBLENBQUNBLGlCQUFpQkE7WUFDekJBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLENBQUNBLGVBQWVBLEdBQUdBLEtBQUtBLENBQUNBLENBQUNBO0lBQ3BFQSxDQUFDQTs7SUFFRFAsb0NBQUFBLFVBQW1CQSxLQUFnQkE7UUFFbENRLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBOztRQUV2QkEsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7O1FBRTNCQSxJQUFJQSxJQUFJQSxDQUFDQSxpQkFBaUJBO1lBQ3pCQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtJQUM1Q0EsQ0FBQ0E7O0lBRURSLHFDQUFBQSxVQUFvQkEsS0FBZ0JBO1FBRW5DUyxJQUFJQSxDQUFDQSxXQUFXQSxHQUFvQkEsS0FBS0EsQ0FBQ0EsTUFBTUE7O1FBRWhEQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxLQUFLQSxDQUFDQTs7UUFFM0JBLElBQUlBLElBQUlBLENBQUNBLGlCQUFpQkE7WUFDekJBLElBQUlBLENBQUNBLGFBQWFBLENBQUVBLElBQUlBLENBQUNBLFVBQVVBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO0lBQzlDQSxDQUFDQTs7SUFFRFQsaUNBQUFBLFVBQWdCQSxLQUFnQkE7UUFFL0JVLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLEtBQUtBLENBQUNBOztRQUUzQkEsSUFBSUEsSUFBSUEsQ0FBQ0EsaUJBQWlCQTtZQUN6QkEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7SUFDOUNBLENBQUNBOztJQUVEVix1Q0FBQUEsVUFBc0JBLEtBQWdCQTtRQUVyQ1csSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7O1FBRTNCQSxJQUFJQSxJQUFJQSxDQUFDQSxpQkFBaUJBO1lBQ3pCQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxpQkFBaUJBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO0lBQ3BEQSxDQUFDQTs7SUFFRFgscUNBQUFBLFVBQW9CQSxLQUFnQkE7UUFFbkNZLElBQUlBLENBQUNBLFdBQVdBLEdBQW9CQSxLQUFLQSxDQUFDQSxNQUFNQTs7UUFFaERBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLEtBQUtBLENBQUNBOztRQUUzQkEsSUFBSUEsSUFBSUEsQ0FBQ0EsaUJBQWlCQTtZQUN6QkEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7SUFDN0NBLENBQUNBOztJQUVEWixtQ0FBQUEsVUFBa0JBLEtBQWdCQTtRQUVqQ2EsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7O1FBRTNCQSxJQUFJQSxJQUFJQSxDQUFDQSxpQkFBaUJBO1lBQ3pCQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxFQUFHQSxLQUFLQSxDQUFDQSxDQUFDQTtJQUM1Q0EsQ0FBQ0E7O0lBRURiLHNDQUFBQSxVQUFxQkEsS0FBZ0JBO1FBRXBDYyxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxLQUFLQSxDQUFDQTs7UUFFM0JBLElBQUlBLElBQUlBLENBQUNBLGlCQUFpQkE7WUFDekJBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO0lBQzlDQSxDQUFDQTs7SUFHRGQseUNBQUFBLFVBQXdCQSxLQUFnQkE7UUFFdkNlLElBQUlBLElBQUlBLENBQUNBLGFBQWFBO1lBQ3JCQSxNQUFPQSxDQUFBQTs7UUFFUkEsSUFBSUEsSUFBSUE7UUFDUkEsSUFBSUEsTUFBTUE7UUFDVkEsSUFBSUEsTUFBTUEsR0FBVUEsS0FBS0EsQ0FBQ0EsT0FBT0E7UUFDakNBLElBQUlBLE1BQU1BLEdBQVVBLEtBQUtBLENBQUNBLE9BQU9BO1FBQ2pDQSxJQUFJQSxHQUFHQSxHQUFVQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxNQUFNQTtRQUN4Q0EsS0FBS0EsSUFBSUEsQ0FBQ0EsR0FBVUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsR0FBR0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBRUE7WUFDcENBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1lBQzFCQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxxQkFBcUJBLENBQUNBLENBQUNBO1lBQ2pEQSxJQUFJQSxNQUFNQSxHQUFHQSxNQUFNQSxDQUFDQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxNQUFNQSxDQUFDQSxLQUFLQSxJQUFJQSxNQUFNQSxHQUFHQSxNQUFNQSxDQUFDQSxHQUFHQSxJQUFJQSxNQUFNQSxHQUFHQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFFQTtnQkFDbkdBLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBLElBQUlBO2dCQUNwQkEsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsSUFBSUE7YUFDcEJBLEtBQU1BO2dCQUNOQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFHQSxNQUFNQSxHQUFHQSxNQUFNQSxDQUFDQSxJQUFJQTtnQkFDcENBLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBLE1BQU1BLEdBQUdBLE1BQU1BLENBQUNBLEdBQUdBO2dCQUNuQ0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0E7O2dCQUVyQkEsSUFBSUEsSUFBSUEsQ0FBQ0EsV0FBV0EsSUFBSUEsSUFBSUEsQ0FBQ0EsaUJBQWlCQTtvQkFDN0NBLEtBQU1BLENBQUFBO2FBQ1BBO1NBQ0RBOztRQUVEQSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxJQUFJQTtJQUMxQkEsQ0FBQ0E7SUFDRmYsb0JBQUNBO0FBQURBLENBQUNBLElBQUE7O0FBRUQsNkJBQXNCLENBQUEiLCJmaWxlIjoibWFuYWdlcnMvTW91c2VNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9yb2JiYXRlbWFuL1dlYnN0b3JtUHJvamVjdHMvYXdheWpzLWNvcmUvIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFZpZXdcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb250YWluZXJzL1ZpZXdcIik7XG5pbXBvcnQgRGlzcGxheU9iamVjdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvYmFzZS9EaXNwbGF5T2JqZWN0XCIpO1xuaW1wb3J0IFZlY3RvcjNEXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvZ2VvbS9WZWN0b3IzRFwiKTtcbmltcG9ydCBQaWNraW5nQ29sbGlzaW9uVk9cdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9waWNrL1BpY2tpbmdDb2xsaXNpb25WT1wiKTtcbmltcG9ydCBBd2F5TW91c2VFdmVudFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2V2ZW50cy9Nb3VzZUV2ZW50XCIpO1xuXG4vKipcbiAqIE1vdXNlTWFuYWdlciBlbmZvcmNlcyBhIHNpbmdsZXRvbiBwYXR0ZXJuIGFuZCBpcyBub3QgaW50ZW5kZWQgdG8gYmUgaW5zdGFuY2VkLlxuICogaXQgcHJvdmlkZXMgYSBtYW5hZ2VyIGNsYXNzIGZvciBkZXRlY3RpbmcgbW91c2UgaGl0cyBvbiBzY2VuZSBvYmplY3RzIGFuZCBzZW5kaW5nIG91dCBtb3VzZSBldmVudHMuXG4gKi9cbmNsYXNzIE1vdXNlTWFuYWdlclxue1xuXHRwcml2YXRlIHN0YXRpYyBfaW5zdGFuY2U6TW91c2VNYW5hZ2VyO1xuXG5cdHByaXZhdGUgX3ZpZXdMb29rdXA6QXJyYXk8Vmlldz4gPSBuZXcgQXJyYXk8Vmlldz4oKTtcblxuXHRwdWJsaWMgX2lBY3RpdmVEaXY6SFRNTERpdkVsZW1lbnQ7XG5cdHB1YmxpYyBfaVVwZGF0ZURpcnR5OmJvb2xlYW47XG5cdHB1YmxpYyBfaUNvbGxpZGluZ09iamVjdDpQaWNraW5nQ29sbGlzaW9uVk87XG5cdFxuXHRwcml2YXRlIF9udWxsVmVjdG9yOlZlY3RvcjNEID0gbmV3IFZlY3RvcjNEKCk7XG5cdHByaXZhdGUgX3ByZXZpb3VzQ29sbGlkaW5nT2JqZWN0OlBpY2tpbmdDb2xsaXNpb25WTztcblx0cHJpdmF0ZSBfcXVldWVkRXZlbnRzOkFycmF5PEF3YXlNb3VzZUV2ZW50PiA9IG5ldyBBcnJheTxBd2F5TW91c2VFdmVudD4oKTtcblxuXHRwcml2YXRlIF9tb3VzZU1vdmVFdmVudDpNb3VzZUV2ZW50O1xuXG5cdHByaXZhdGUgX21vdXNlVXA6QXdheU1vdXNlRXZlbnQgPSBuZXcgQXdheU1vdXNlRXZlbnQoQXdheU1vdXNlRXZlbnQuTU9VU0VfVVApO1xuXHRwcml2YXRlIF9tb3VzZUNsaWNrOkF3YXlNb3VzZUV2ZW50ID0gbmV3IEF3YXlNb3VzZUV2ZW50KEF3YXlNb3VzZUV2ZW50LkNMSUNLKTtcblx0cHJpdmF0ZSBfbW91c2VPdXQ6QXdheU1vdXNlRXZlbnQgPSBuZXcgQXdheU1vdXNlRXZlbnQoQXdheU1vdXNlRXZlbnQuTU9VU0VfT1VUKTtcblx0cHJpdmF0ZSBfbW91c2VEb3duOkF3YXlNb3VzZUV2ZW50ID0gbmV3IEF3YXlNb3VzZUV2ZW50KEF3YXlNb3VzZUV2ZW50Lk1PVVNFX0RPV04pO1xuXHRwcml2YXRlIF9tb3VzZU1vdmU6QXdheU1vdXNlRXZlbnQgPSBuZXcgQXdheU1vdXNlRXZlbnQoQXdheU1vdXNlRXZlbnQuTU9VU0VfTU9WRSk7XG5cdHByaXZhdGUgX21vdXNlT3ZlcjpBd2F5TW91c2VFdmVudCA9IG5ldyBBd2F5TW91c2VFdmVudChBd2F5TW91c2VFdmVudC5NT1VTRV9PVkVSKTtcblx0cHJpdmF0ZSBfbW91c2VXaGVlbDpBd2F5TW91c2VFdmVudCA9IG5ldyBBd2F5TW91c2VFdmVudChBd2F5TW91c2VFdmVudC5NT1VTRV9XSEVFTCk7XG5cdHByaXZhdGUgX21vdXNlRG91YmxlQ2xpY2s6QXdheU1vdXNlRXZlbnQgPSBuZXcgQXdheU1vdXNlRXZlbnQoQXdheU1vdXNlRXZlbnQuRE9VQkxFX0NMSUNLKTtcblxuXHRwcml2YXRlIG9uQ2xpY2tEZWxlZ2F0ZTooZXZlbnQ6TW91c2VFdmVudCkgPT4gdm9pZDtcblx0cHJpdmF0ZSBvbkRvdWJsZUNsaWNrRGVsZWdhdGU6KGV2ZW50Ok1vdXNlRXZlbnQpID0+IHZvaWQ7XG5cdHByaXZhdGUgb25Nb3VzZURvd25EZWxlZ2F0ZTooZXZlbnQ6TW91c2VFdmVudCkgPT4gdm9pZDtcblx0cHJpdmF0ZSBvbk1vdXNlTW92ZURlbGVnYXRlOihldmVudDpNb3VzZUV2ZW50KSA9PiB2b2lkO1xuXHRwcml2YXRlIG9uTW91c2VVcERlbGVnYXRlOihldmVudDpNb3VzZUV2ZW50KSA9PiB2b2lkO1xuXHRwcml2YXRlIG9uTW91c2VXaGVlbERlbGVnYXRlOihldmVudDpNb3VzZUV2ZW50KSA9PiB2b2lkO1xuXHRwcml2YXRlIG9uTW91c2VPdmVyRGVsZWdhdGU6KGV2ZW50Ok1vdXNlRXZlbnQpID0+IHZvaWQ7XG5cdHByaXZhdGUgb25Nb3VzZU91dERlbGVnYXRlOihldmVudDpNb3VzZUV2ZW50KSA9PiB2b2lkO1xuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIGEgbmV3IDxjb2RlPk1vdXNlTWFuYWdlcjwvY29kZT4gb2JqZWN0LlxuXHQgKi9cblx0Y29uc3RydWN0b3IoKVxuXHR7XG5cdFx0dGhpcy5vbkNsaWNrRGVsZWdhdGUgPSAoZXZlbnQ6TW91c2VFdmVudCkgPT4gdGhpcy5vbkNsaWNrKGV2ZW50KTtcblx0XHR0aGlzLm9uRG91YmxlQ2xpY2tEZWxlZ2F0ZSA9IChldmVudDpNb3VzZUV2ZW50KSA9PiB0aGlzLm9uRG91YmxlQ2xpY2soZXZlbnQpO1xuXHRcdHRoaXMub25Nb3VzZURvd25EZWxlZ2F0ZSA9IChldmVudDpNb3VzZUV2ZW50KSA9PiB0aGlzLm9uTW91c2VEb3duKGV2ZW50KTtcblx0XHR0aGlzLm9uTW91c2VNb3ZlRGVsZWdhdGUgPSAoZXZlbnQ6TW91c2VFdmVudCkgPT4gdGhpcy5vbk1vdXNlTW92ZShldmVudCk7XG5cdFx0dGhpcy5vbk1vdXNlVXBEZWxlZ2F0ZSA9IChldmVudDpNb3VzZUV2ZW50KSA9PiB0aGlzLm9uTW91c2VVcChldmVudCk7XG5cdFx0dGhpcy5vbk1vdXNlV2hlZWxEZWxlZ2F0ZSA9IChldmVudDpNb3VzZUV2ZW50KSA9PiB0aGlzLm9uTW91c2VXaGVlbChldmVudCk7XG5cdFx0dGhpcy5vbk1vdXNlT3ZlckRlbGVnYXRlID0gKGV2ZW50Ok1vdXNlRXZlbnQpID0+IHRoaXMub25Nb3VzZU92ZXIoZXZlbnQpO1xuXHRcdHRoaXMub25Nb3VzZU91dERlbGVnYXRlID0gKGV2ZW50Ok1vdXNlRXZlbnQpID0+IHRoaXMub25Nb3VzZU91dChldmVudCk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGdldEluc3RhbmNlKCk6TW91c2VNYW5hZ2VyXG5cdHtcblx0XHRpZiAodGhpcy5faW5zdGFuY2UpXG5cdFx0XHRyZXR1cm4gdGhpcy5faW5zdGFuY2U7XG5cblx0XHRyZXR1cm4gKHRoaXMuX2luc3RhbmNlID0gbmV3IE1vdXNlTWFuYWdlcigpKTtcblx0fVxuXG5cdHB1YmxpYyBmaXJlTW91c2VFdmVudHMoZm9yY2VNb3VzZU1vdmU6Ym9vbGVhbilcblx0e1xuXHRcdCAvLyBJZiBjb2xsaWRpbmcgb2JqZWN0IGhhcyBjaGFuZ2VkLCBxdWV1ZSBvdmVyL291dCBldmVudHMuXG5cdFx0aWYgKHRoaXMuX2lDb2xsaWRpbmdPYmplY3QgIT0gdGhpcy5fcHJldmlvdXNDb2xsaWRpbmdPYmplY3QpIHtcblx0XHRcdGlmICh0aGlzLl9wcmV2aW91c0NvbGxpZGluZ09iamVjdClcblx0XHRcdFx0dGhpcy5xdWV1ZURpc3BhdGNoKHRoaXMuX21vdXNlT3V0LCB0aGlzLl9tb3VzZU1vdmVFdmVudCwgdGhpcy5fcHJldmlvdXNDb2xsaWRpbmdPYmplY3QpO1xuXG5cdFx0XHRpZiAodGhpcy5faUNvbGxpZGluZ09iamVjdClcblx0XHRcdFx0dGhpcy5xdWV1ZURpc3BhdGNoKHRoaXMuX21vdXNlT3ZlciwgdGhpcy5fbW91c2VNb3ZlRXZlbnQpO1xuXHRcdH1cblxuXHRcdCAvLyBGaXJlIG1vdXNlIG1vdmUgZXZlbnRzIGhlcmUgaWYgZm9yY2VNb3VzZU1vdmUgaXMgb24uXG5cdFx0aWYgKGZvcmNlTW91c2VNb3ZlICYmIHRoaXMuX2lDb2xsaWRpbmdPYmplY3QpXG5cdFx0XHR0aGlzLnF1ZXVlRGlzcGF0Y2goIHRoaXMuX21vdXNlTW92ZSwgdGhpcy5fbW91c2VNb3ZlRXZlbnQpO1xuXG5cdFx0dmFyIGV2ZW50OkF3YXlNb3VzZUV2ZW50O1xuXHRcdHZhciBkaXNwYXRjaGVyOkRpc3BsYXlPYmplY3Q7XG5cblx0XHQgLy8gRGlzcGF0Y2ggYWxsIHF1ZXVlZCBldmVudHMuXG5cdFx0dmFyIGxlbjpudW1iZXIgPSB0aGlzLl9xdWV1ZWRFdmVudHMubGVuZ3RoO1xuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IGxlbjsgKytpKSB7XG5cdFx0XHQvLyBPbmx5IGRpc3BhdGNoIGZyb20gZmlyc3QgaW1wbGljaXRseSBlbmFibGVkIG9iamVjdCAoIG9uZSB0aGF0IGlzIG5vdCBhIGNoaWxkIG9mIGEgbW91c2VDaGlsZHJlbiA9IGZhbHNlIGhpZXJhcmNoeSApLlxuXHRcdFx0ZXZlbnQgPSB0aGlzLl9xdWV1ZWRFdmVudHNbaV07XG5cdFx0XHRkaXNwYXRjaGVyID0gZXZlbnQub2JqZWN0O1xuXG5cdFx0XHR3aGlsZSAoZGlzcGF0Y2hlciAmJiAhZGlzcGF0Y2hlci5faUlzTW91c2VFbmFibGVkKCkpXG5cdFx0XHRcdGRpc3BhdGNoZXIgPSBkaXNwYXRjaGVyLnBhcmVudDtcblxuXHRcdFx0aWYgKGRpc3BhdGNoZXIpXG5cdFx0XHRcdGRpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChldmVudCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fcXVldWVkRXZlbnRzLmxlbmd0aCA9IDA7XG5cblx0XHR0aGlzLl9wcmV2aW91c0NvbGxpZGluZ09iamVjdCA9IHRoaXMuX2lDb2xsaWRpbmdPYmplY3Q7XG5cblx0XHR0aGlzLl9pVXBkYXRlRGlydHkgPSBmYWxzZTtcblx0fVxuXG4vL1x0XHRwdWJsaWMgYWRkVmlld0xheWVyKHZpZXc6Vmlldylcbi8vXHRcdHtcbi8vXHRcdFx0dmFyIHN0ZzpTdGFnZSA9IHZpZXcuc3RhZ2U7XG4vL1xuLy9cdFx0XHQvLyBBZGQgaW5zdGFuY2UgdG8gbW91c2UzZG1hbmFnZXIgdG8gZmlyZSBtb3VzZSBldmVudHMgZm9yIG11bHRpcGxlIHZpZXdzXG4vL1x0XHRcdGlmICghdmlldy5zdGFnZUdMLm1vdXNlM0RNYW5hZ2VyKVxuLy9cdFx0XHRcdHZpZXcuc3RhZ2VHTC5tb3VzZTNETWFuYWdlciA9IHRoaXM7XG4vL1xuLy9cdFx0XHRpZiAoIWhhc0tleSh2aWV3KSlcbi8vXHRcdFx0XHRfdmlldzNEc1t2aWV3XSA9IDA7XG4vL1xuLy9cdFx0XHRfY2hpbGREZXB0aCA9IDA7XG4vL1x0XHRcdHRyYXZlcnNlRGlzcGxheU9iamVjdHMoc3RnKTtcbi8vXHRcdFx0X3ZpZXdDb3VudCA9IF9jaGlsZERlcHRoO1xuLy9cdFx0fVxuXG5cdHB1YmxpYyByZWdpc3RlclZpZXcodmlldzpWaWV3KVxuXHR7XG5cdFx0dmlldy5odG1sRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgdGhpcy5vbkNsaWNrRGVsZWdhdGUpO1xuXHRcdHZpZXcuaHRtbEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImRibGNsaWNrXCIsIHRoaXMub25Eb3VibGVDbGlja0RlbGVnYXRlKTtcblx0XHR2aWV3Lmh0bWxFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgdGhpcy5vbk1vdXNlRG93bkRlbGVnYXRlKTtcblx0XHR2aWV3Lmh0bWxFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZW1vdmVcIiwgdGhpcy5vbk1vdXNlTW92ZURlbGVnYXRlKTtcblx0XHR2aWV3Lmh0bWxFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZXVwXCIsIHRoaXMub25Nb3VzZVVwRGVsZWdhdGUpO1xuXHRcdHZpZXcuaHRtbEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNld2hlZWxcIiwgdGhpcy5vbk1vdXNlV2hlZWxEZWxlZ2F0ZSk7XG5cdFx0dmlldy5odG1sRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwibW91c2VvdmVyXCIsIHRoaXMub25Nb3VzZU92ZXJEZWxlZ2F0ZSk7XG5cdFx0dmlldy5odG1sRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwibW91c2VvdXRcIiwgdGhpcy5vbk1vdXNlT3V0RGVsZWdhdGUpO1xuXG5cdFx0dGhpcy5fdmlld0xvb2t1cC5wdXNoKHZpZXcpO1xuXHR9XG5cblx0cHVibGljIHVucmVnaXN0ZXJWaWV3KHZpZXc6Vmlldylcblx0e1xuXHRcdHZpZXcuaHRtbEVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHRoaXMub25DbGlja0RlbGVnYXRlKTtcblx0XHR2aWV3Lmh0bWxFbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJkYmxjbGlja1wiLCB0aGlzLm9uRG91YmxlQ2xpY2tEZWxlZ2F0ZSk7XG5cdFx0dmlldy5odG1sRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2Vkb3duXCIsIHRoaXMub25Nb3VzZURvd25EZWxlZ2F0ZSk7XG5cdFx0dmlldy5odG1sRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIHRoaXMub25Nb3VzZU1vdmVEZWxlZ2F0ZSk7XG5cdFx0dmlldy5odG1sRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLCB0aGlzLm9uTW91c2VVcERlbGVnYXRlKTtcblx0XHR2aWV3Lmh0bWxFbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJtb3VzZXdoZWVsXCIsIHRoaXMub25Nb3VzZVdoZWVsRGVsZWdhdGUpO1xuXHRcdHZpZXcuaHRtbEVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1vdXNlb3ZlclwiLCB0aGlzLm9uTW91c2VPdmVyRGVsZWdhdGUpO1xuXHRcdHZpZXcuaHRtbEVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1vdXNlb3V0XCIsIHRoaXMub25Nb3VzZU91dERlbGVnYXRlKTtcblxuXHRcdHRoaXMuX3ZpZXdMb29rdXAuc2xpY2UodGhpcy5fdmlld0xvb2t1cC5pbmRleE9mKHZpZXcpLCAxKTtcblx0fVxuXG5cdC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHQvLyBQcml2YXRlLlxuXHQvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXHRwcml2YXRlIHF1ZXVlRGlzcGF0Y2goZXZlbnQ6QXdheU1vdXNlRXZlbnQsIHNvdXJjZUV2ZW50Ok1vdXNlRXZlbnQsIGNvbGxpZGVyOlBpY2tpbmdDb2xsaXNpb25WTyA9IG51bGwpXG5cdHtcblx0XHQvLyAyRCBwcm9wZXJ0aWVzLlxuXHRcdGlmIChzb3VyY2VFdmVudCkge1xuXHRcdFx0ZXZlbnQuY3RybEtleSA9IHNvdXJjZUV2ZW50LmN0cmxLZXk7XG5cdFx0XHRldmVudC5hbHRLZXkgPSBzb3VyY2VFdmVudC5hbHRLZXk7XG5cdFx0XHRldmVudC5zaGlmdEtleSA9IHNvdXJjZUV2ZW50LnNoaWZ0S2V5O1xuXHRcdFx0ZXZlbnQuc2NyZWVuWCA9IHNvdXJjZUV2ZW50LmNsaWVudFg7XG5cdFx0XHRldmVudC5zY3JlZW5ZID0gc291cmNlRXZlbnQuY2xpZW50WTtcblx0XHR9XG5cblx0XHRpZiAoY29sbGlkZXIgPT0gbnVsbClcblx0XHRcdGNvbGxpZGVyID0gdGhpcy5faUNvbGxpZGluZ09iamVjdDtcblxuXHRcdC8vIDNEIHByb3BlcnRpZXMuXG5cdFx0aWYgKGNvbGxpZGVyKSB7XG5cdFx0XHQvLyBPYmplY3QuXG5cdFx0XHRldmVudC5vYmplY3QgPSBjb2xsaWRlci5kaXNwbGF5T2JqZWN0O1xuXHRcdFx0ZXZlbnQubWF0ZXJpYWxPd25lciA9IGNvbGxpZGVyLm1hdGVyaWFsT3duZXI7XG5cdFx0XHQvLyBVVi5cblx0XHRcdGV2ZW50LnV2ID0gY29sbGlkZXIudXY7XG5cdFx0XHQvLyBQb3NpdGlvbi5cblx0XHRcdGV2ZW50LmxvY2FsUG9zaXRpb24gPSBjb2xsaWRlci5sb2NhbFBvc2l0aW9uPyBjb2xsaWRlci5sb2NhbFBvc2l0aW9uLmNsb25lKCkgOiBudWxsO1xuXHRcdFx0Ly8gTm9ybWFsLlxuXHRcdFx0ZXZlbnQubG9jYWxOb3JtYWwgPSBjb2xsaWRlci5sb2NhbE5vcm1hbD8gY29sbGlkZXIubG9jYWxOb3JtYWwuY2xvbmUoKSA6IG51bGw7XG5cdFx0XHQvLyBGYWNlIGluZGV4LlxuXHRcdFx0ZXZlbnQuaW5kZXggPSBjb2xsaWRlci5pbmRleDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Ly8gU2V0IGFsbCB0byBudWxsLlxuXHRcdFx0ZXZlbnQudXYgPSBudWxsO1xuXHRcdFx0ZXZlbnQub2JqZWN0ID0gbnVsbDtcblx0XHRcdGV2ZW50LmxvY2FsUG9zaXRpb24gPSB0aGlzLl9udWxsVmVjdG9yO1xuXHRcdFx0ZXZlbnQubG9jYWxOb3JtYWwgPSB0aGlzLl9udWxsVmVjdG9yO1xuXHRcdFx0ZXZlbnQuaW5kZXggPSAwO1xuXHRcdFx0ZXZlbnQuc3ViR2VvbWV0cnlJbmRleCA9IDA7XG5cdFx0fVxuXG5cdFx0Ly8gU3RvcmUgZXZlbnQgdG8gYmUgZGlzcGF0Y2hlZCBsYXRlci5cblx0XHR0aGlzLl9xdWV1ZWRFdmVudHMucHVzaChldmVudCk7XG5cdH1cblxuXHQvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0Ly8gTGlzdGVuZXJzLlxuXHQvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXHRwcml2YXRlIG9uTW91c2VNb3ZlKGV2ZW50Ok1vdXNlRXZlbnQpXG5cdHtcblx0XHR0aGlzLnVwZGF0ZUNvbGxpZGVycyhldmVudCk7XG5cblx0XHRpZiAodGhpcy5faUNvbGxpZGluZ09iamVjdClcblx0XHRcdHRoaXMucXVldWVEaXNwYXRjaCh0aGlzLl9tb3VzZU1vdmUsIHRoaXMuX21vdXNlTW92ZUV2ZW50ID0gZXZlbnQpO1xuXHR9XG5cblx0cHJpdmF0ZSBvbk1vdXNlT3V0KGV2ZW50Ok1vdXNlRXZlbnQpXG5cdHtcblx0XHR0aGlzLl9pQWN0aXZlRGl2ID0gbnVsbDtcblxuXHRcdHRoaXMudXBkYXRlQ29sbGlkZXJzKGV2ZW50KTtcblxuXHRcdGlmICh0aGlzLl9pQ29sbGlkaW5nT2JqZWN0KVxuXHRcdFx0dGhpcy5xdWV1ZURpc3BhdGNoKHRoaXMuX21vdXNlT3V0LCBldmVudCk7XG5cdH1cblxuXHRwcml2YXRlIG9uTW91c2VPdmVyKGV2ZW50Ok1vdXNlRXZlbnQpXG5cdHtcblx0XHR0aGlzLl9pQWN0aXZlRGl2ID0gPEhUTUxEaXZFbGVtZW50PiBldmVudC50YXJnZXQ7XG5cblx0XHR0aGlzLnVwZGF0ZUNvbGxpZGVycyhldmVudCk7XG5cblx0XHRpZiAodGhpcy5faUNvbGxpZGluZ09iamVjdClcblx0XHRcdHRoaXMucXVldWVEaXNwYXRjaCggdGhpcy5fbW91c2VPdmVyLCBldmVudCk7XG5cdH1cblxuXHRwcml2YXRlIG9uQ2xpY2soZXZlbnQ6TW91c2VFdmVudClcblx0e1xuXHRcdHRoaXMudXBkYXRlQ29sbGlkZXJzKGV2ZW50KTtcblxuXHRcdGlmICh0aGlzLl9pQ29sbGlkaW5nT2JqZWN0KVxuXHRcdFx0dGhpcy5xdWV1ZURpc3BhdGNoKHRoaXMuX21vdXNlQ2xpY2ssIGV2ZW50KTtcblx0fVxuXG5cdHByaXZhdGUgb25Eb3VibGVDbGljayhldmVudDpNb3VzZUV2ZW50KVxuXHR7XG5cdFx0dGhpcy51cGRhdGVDb2xsaWRlcnMoZXZlbnQpO1xuXG5cdFx0aWYgKHRoaXMuX2lDb2xsaWRpbmdPYmplY3QpXG5cdFx0XHR0aGlzLnF1ZXVlRGlzcGF0Y2godGhpcy5fbW91c2VEb3VibGVDbGljaywgZXZlbnQpO1xuXHR9XG5cblx0cHJpdmF0ZSBvbk1vdXNlRG93bihldmVudDpNb3VzZUV2ZW50KVxuXHR7XG5cdFx0dGhpcy5faUFjdGl2ZURpdiA9IDxIVE1MRGl2RWxlbWVudD4gZXZlbnQudGFyZ2V0O1xuXG5cdFx0dGhpcy51cGRhdGVDb2xsaWRlcnMoZXZlbnQpO1xuXG5cdFx0aWYgKHRoaXMuX2lDb2xsaWRpbmdPYmplY3QpXG5cdFx0XHR0aGlzLnF1ZXVlRGlzcGF0Y2godGhpcy5fbW91c2VEb3duLCBldmVudCk7XG5cdH1cblxuXHRwcml2YXRlIG9uTW91c2VVcChldmVudDpNb3VzZUV2ZW50KVxuXHR7XG5cdFx0dGhpcy51cGRhdGVDb2xsaWRlcnMoZXZlbnQpO1xuXG5cdFx0aWYgKHRoaXMuX2lDb2xsaWRpbmdPYmplY3QpXG5cdFx0XHR0aGlzLnF1ZXVlRGlzcGF0Y2godGhpcy5fbW91c2VVcCAsIGV2ZW50KTtcblx0fVxuXG5cdHByaXZhdGUgb25Nb3VzZVdoZWVsKGV2ZW50Ok1vdXNlRXZlbnQpXG5cdHtcblx0XHR0aGlzLnVwZGF0ZUNvbGxpZGVycyhldmVudCk7XG5cblx0XHRpZiAodGhpcy5faUNvbGxpZGluZ09iamVjdClcblx0XHRcdHRoaXMucXVldWVEaXNwYXRjaCh0aGlzLl9tb3VzZVdoZWVsLCBldmVudCk7XG5cdH1cblxuXG5cdHByaXZhdGUgdXBkYXRlQ29sbGlkZXJzKGV2ZW50Ok1vdXNlRXZlbnQpXG5cdHtcblx0XHRpZiAodGhpcy5faVVwZGF0ZURpcnR5KVxuXHRcdFx0cmV0dXJuO1xuXG5cdFx0dmFyIHZpZXc6Vmlldztcblx0XHR2YXIgYm91bmRzOkNsaWVudFJlY3Q7XG5cdFx0dmFyIG1vdXNlWDpudW1iZXIgPSBldmVudC5jbGllbnRYO1xuXHRcdHZhciBtb3VzZVk6bnVtYmVyID0gZXZlbnQuY2xpZW50WTtcblx0XHR2YXIgbGVuOm51bWJlciA9IHRoaXMuX3ZpZXdMb29rdXAubGVuZ3RoO1xuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0XHR2aWV3ID0gdGhpcy5fdmlld0xvb2t1cFtpXTtcblx0XHRcdGJvdW5kcyA9IHZpZXcuaHRtbEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cdFx0XHRpZiAobW91c2VYIDwgYm91bmRzLmxlZnQgfHwgbW91c2VYID4gYm91bmRzLnJpZ2h0IHx8IG1vdXNlWSA8IGJvdW5kcy50b3AgfHwgbW91c2VZID4gYm91bmRzLmJvdHRvbSkge1xuXHRcdFx0XHR2aWV3Ll9wTW91c2VYID0gbnVsbDtcblx0XHRcdFx0dmlldy5fcE1vdXNlWSA9IG51bGw7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR2aWV3Ll9wTW91c2VYID0gbW91c2VYICsgYm91bmRzLmxlZnQ7XG5cdFx0XHRcdHZpZXcuX3BNb3VzZVkgPSBtb3VzZVkgKyBib3VuZHMudG9wO1xuXHRcdFx0XHR2aWV3LnVwZGF0ZUNvbGxpZGVyKCk7XG5cblx0XHRcdFx0aWYgKHZpZXcubGF5ZXJlZFZpZXcgJiYgdGhpcy5faUNvbGxpZGluZ09iamVjdClcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdH1cblx0XHR9XG5cblx0XHR0aGlzLl9pVXBkYXRlRGlydHkgPSB0cnVlO1xuXHR9XG59XG5cbmV4cG9ydCA9IE1vdXNlTWFuYWdlcjsiXX0=