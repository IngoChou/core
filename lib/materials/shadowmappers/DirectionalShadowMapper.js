var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3D = require("awayjs-core/lib/core/geom/Matrix3D");

var Camera = require("awayjs-core/lib/entities/Camera");

var ShadowMapperBase = require("awayjs-core/lib/materials/shadowmappers/ShadowMapperBase");
var FreeMatrixProjection = require("awayjs-core/lib/projections/FreeMatrixProjection");

var DirectionalShadowMapper = (function (_super) {
    __extends(DirectionalShadowMapper, _super);
    function DirectionalShadowMapper() {
        _super.call(this);
        this._pLightOffset = 10000;
        this._pSnap = 64;

        this._pCullPlanes = [];
        this._pOverallDepthProjection = new FreeMatrixProjection();
        this._pOverallDepthCamera = new Camera(this._pOverallDepthProjection);
        this._pLocalFrustum = [];
        this._pMatrix = new Matrix3D();
    }
    Object.defineProperty(DirectionalShadowMapper.prototype, "snap", {
        get: function () {
            return this._pSnap;
        },
        set: function (value) {
            this._pSnap = value;
        },
        enumerable: true,
        configurable: true
    });


    Object.defineProperty(DirectionalShadowMapper.prototype, "lightOffset", {
        get: function () {
            return this._pLightOffset;
        },
        set: function (value) {
            this._pLightOffset = value;
        },
        enumerable: true,
        configurable: true
    });


    Object.defineProperty(DirectionalShadowMapper.prototype, "iDepthProjection", {
        //@arcane
        get: function () {
            return this._pOverallDepthCamera.viewProjection;
        },
        enumerable: true,
        configurable: true
    });

    Object.defineProperty(DirectionalShadowMapper.prototype, "depth", {
        //@arcane
        get: function () {
            return this._pMaxZ - this._pMinZ;
        },
        enumerable: true,
        configurable: true
    });

    //@override
    DirectionalShadowMapper.prototype.pDrawDepthMap = function (target, scene, renderer) {
        this._pCasterCollector.camera = this._pOverallDepthCamera;
        this._pCasterCollector.cullPlanes = this._pCullPlanes;
        this._pCasterCollector.clear();
        scene.traversePartitions(this._pCasterCollector);
        renderer._iRender(this._pCasterCollector, target);
    };

    //@protected
    DirectionalShadowMapper.prototype.pUpdateCullPlanes = function (viewCamera) {
        var lightFrustumPlanes = this._pOverallDepthCamera.frustumPlanes;
        var viewFrustumPlanes = viewCamera.frustumPlanes;
        this._pCullPlanes.length = 4;

        this._pCullPlanes[0] = lightFrustumPlanes[0];
        this._pCullPlanes[1] = lightFrustumPlanes[1];
        this._pCullPlanes[2] = lightFrustumPlanes[2];
        this._pCullPlanes[3] = lightFrustumPlanes[3];

        var light = this._pLight;
        var dir = light.sceneDirection;
        var dirX = dir.x;
        var dirY = dir.y;
        var dirZ = dir.z;
        var j = 4;
        for (var i = 0; i < 6; ++i) {
            var plane = viewFrustumPlanes[i];
            if (plane.a * dirX + plane.b * dirY + plane.c * dirZ < 0)
                this._pCullPlanes[j++] = plane;
        }
    };

    //@override
    DirectionalShadowMapper.prototype.pUpdateDepthProjection = function (viewCamera) {
        this.pUpdateProjectionFromFrustumCorners(viewCamera, viewCamera.projection.frustumCorners, this._pMatrix);
        this._pOverallDepthProjection.matrix = this._pMatrix;
        this.pUpdateCullPlanes(viewCamera);
    };

    DirectionalShadowMapper.prototype.pUpdateProjectionFromFrustumCorners = function (viewCamera, corners, matrix) {
        var raw = new Array();
        var dir;
        var x, y, z;
        var minX, minY;
        var maxX, maxY;
        var i;

        var light = this._pLight;
        dir = light.sceneDirection;
        this._pOverallDepthCamera.transform.matrix3D = this._pLight.sceneTransform;
        x = Math.floor((viewCamera.x - dir.x * this._pLightOffset) / this._pSnap) * this._pSnap;
        y = Math.floor((viewCamera.y - dir.y * this._pLightOffset) / this._pSnap) * this._pSnap;
        z = Math.floor((viewCamera.z - dir.z * this._pLightOffset) / this._pSnap) * this._pSnap;
        this._pOverallDepthCamera.x = x;
        this._pOverallDepthCamera.y = y;
        this._pOverallDepthCamera.z = z;

        this._pMatrix.copyFrom(this._pOverallDepthCamera.inverseSceneTransform);
        this._pMatrix.prepend(viewCamera.sceneTransform);
        this._pMatrix.transformVectors(corners, this._pLocalFrustum);

        minX = maxX = this._pLocalFrustum[0];
        minY = maxY = this._pLocalFrustum[1];
        this._pMaxZ = this._pLocalFrustum[2];

        i = 3;
        while (i < 24) {
            x = this._pLocalFrustum[i];
            y = this._pLocalFrustum[i + 1];
            z = this._pLocalFrustum[i + 2];
            if (x < minX)
                minX = x;
            if (x > maxX)
                maxX = x;
            if (y < minY)
                minY = y;
            if (y > maxY)
                maxY = y;
            if (z > this._pMaxZ)
                this._pMaxZ = z;
            i += 3;
        }

        this._pMinZ = 1;

        var w = maxX - minX;
        var h = maxY - minY;
        var d = 1 / (this._pMaxZ - this._pMinZ);

        if (minX < 0)
            minX -= this._pSnap; // because int() rounds up for < 0

        if (minY < 0)
            minY -= this._pSnap;

        minX = Math.floor(minX / this._pSnap) * this._pSnap;
        minY = Math.floor(minY / this._pSnap) * this._pSnap;

        var snap2 = 2 * this._pSnap;
        w = Math.floor(w / snap2 + 2) * snap2;
        h = Math.floor(h / snap2 + 2) * snap2;

        maxX = minX + w;
        maxY = minY + h;

        w = 1 / w;
        h = 1 / h;

        raw[0] = 2 * w;
        raw[5] = 2 * h;
        raw[10] = d;
        raw[12] = -(maxX + minX) * w;
        raw[13] = -(maxY + minY) * h;
        raw[14] = -this._pMinZ * d;
        raw[15] = 1;
        raw[1] = raw[2] = raw[3] = raw[4] = raw[6] = raw[7] = raw[8] = raw[9] = raw[11] = 0;

        matrix.copyRawDataFrom(raw);
    };
    return DirectionalShadowMapper;
})(ShadowMapperBase);

module.exports = DirectionalShadowMapper;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hdGVyaWFscy9zaGFkb3dtYXBwZXJzL0RpcmVjdGlvbmFsU2hhZG93TWFwcGVyLnRzIl0sIm5hbWVzIjpbIkRpcmVjdGlvbmFsU2hhZG93TWFwcGVyIiwiRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIuY29uc3RydWN0b3IiLCJEaXJlY3Rpb25hbFNoYWRvd01hcHBlci5wRHJhd0RlcHRoTWFwIiwiRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIucFVwZGF0ZUN1bGxQbGFuZXMiLCJEaXJlY3Rpb25hbFNoYWRvd01hcHBlci5wVXBkYXRlRGVwdGhQcm9qZWN0aW9uIiwiRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIucFVwZGF0ZVByb2plY3Rpb25Gcm9tRnJ1c3R1bUNvcm5lcnMiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDREQUNxRTs7QUFJckUsdURBQWdFOztBQUVoRSwwRkFBaUc7QUFDakcsc0ZBQTRGOztBQUk1RjtJQUFzQ0EsMENBQWdCQTtJQWNyREE7UUFFQ0MsV0FBTUEsS0FBQUEsQ0FBQ0E7UUFYUkEsS0FBT0EsYUFBYUEsR0FBVUEsS0FBS0EsQ0FBQ0E7UUFHcENBLEtBQU9BLE1BQU1BLEdBQVVBLEVBQUVBLENBQUNBOztRQVV6QkEsSUFBSUEsQ0FBQ0EsWUFBWUEsR0FBR0EsRUFBRUE7UUFDdEJBLElBQUlBLENBQUNBLHdCQUF3QkEsR0FBR0EsSUFBSUEsb0JBQW9CQSxDQUFDQSxDQUFDQTtRQUMxREEsSUFBSUEsQ0FBQ0Esb0JBQW9CQSxHQUFHQSxJQUFJQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSx3QkFBd0JBLENBQUNBO1FBQ3JFQSxJQUFJQSxDQUFDQSxjQUFjQSxHQUFHQSxFQUFFQTtRQUN4QkEsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsSUFBSUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDL0JBLENBQUNBO0lBRUREO1FBQUFBLEtBQUFBO1lBRUNBLE9BQU9BLElBQUlBLENBQUNBLE1BQU1BO1FBQ25CQSxDQUFDQTtRQUVEQSxLQUFBQSxVQUFn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QSxHQUFHQSxDQUFDQTtZQUNYQSxJQUFJQSxJQUFJQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxrQ0FBa0NBO0FBQW5DQTtRQUVyQkEsSUFBSUEsSUFBSUEsR0FBR0EsQ0FBQ0E7WUFDWEEsSUFBSUEsSUFBSUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7O1FBRXJCQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxHQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFDQSxJQUFJQSxDQUFDQSxNQUFNQTtRQUMvQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsR0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUE7O1FBRS9DQSxJQUFJQSxLQUFLQSxHQUFVQSxDQUFDQSxHQUFDQSxJQUFJQSxDQUFDQSxNQUFNQTtRQUNoQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsS0FBS0E7UUFDakNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLEdBQUNBLEtBQUtBLEdBQUdBLENBQUNBLENBQUNBLEdBQUNBLEtBQUtBOztRQUVqQ0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsQ0FBQ0E7UUFDZkEsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsQ0FBQ0E7O1FBRWZBLENBQUNBLEdBQUdBLENBQUNBLEdBQUNBLENBQUNBO1FBQ1BBLENBQUNBLEdBQUdBLENBQUNBLEdBQUNBLENBQUNBOztRQUVQQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFDQSxDQUFDQTtRQUNaQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFDQSxDQUFDQTtRQUNaQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQTtRQUNYQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFDQSxDQUFDQTtRQUMxQkEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBQ0EsQ0FBQ0E7UUFDMUJBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEdBQUNBLENBQUNBO1FBQ3hCQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQTtRQUNYQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQTs7UUFFbkZBLE1BQU1BLENBQUNBLGVBQWVBLENBQUNBLEdBQUdBLENBQUNBO0lBQzVCQSxDQUFDQTtJQUNGTCwrQkFBQ0E7QUFBREEsQ0FBQ0EsRUFyTHFDLGdCQUFnQixFQXFMckQ7O0FBRUQsd0NBQWlDLENBQUEiLCJmaWxlIjoibWF0ZXJpYWxzL3NoYWRvd21hcHBlcnMvRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL3JvYmJhdGVtYW4vV2Vic3Rvcm1Qcm9qZWN0cy9hd2F5anMtY29yZS8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU2NlbmVcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29udGFpbmVycy9TY2VuZVwiKTtcbmltcG9ydCBNYXRyaXgzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2dlb20vTWF0cml4M0RcIik7XG5pbXBvcnQgUGxhbmUzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2dlb20vUGxhbmUzRFwiKTtcbmltcG9ydCBWZWN0b3IzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2dlb20vVmVjdG9yM0RcIik7XG5pbXBvcnQgSVJlbmRlcmVyXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL3JlbmRlci9JUmVuZGVyZXJcIik7XG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcbmltcG9ydCBEaXJlY3Rpb25hbExpZ2h0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZW50aXRpZXMvRGlyZWN0aW9uYWxMaWdodFwiKTtcbmltcG9ydCBTaGFkb3dNYXBwZXJCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvbWF0ZXJpYWxzL3NoYWRvd21hcHBlcnMvU2hhZG93TWFwcGVyQmFzZVwiKTtcbmltcG9ydCBGcmVlTWF0cml4UHJvamVjdGlvblx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9wcm9qZWN0aW9ucy9GcmVlTWF0cml4UHJvamVjdGlvblwiKTtcbmltcG9ydCBSZW5kZXJUZXh0dXJlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvUmVuZGVyVGV4dHVyZVwiKTtcbmltcG9ydCBUZXh0dXJlUHJveHlCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvVGV4dHVyZVByb3h5QmFzZVwiKTtcblxuY2xhc3MgRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIgZXh0ZW5kcyBTaGFkb3dNYXBwZXJCYXNlXG57XG5cdHB1YmxpYyBfcE92ZXJhbGxEZXB0aENhbWVyYTpDYW1lcmE7XG5cdHB1YmxpYyBfcExvY2FsRnJ1c3R1bTpBcnJheTxudW1iZXI+O1xuXG5cdHB1YmxpYyBfcExpZ2h0T2Zmc2V0Om51bWJlciA9IDEwMDAwO1xuXHRwdWJsaWMgX3BNYXRyaXg6TWF0cml4M0Q7XG5cdHB1YmxpYyBfcE92ZXJhbGxEZXB0aFByb2plY3Rpb246RnJlZU1hdHJpeFByb2plY3Rpb247XG5cdHB1YmxpYyBfcFNuYXA6bnVtYmVyID0gNjQ7XG5cblx0cHVibGljIF9wQ3VsbFBsYW5lczpBcnJheTxQbGFuZTNEPjtcblx0cHVibGljIF9wTWluWjpudW1iZXI7XG5cdHB1YmxpYyBfcE1heFo6bnVtYmVyO1xuXG5cdGNvbnN0cnVjdG9yKClcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHR0aGlzLl9wQ3VsbFBsYW5lcyA9IFtdO1xuXHRcdHRoaXMuX3BPdmVyYWxsRGVwdGhQcm9qZWN0aW9uID0gbmV3IEZyZWVNYXRyaXhQcm9qZWN0aW9uKCk7XG5cdFx0dGhpcy5fcE92ZXJhbGxEZXB0aENhbWVyYSA9IG5ldyBDYW1lcmEodGhpcy5fcE92ZXJhbGxEZXB0aFByb2plY3Rpb24pO1xuXHRcdHRoaXMuX3BMb2NhbEZydXN0dW0gPSBbXTtcblx0XHR0aGlzLl9wTWF0cml4ID0gbmV3IE1hdHJpeDNEKCk7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHNuYXAoKTpudW1iZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9wU25hcDtcblx0fVxuXG5cdHB1YmxpYyBzZXQgc25hcCh2YWx1ZTpudW1iZXIpXG5cdHtcblx0XHR0aGlzLl9wU25hcCA9IHZhbHVlO1xuXHR9XG5cblx0cHVibGljIGdldCBsaWdodE9mZnNldCgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3BMaWdodE9mZnNldDtcblx0fVxuXG5cdHB1YmxpYyBzZXQgbGlnaHRPZmZzZXQodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fcExpZ2h0T2Zmc2V0ID0gdmFsdWU7XG5cdH1cblxuXHQvL0BhcmNhbmVcblx0cHVibGljIGdldCBpRGVwdGhQcm9qZWN0aW9uKCk6TWF0cml4M0Rcblx0e1xuXHRcdHJldHVybiB0aGlzLl9wT3ZlcmFsbERlcHRoQ2FtZXJhLnZpZXdQcm9qZWN0aW9uO1xuXHR9XG5cblx0Ly9AYXJjYW5lXG5cdHB1YmxpYyBnZXQgZGVwdGgoKTpudW1iZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9wTWF4WiAtIHRoaXMuX3BNaW5aO1xuXHR9XG5cblx0Ly9Ab3ZlcnJpZGVcblx0cHVibGljIHBEcmF3RGVwdGhNYXAodGFyZ2V0OlRleHR1cmVQcm94eUJhc2UsIHNjZW5lOlNjZW5lLCByZW5kZXJlcjpJUmVuZGVyZXIpXG5cdHtcblx0XHR0aGlzLl9wQ2FzdGVyQ29sbGVjdG9yLmNhbWVyYSA9IHRoaXMuX3BPdmVyYWxsRGVwdGhDYW1lcmE7XG5cdFx0dGhpcy5fcENhc3RlckNvbGxlY3Rvci5jdWxsUGxhbmVzID0gdGhpcy5fcEN1bGxQbGFuZXM7XG5cdFx0dGhpcy5fcENhc3RlckNvbGxlY3Rvci5jbGVhcigpO1xuXHRcdHNjZW5lLnRyYXZlcnNlUGFydGl0aW9ucyh0aGlzLl9wQ2FzdGVyQ29sbGVjdG9yKTtcblx0XHRyZW5kZXJlci5faVJlbmRlcih0aGlzLl9wQ2FzdGVyQ29sbGVjdG9yLCB0YXJnZXQpO1xuXHR9XG5cblx0Ly9AcHJvdGVjdGVkXG5cdHB1YmxpYyBwVXBkYXRlQ3VsbFBsYW5lcyh2aWV3Q2FtZXJhOkNhbWVyYSlcblx0e1xuXHRcdHZhciBsaWdodEZydXN0dW1QbGFuZXM6QXJyYXk8UGxhbmUzRD4gPSB0aGlzLl9wT3ZlcmFsbERlcHRoQ2FtZXJhLmZydXN0dW1QbGFuZXM7XG5cdFx0dmFyIHZpZXdGcnVzdHVtUGxhbmVzOkFycmF5PFBsYW5lM0Q+ID0gdmlld0NhbWVyYS5mcnVzdHVtUGxhbmVzO1xuXHRcdHRoaXMuX3BDdWxsUGxhbmVzLmxlbmd0aCA9IDQ7XG5cblx0XHR0aGlzLl9wQ3VsbFBsYW5lc1swXSA9IGxpZ2h0RnJ1c3R1bVBsYW5lc1swXTtcblx0XHR0aGlzLl9wQ3VsbFBsYW5lc1sxXSA9IGxpZ2h0RnJ1c3R1bVBsYW5lc1sxXTtcblx0XHR0aGlzLl9wQ3VsbFBsYW5lc1syXSA9IGxpZ2h0RnJ1c3R1bVBsYW5lc1syXTtcblx0XHR0aGlzLl9wQ3VsbFBsYW5lc1szXSA9IGxpZ2h0RnJ1c3R1bVBsYW5lc1szXTtcblxuXHRcdHZhciBsaWdodDpEaXJlY3Rpb25hbExpZ2h0ID0gPERpcmVjdGlvbmFsTGlnaHQ+IHRoaXMuX3BMaWdodDtcblx0XHR2YXIgZGlyOlZlY3RvcjNEID0gbGlnaHQuc2NlbmVEaXJlY3Rpb247XG5cdFx0dmFyIGRpclg6bnVtYmVyID0gZGlyLng7XG5cdFx0dmFyIGRpclk6bnVtYmVyID0gZGlyLnk7XG5cdFx0dmFyIGRpclo6bnVtYmVyID0gZGlyLno7XG5cdFx0dmFyIGo6bnVtYmVyID0gNDtcblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCA2OyArK2kpIHtcblx0XHRcdHZhciBwbGFuZTpQbGFuZTNEID0gdmlld0ZydXN0dW1QbGFuZXNbaV07XG5cdFx0XHRpZiAocGxhbmUuYSpkaXJYICsgcGxhbmUuYipkaXJZICsgcGxhbmUuYypkaXJaIDwgMClcblx0XHRcdFx0dGhpcy5fcEN1bGxQbGFuZXNbaisrXSA9IHBsYW5lO1xuXHRcdH1cblx0fVxuXG5cdC8vQG92ZXJyaWRlXG5cdHB1YmxpYyBwVXBkYXRlRGVwdGhQcm9qZWN0aW9uKHZpZXdDYW1lcmE6Q2FtZXJhKVxuXHR7XG5cdFx0dGhpcy5wVXBkYXRlUHJvamVjdGlvbkZyb21GcnVzdHVtQ29ybmVycyh2aWV3Q2FtZXJhLCB2aWV3Q2FtZXJhLnByb2plY3Rpb24uZnJ1c3R1bUNvcm5lcnMsIHRoaXMuX3BNYXRyaXgpO1xuXHRcdHRoaXMuX3BPdmVyYWxsRGVwdGhQcm9qZWN0aW9uLm1hdHJpeCA9IHRoaXMuX3BNYXRyaXg7XG5cdFx0dGhpcy5wVXBkYXRlQ3VsbFBsYW5lcyh2aWV3Q2FtZXJhKTtcblx0fVxuXG5cdHB1YmxpYyBwVXBkYXRlUHJvamVjdGlvbkZyb21GcnVzdHVtQ29ybmVycyh2aWV3Q2FtZXJhOkNhbWVyYSwgY29ybmVyczpBcnJheTxudW1iZXI+LCBtYXRyaXg6TWF0cml4M0QpXG5cdHtcblx0XHR2YXIgcmF3OkFycmF5PG51bWJlcj4gPSBuZXcgQXJyYXk8bnVtYmVyPigpO1xuXHRcdHZhciBkaXI6VmVjdG9yM0Q7XG5cdFx0dmFyIHg6bnVtYmVyLCB5Om51bWJlciwgejpudW1iZXI7XG5cdFx0dmFyIG1pblg6bnVtYmVyLCBtaW5ZOm51bWJlcjtcblx0XHR2YXIgbWF4WDpudW1iZXIsIG1heFk6bnVtYmVyO1xuXHRcdHZhciBpOm51bWJlcjtcblxuXHRcdHZhciBsaWdodDpEaXJlY3Rpb25hbExpZ2h0ID0gPERpcmVjdGlvbmFsTGlnaHQ+IHRoaXMuX3BMaWdodDtcblx0XHRkaXIgPSBsaWdodC5zY2VuZURpcmVjdGlvbjtcblx0XHR0aGlzLl9wT3ZlcmFsbERlcHRoQ2FtZXJhLnRyYW5zZm9ybS5tYXRyaXgzRCA9IHRoaXMuX3BMaWdodC5zY2VuZVRyYW5zZm9ybTtcblx0XHR4ID0gTWF0aC5mbG9vcigodmlld0NhbWVyYS54IC0gZGlyLngqdGhpcy5fcExpZ2h0T2Zmc2V0KS90aGlzLl9wU25hcCkqdGhpcy5fcFNuYXA7XG5cdFx0eSA9IE1hdGguZmxvb3IoKHZpZXdDYW1lcmEueSAtIGRpci55KnRoaXMuX3BMaWdodE9mZnNldCkvdGhpcy5fcFNuYXApKnRoaXMuX3BTbmFwO1xuXHRcdHogPSBNYXRoLmZsb29yKCh2aWV3Q2FtZXJhLnogLSBkaXIueip0aGlzLl9wTGlnaHRPZmZzZXQpL3RoaXMuX3BTbmFwKSp0aGlzLl9wU25hcDtcblx0XHR0aGlzLl9wT3ZlcmFsbERlcHRoQ2FtZXJhLnggPSB4O1xuXHRcdHRoaXMuX3BPdmVyYWxsRGVwdGhDYW1lcmEueSA9IHk7XG5cdFx0dGhpcy5fcE92ZXJhbGxEZXB0aENhbWVyYS56ID0gejtcblxuXHRcdHRoaXMuX3BNYXRyaXguY29weUZyb20odGhpcy5fcE92ZXJhbGxEZXB0aENhbWVyYS5pbnZlcnNlU2NlbmVUcmFuc2Zvcm0pO1xuXHRcdHRoaXMuX3BNYXRyaXgucHJlcGVuZCh2aWV3Q2FtZXJhLnNjZW5lVHJhbnNmb3JtKTtcblx0XHR0aGlzLl9wTWF0cml4LnRyYW5zZm9ybVZlY3RvcnMoY29ybmVycywgdGhpcy5fcExvY2FsRnJ1c3R1bSk7XG5cblx0XHRtaW5YID0gbWF4WCA9IHRoaXMuX3BMb2NhbEZydXN0dW1bMF07XG5cdFx0bWluWSA9IG1heFkgPSB0aGlzLl9wTG9jYWxGcnVzdHVtWzFdO1xuXHRcdHRoaXMuX3BNYXhaID0gdGhpcy5fcExvY2FsRnJ1c3R1bVsyXTtcblxuXHRcdGkgPSAzO1xuXHRcdHdoaWxlIChpIDwgMjQpIHtcblx0XHRcdHggPSB0aGlzLl9wTG9jYWxGcnVzdHVtW2ldO1xuXHRcdFx0eSA9IHRoaXMuX3BMb2NhbEZydXN0dW1baSArIDFdO1xuXHRcdFx0eiA9IHRoaXMuX3BMb2NhbEZydXN0dW1baSArIDJdO1xuXHRcdFx0aWYgKHggPCBtaW5YKVxuXHRcdFx0XHRtaW5YID0geDtcblx0XHRcdGlmICh4ID4gbWF4WClcblx0XHRcdFx0bWF4WCA9IHg7XG5cdFx0XHRpZiAoeSA8IG1pblkpXG5cdFx0XHRcdG1pblkgPSB5O1xuXHRcdFx0aWYgKHkgPiBtYXhZKVxuXHRcdFx0XHRtYXhZID0geTtcblx0XHRcdGlmICh6ID4gdGhpcy5fcE1heFopXG5cdFx0XHRcdHRoaXMuX3BNYXhaID0gejtcblx0XHRcdGkgKz0gMztcblx0XHR9XG5cblx0XHR0aGlzLl9wTWluWiA9IDE7XG5cblx0XHR2YXIgdzpudW1iZXIgPSBtYXhYIC0gbWluWDtcblx0XHR2YXIgaDpudW1iZXIgPSBtYXhZIC0gbWluWTtcblx0XHR2YXIgZDpudW1iZXIgPSAxLyh0aGlzLl9wTWF4WiAtIHRoaXMuX3BNaW5aKTtcblxuXHRcdGlmIChtaW5YIDwgMClcblx0XHRcdG1pblggLT0gdGhpcy5fcFNuYXA7IC8vIGJlY2F1c2UgaW50KCkgcm91bmRzIHVwIGZvciA8IDBcblxuXHRcdGlmIChtaW5ZIDwgMClcblx0XHRcdG1pblkgLT0gdGhpcy5fcFNuYXA7XG5cblx0XHRtaW5YID0gTWF0aC5mbG9vcihtaW5YL3RoaXMuX3BTbmFwKSp0aGlzLl9wU25hcDtcblx0XHRtaW5ZID0gTWF0aC5mbG9vcihtaW5ZL3RoaXMuX3BTbmFwKSp0aGlzLl9wU25hcDtcblxuXHRcdHZhciBzbmFwMjpudW1iZXIgPSAyKnRoaXMuX3BTbmFwO1xuXHRcdHcgPSBNYXRoLmZsb29yKHcvc25hcDIgKyAyKSpzbmFwMjtcblx0XHRoID0gTWF0aC5mbG9vcihoL3NuYXAyICsgMikqc25hcDI7XG5cblx0XHRtYXhYID0gbWluWCArIHc7XG5cdFx0bWF4WSA9IG1pblkgKyBoO1xuXG5cdFx0dyA9IDEvdztcblx0XHRoID0gMS9oO1xuXG5cdFx0cmF3WzBdID0gMip3O1xuXHRcdHJhd1s1XSA9IDIqaDtcblx0XHRyYXdbMTBdID0gZDtcblx0XHRyYXdbMTJdID0gLShtYXhYICsgbWluWCkqdztcblx0XHRyYXdbMTNdID0gLShtYXhZICsgbWluWSkqaDtcblx0XHRyYXdbMTRdID0gLXRoaXMuX3BNaW5aKmQ7XG5cdFx0cmF3WzE1XSA9IDE7XG5cdFx0cmF3WzFdID0gcmF3WzJdID0gcmF3WzNdID0gcmF3WzRdID0gcmF3WzZdID0gcmF3WzddID0gcmF3WzhdID0gcmF3WzldID0gcmF3WzExXSA9IDA7XG5cblx0XHRtYXRyaXguY29weVJhd0RhdGFGcm9tKHJhdyk7XG5cdH1cbn1cblxuZXhwb3J0ID0gRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXI7Il19