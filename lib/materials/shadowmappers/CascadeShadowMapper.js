var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3DUtils = require("awayjs-core/lib/core/geom/Matrix3DUtils");
var Rectangle = require("awayjs-core/lib/core/geom/Rectangle");

var Camera = require("awayjs-core/lib/entities/Camera");
var Event = require("awayjs-core/lib/events/Event");
var EventDispatcher = require("awayjs-core/lib/events/EventDispatcher");

var DirectionalShadowMapper = require("awayjs-core/lib/materials/shadowmappers/DirectionalShadowMapper");
var FreeMatrixProjection = require("awayjs-core/lib/projections/FreeMatrixProjection");

var CascadeShadowMapper = (function (_super) {
    __extends(CascadeShadowMapper, _super);
    function CascadeShadowMapper(numCascades) {
        if (typeof numCascades === "undefined") { numCascades = 3; }
        _super.call(this);
        this._pScissorRectsInvalid = true;

        if (numCascades < 1 || numCascades > 4)
            throw new Error("numCascades must be an integer between 1 and 4");

        this._numCascades = numCascades;
        this._changeDispatcher = new EventDispatcher(this);
        this.init();
    }
    CascadeShadowMapper.prototype.getSplitRatio = function (index /*uint*/ ) {
        return this._splitRatios[index];
    };

    CascadeShadowMapper.prototype.setSplitRatio = function (index /*uint*/ , value) {
        if (value < 0)
            value = 0;
        else if (value > 1)
            value = 1;

        if (index >= this._numCascades)
            throw new Error("index must be smaller than the number of cascades!");

        this._splitRatios[index] = value;
    };

    CascadeShadowMapper.prototype.getDepthProjections = function (partition /*uint*/ ) {
        return this._depthCameras[partition].viewProjection;
    };

    CascadeShadowMapper.prototype.init = function () {
        this._splitRatios = new Array(this._numCascades);
        this._nearPlaneDistances = new Array(this._numCascades);

        var s = 1;
        for (var i = this._numCascades - 1; i >= 0; --i) {
            this._splitRatios[i] = s;
            s *= .4;
        }

        this._texOffsetsX = Array(-1, 1, -1, 1);
        this._texOffsetsY = Array(1, 1, -1, -1);
        this._pScissorRects = new Array(4);
        this._depthLenses = new Array();
        this._depthCameras = new Array();

        for (i = 0; i < this._numCascades; ++i) {
            this._depthLenses[i] = new FreeMatrixProjection();
            this._depthCameras[i] = new Camera(this._depthLenses[i]);
        }
    };

    CascadeShadowMapper.prototype._pSetDepthMapSize = function (value /*uint*/ ) {
        _super.prototype._pSetDepthMapSize.call(this, value);

        this.invalidateScissorRects();
    };

    CascadeShadowMapper.prototype.invalidateScissorRects = function () {
        this._pScissorRectsInvalid = true;
    };

    Object.defineProperty(CascadeShadowMapper.prototype, "numCascades", {
        get: function () {
            return this._numCascades;
        },
        set: function (value /*int*/ ) {
            if (value == this._numCascades)
                return;

            if (value < 1 || value > 4)
                throw new Error("numCascades must be an integer between 1 and 4");

            this._numCascades = value;
            this.invalidateScissorRects();
            this.init();
            this.dispatchEvent(new Event(Event.CHANGE));
        },
        enumerable: true,
        configurable: true
    });


    CascadeShadowMapper.prototype.pDrawDepthMap = function (target, scene, renderer) {
        if (this._pScissorRectsInvalid)
            this.updateScissorRects();

        this._pCasterCollector.cullPlanes = this._pCullPlanes;
        this._pCasterCollector.camera = this._pOverallDepthCamera;
        this._pCasterCollector.clear();
        scene.traversePartitions(this._pCasterCollector);

        renderer._iRenderCascades(this._pCasterCollector, target, this._numCascades, this._pScissorRects, this._depthCameras);
    };

    CascadeShadowMapper.prototype.updateScissorRects = function () {
        var half = this._pDepthMapSize * .5;

        this._pScissorRects[0] = new Rectangle(0, 0, half, half);
        this._pScissorRects[1] = new Rectangle(half, 0, half, half);
        this._pScissorRects[2] = new Rectangle(0, half, half, half);
        this._pScissorRects[3] = new Rectangle(half, half, half, half);

        this._pScissorRectsInvalid = false;
    };

    CascadeShadowMapper.prototype.pUpdateDepthProjection = function (viewCamera) {
        var matrix;
        var projection = viewCamera.projection;
        var projectionNear = projection.near;
        var projectionRange = projection.far - projectionNear;

        this.pUpdateProjectionFromFrustumCorners(viewCamera, viewCamera.projection.frustumCorners, this._pMatrix);
        this._pMatrix.appendScale(.96, .96, 1);
        this._pOverallDepthProjection.matrix = this._pMatrix;
        this.pUpdateCullPlanes(viewCamera);

        for (var i = 0; i < this._numCascades; ++i) {
            matrix = this._depthLenses[i].matrix;

            this._nearPlaneDistances[i] = projectionNear + this._splitRatios[i] * projectionRange;
            this._depthCameras[i].transform = this._pOverallDepthCamera.transform;

            this.updateProjectionPartition(matrix, this._splitRatios[i], this._texOffsetsX[i], this._texOffsetsY[i]);

            this._depthLenses[i].matrix = matrix;
        }
    };

    CascadeShadowMapper.prototype.updateProjectionPartition = function (matrix, splitRatio, texOffsetX, texOffsetY) {
        var raw = Matrix3DUtils.RAW_DATA_CONTAINER;
        var xN, yN, zN;
        var xF, yF, zF;
        var minX = Number.POSITIVE_INFINITY, minY = Number.POSITIVE_INFINITY, minZ;
        var maxX = Number.NEGATIVE_INFINITY, maxY = Number.NEGATIVE_INFINITY, maxZ = Number.NEGATIVE_INFINITY;
        var i = 0;

        while (i < 12) {
            xN = this._pLocalFrustum[i];
            yN = this._pLocalFrustum[i + 1];
            zN = this._pLocalFrustum[i + 2];
            xF = xN + (this._pLocalFrustum[i + 12] - xN) * splitRatio;
            yF = yN + (this._pLocalFrustum[i + 13] - yN) * splitRatio;
            zF = zN + (this._pLocalFrustum[i + 14] - zN) * splitRatio;
            if (xN < minX)
                minX = xN;
            if (xN > maxX)
                maxX = xN;
            if (yN < minY)
                minY = yN;
            if (yN > maxY)
                maxY = yN;
            if (zN > maxZ)
                maxZ = zN;
            if (xF < minX)
                minX = xF;
            if (xF > maxX)
                maxX = xF;
            if (yF < minY)
                minY = yF;
            if (yF > maxY)
                maxY = yF;
            if (zF > maxZ)
                maxZ = zF;
            i += 3;
        }

        minZ = 1;

        var w = (maxX - minX);
        var h = (maxY - minY);
        var d = 1 / (maxZ - minZ);

        if (minX < 0)
            minX -= this._pSnap; // because int() rounds up for < 0
        if (minY < 0)
            minY -= this._pSnap;
        minX = Math.floor(minX / this._pSnap) * this._pSnap;
        minY = Math.floor(minY / this._pSnap) * this._pSnap;

        var snap2 = 2 * this._pSnap;
        w = Math.floor(w / snap2 + 1) * snap2;
        h = Math.floor(h / snap2 + 1) * snap2;

        maxX = minX + w;
        maxY = minY + h;

        w = 1 / w;
        h = 1 / h;

        raw[0] = 2 * w;
        raw[5] = 2 * h;
        raw[10] = d;
        raw[12] = -(maxX + minX) * w;
        raw[13] = -(maxY + minY) * h;
        raw[14] = -minZ * d;
        raw[15] = 1;
        raw[1] = raw[2] = raw[3] = raw[4] = raw[6] = raw[7] = raw[8] = raw[9] = raw[11] = 0;

        matrix.copyRawDataFrom(raw);
        matrix.appendScale(.96, .96, 1);
        matrix.appendTranslation(texOffsetX, texOffsetY, 0);
        matrix.appendScale(.5, .5, 1);
    };

    CascadeShadowMapper.prototype.addEventListener = function (type, listener) {
        this._changeDispatcher.addEventListener(type, listener);
    };

    CascadeShadowMapper.prototype.removeEventListener = function (type, listener) {
        this._changeDispatcher.removeEventListener(type, listener);
    };

    CascadeShadowMapper.prototype.dispatchEvent = function (event) {
        return this._changeDispatcher.dispatchEvent(event);
    };

    CascadeShadowMapper.prototype.hasEventListener = function (type) {
        return this._changeDispatcher.hasEventListener(type);
    };

    Object.defineProperty(CascadeShadowMapper.prototype, "_iNearPlaneDistances", {
        get: function () {
            return this._nearPlaneDistances;
        },
        enumerable: true,
        configurable: true
    });
    return CascadeShadowMapper;
})(DirectionalShadowMapper);

module.exports = CascadeShadowMapper;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hdGVyaWFscy9zaGFkb3dtYXBwZXJzL0Nhc2NhZGVTaGFkb3dNYXBwZXIudHMiXSwibmFtZXMiOlsiQ2FzY2FkZVNoYWRvd01hcHBlciIsIkNhc2NhZGVTaGFkb3dNYXBwZXIuY29uc3RydWN0b3IiLCJDYXNjYWRlU2hhZG93TWFwcGVyLmdldFNwbGl0UmF0aW8iLCJDYXNjYWRlU2hhZG93TWFwcGVyLnNldFNwbGl0UmF0aW8iLCJDYXNjYWRlU2hhZG93TWFwcGVyLmdldERlcHRoUHJvamVjdGlvbnMiLCJDYXNjYWRlU2hhZG93TWFwcGVyLmluaXQiLCJDYXNjYWRlU2hhZG93TWFwcGVyLl9wU2V0RGVwdGhNYXBTaXplIiwiQ2FzY2FkZVNoYWRvd01hcHBlci5pbnZhbGlkYXRlU2Npc3NvclJlY3RzIiwiQ2FzY2FkZVNoYWRvd01hcHBlci5wRHJhd0RlcHRoTWFwIiwiQ2FzY2FkZVNoYWRvd01hcHBlci51cGRhdGVTY2lzc29yUmVjdHMiLCJDYXNjYWRlU2hhZG93TWFwcGVyLnBVcGRhdGVEZXB0aFByb2plY3Rpb24iLCJDYXNjYWRlU2hhZG93TWFwcGVyLnVwZGF0ZVByb2plY3Rpb25QYXJ0aXRpb24iLCJDYXNjYWRlU2hhZG93TWFwcGVyLmFkZEV2ZW50TGlzdGVuZXIiLCJDYXNjYWRlU2hhZG93TWFwcGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIiLCJDYXNjYWRlU2hhZG93TWFwcGVyLmRpc3BhdGNoRXZlbnQiLCJDYXNjYWRlU2hhZG93TWFwcGVyLmhhc0V2ZW50TGlzdGVuZXIiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHNFQUU2RTtBQUM3RSw4REFBc0U7O0FBRXRFLHVEQUFnRTtBQUNoRSxtREFBNEQ7QUFDNUQsdUVBQThFOztBQUU5RSx3R0FBNkc7QUFDN0csc0ZBQTRGOztBQUs1RjtJQUFrQ0Esc0NBQXVCQTtJQWdCeERBLDZCQUFZQSxXQUErQkE7UUFBL0JDLDBDQUFBQSxXQUFXQSxHQUFtQkEsQ0FBQ0E7QUFBQUEsUUFFMUNBLFdBQU1BLEtB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QUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUMvQkEsRUFBRUEsR0FBR0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDL0JBLEVBQUVBLEdBQUdBLEVBQUVBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLENBQUNBLEdBQUdBLEVBQUVBLENBQUNBLEdBQUdBLEVBQUVBLENBQUNBLEdBQUNBLFVBQVVBO1lBQ3ZEQSxFQUFFQSxHQUFHQSxFQUFFQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQSxHQUFDQSxVQUFVQTtZQUN2REEsRUFBRUEsR0FBR0EsRUFBRUEsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0EsR0FBQ0EsVUFBVUE7WUFDdkRBLElBQUlBLEVBQUVBLEdBQUdBLElBQUlBO2dCQUNaQSxJQUFJQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUNYQSxJQUFJQSxFQUFFQSxHQUFHQSxJQUFJQTtnQkFDWkEsSUFBSUEsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDWEEsSUFBSUEsRUFBRUEsR0FBR0EsSUFBSUE7Z0JBQ1pBLElBQUlBLEdBQUdBLEVBQUVBLENBQUNBO1lBQ1hBLElBQUlBLEVBQUVBLEdBQUdBLElBQUlBO2dCQUNaQSxJQUFJQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUNYQSxJQUFJQSxFQUFFQSxHQUFHQSxJQUFJQTtnQkFDWkEsSUFBSUEsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDWEEsSUFBSUEsRUFBRUEsR0FBR0EsSUFBSUE7Z0JBQ1pBLElBQUlBLEdBQUdBLEVBQUVBLENBQUNBO1lBQ1hBLElBQUlBLEVBQUVBLEdBQUdBLElBQUlBO2dCQUNaQSxJQUFJQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUNYQSxJQUFJQSxFQUFFQSxHQUFHQSxJQUFJQTtnQkFDWkEsSUFBSUEsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDWEEsSUFBSUEsRUFBRUEsR0FBR0EsSUFBSUE7Z0JBQ1pBLElBQUlBLEdBQUdBLEVBQUVBLENBQUNBO1lBQ1hBLElBQUlBLEVBQUVBLEdBQUdBLElBQUlBO2dCQUNaQSxJQUFJQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUNYQSxDQUFDQSxJQUFJQSxDQUFDQTtTQUNOQTs7UUFFREEsSUFBSUEsR0FBR0EsQ0FBQ0E7O1FBRVJBLElBQUlBLENBQUNBLEdBQVVBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBO1FBQzVCQSxJQUFJQSxDQUFDQSxHQUFVQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUM1QkEsSUFBSUEsQ0FBQ0EsR0FBVUEsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7O1FBRTlCQSxJQUFJQSxJQUFJQSxHQUFHQSxDQUFDQTtZQUNYQSxJQUFJQSxJQUFJQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxrQ0FBa0NBO0FBQW5DQSxRQUNyQkEsSUFBSUEsSUFBSUEsR0FBR0EsQ0FBQ0E7WUFDWEEsSUFBSUEsSUFBSUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFDckJBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLEdBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLEdBQUNBLElBQUlBLENBQUNBLE1BQU1BO1FBQy9DQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxHQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFDQSxJQUFJQSxDQUFDQSxNQUFNQTs7UUFFL0NBLElBQUlBLEtBQUtBLEdBQVVBLENBQUNBLEdBQUNBLElBQUlBLENBQUNBLE1BQU1BO1FBQ2hDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxHQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFDQSxLQUFLQTtRQUNqQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsS0FBS0E7O1FBRWpDQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxDQUFDQTtRQUNmQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxDQUFDQTs7UUFFZkEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0E7UUFDUEEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0E7O1FBRVBBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUNBLENBQUNBO1FBQ1pBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUNBLENBQUNBO1FBQ1pBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBO1FBQ1hBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLEdBQUNBLENBQUNBO1FBQzFCQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFDQSxDQUFDQTtRQUMxQkEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsR0FBQ0EsQ0FBQ0E7UUFDakJBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBO1FBQ1hBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBOztRQUVuRkEsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsR0FBR0EsQ0FBQ0E7UUFDM0JBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLEdBQUdBLEVBQUVBLEdBQUdBLEVBQUVBLENBQUNBLENBQUNBO1FBQy9CQSxNQUFNQSxDQUFDQSxpQkFBaUJBLENBQUNBLFVBQVVBLEVBQUVBLFVBQVVBLEVBQUVBLENBQUNBLENBQUNBO1FBQ25EQSxNQUFNQSxDQUFDQSxXQUFXQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFDQTtJQUM5QkEsQ0FBQ0E7O0lBRURYLGlEQUFBQSxVQUF3QkEsSUFBV0EsRUFBRUEsUUFBaUJBO1FBRXJEWSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsSUFBSUEsRUFBRUEsUUFBUUEsQ0FBQ0E7SUFDeERBLENBQUNBOztJQUVEWixvREFBQUEsVUFBMkJBLElBQVdBLEVBQUVBLFFBQWlCQTtRQUV4RGEsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxtQkFBbUJBLENBQUNBLElBQUlBLEVBQUVBLFFBQVFBLENBQUNBO0lBQzNEQSxDQUFDQTs7SUFFRGIsOENBQUFBLFVBQXFCQSxLQUFXQTtRQUUvQmMsT0FBT0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxhQUFhQSxDQUFDQSxLQUFLQSxDQUFDQTtJQUNuREEsQ0FBQ0E7O0lBRURkLGlEQUFBQSxVQUF3QkEsSUFBV0E7UUFFbENlLE9BQU9BLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxJQUFJQSxDQUFDQTtJQUNyREEsQ0FBQ0E7O0lBRURmO1FBQUFBLEtBQUFBO1lBRUNBLE9BQU9BLElBQUlBLENBQUNBLG1CQUFtQkE7UUFDaENBLENBQUNBOzs7O0FBQUFBLElBQ0ZBLDJCQUFDQTtBQUFEQSxDQUFDQSxFQS9QaUMsdUJBQXVCLEVBK1B4RDs7QUFFRCxvQ0FBNkIsQ0FBQSIsImZpbGUiOiJtYXRlcmlhbHMvc2hhZG93bWFwcGVycy9DYXNjYWRlU2hhZG93TWFwcGVyLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9yb2JiYXRlbWFuL1dlYnN0b3JtUHJvamVjdHMvYXdheWpzLWNvcmUvIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNjZW5lXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvbnRhaW5lcnMvU2NlbmVcIik7XG5pbXBvcnQgTWF0cml4M0RcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9nZW9tL01hdHJpeDNEXCIpO1xuaW1wb3J0IE1hdHJpeDNEVXRpbHNcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2dlb20vTWF0cml4M0RVdGlsc1wiKTtcbmltcG9ydCBSZWN0YW5nbGVcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvZ2VvbS9SZWN0YW5nbGVcIik7XG5pbXBvcnQgSVJlbmRlcmVyXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL3JlbmRlci9JUmVuZGVyZXJcIik7XG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcbmltcG9ydCBFdmVudFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ldmVudHMvRXZlbnRcIik7XG5pbXBvcnQgRXZlbnREaXNwYXRjaGVyXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZXZlbnRzL0V2ZW50RGlzcGF0Y2hlclwiKTtcbmltcG9ydCBJRXZlbnREaXNwYXRjaGVyXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZXZlbnRzL0lFdmVudERpc3BhdGNoZXJcIik7XG5pbXBvcnQgRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXJcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL21hdGVyaWFscy9zaGFkb3dtYXBwZXJzL0RpcmVjdGlvbmFsU2hhZG93TWFwcGVyXCIpO1xuaW1wb3J0IEZyZWVNYXRyaXhQcm9qZWN0aW9uXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3Byb2plY3Rpb25zL0ZyZWVNYXRyaXhQcm9qZWN0aW9uXCIpO1xuaW1wb3J0IElQcm9qZWN0aW9uXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9wcm9qZWN0aW9ucy9JUHJvamVjdGlvblwiKTtcbmltcG9ydCBSZW5kZXJUZXh0dXJlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvUmVuZGVyVGV4dHVyZVwiKTtcbmltcG9ydCBUZXh0dXJlUHJveHlCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvVGV4dHVyZVByb3h5QmFzZVwiKTtcblxuY2xhc3MgQ2FzY2FkZVNoYWRvd01hcHBlciBleHRlbmRzIERpcmVjdGlvbmFsU2hhZG93TWFwcGVyIGltcGxlbWVudHMgSUV2ZW50RGlzcGF0Y2hlclxue1xuXHRwdWJsaWMgX3BTY2lzc29yUmVjdHM6UmVjdGFuZ2xlW107XG5cdHByaXZhdGUgX3BTY2lzc29yUmVjdHNJbnZhbGlkOmJvb2xlYW4gPSB0cnVlO1xuXHRwcml2YXRlIF9zcGxpdFJhdGlvczpudW1iZXJbXTtcblxuXHRwcml2YXRlIF9udW1DYXNjYWRlczpudW1iZXIgLyppbnQqLztcblx0cHJpdmF0ZSBfZGVwdGhDYW1lcmFzOkFycmF5PENhbWVyYT47XG5cdHByaXZhdGUgX2RlcHRoTGVuc2VzOkFycmF5PEZyZWVNYXRyaXhQcm9qZWN0aW9uPjtcblxuXHRwcml2YXRlIF90ZXhPZmZzZXRzWDpBcnJheTxudW1iZXI+O1xuXHRwcml2YXRlIF90ZXhPZmZzZXRzWTpBcnJheTxudW1iZXI+O1xuXG5cdHByaXZhdGUgX2NoYW5nZURpc3BhdGNoZXI6RXZlbnREaXNwYXRjaGVyO1xuXHRwcml2YXRlIF9uZWFyUGxhbmVEaXN0YW5jZXM6bnVtYmVyW107XG5cblx0Y29uc3RydWN0b3IobnVtQ2FzY2FkZXM6bnVtYmVyIC8qdWludCovID0gMylcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHRpZiAobnVtQ2FzY2FkZXMgPCAxIHx8IG51bUNhc2NhZGVzID4gNClcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIm51bUNhc2NhZGVzIG11c3QgYmUgYW4gaW50ZWdlciBiZXR3ZWVuIDEgYW5kIDRcIik7XG5cblx0XHR0aGlzLl9udW1DYXNjYWRlcyA9IG51bUNhc2NhZGVzO1xuXHRcdHRoaXMuX2NoYW5nZURpc3BhdGNoZXIgPSBuZXcgRXZlbnREaXNwYXRjaGVyKHRoaXMpO1xuXHRcdHRoaXMuaW5pdCgpO1xuXHR9XG5cblx0cHVibGljIGdldFNwbGl0UmF0aW8oaW5kZXg6bnVtYmVyIC8qdWludCovKTpudW1iZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9zcGxpdFJhdGlvc1tpbmRleF07XG5cdH1cblxuXHRwdWJsaWMgc2V0U3BsaXRSYXRpbyhpbmRleDpudW1iZXIgLyp1aW50Ki8sIHZhbHVlOm51bWJlcilcblx0e1xuXHRcdGlmICh2YWx1ZSA8IDApXG5cdFx0XHR2YWx1ZSA9IDA7XG5cdFx0ZWxzZSBpZiAodmFsdWUgPiAxKVxuXHRcdFx0dmFsdWUgPSAxO1xuXG5cdFx0aWYgKGluZGV4ID49IHRoaXMuX251bUNhc2NhZGVzKVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiaW5kZXggbXVzdCBiZSBzbWFsbGVyIHRoYW4gdGhlIG51bWJlciBvZiBjYXNjYWRlcyFcIik7XG5cblx0XHR0aGlzLl9zcGxpdFJhdGlvc1tpbmRleF0gPSB2YWx1ZTtcblx0fVxuXG5cdHB1YmxpYyBnZXREZXB0aFByb2plY3Rpb25zKHBhcnRpdGlvbjpudW1iZXIgLyp1aW50Ki8pOk1hdHJpeDNEXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fZGVwdGhDYW1lcmFzW3BhcnRpdGlvbl0udmlld1Byb2plY3Rpb247XG5cdH1cblxuXHRwcml2YXRlIGluaXQoKVxuXHR7XG5cdFx0dGhpcy5fc3BsaXRSYXRpb3MgPSBuZXcgQXJyYXk8bnVtYmVyPih0aGlzLl9udW1DYXNjYWRlcyk7XG5cdFx0dGhpcy5fbmVhclBsYW5lRGlzdGFuY2VzID0gbmV3IEFycmF5PG51bWJlcj4odGhpcy5fbnVtQ2FzY2FkZXMpO1xuXG5cdFx0dmFyIHM6bnVtYmVyID0gMTtcblx0XHRmb3IgKHZhciBpOm51bWJlciAvKmludCovID0gdGhpcy5fbnVtQ2FzY2FkZXMgLSAxOyBpID49IDA7IC0taSkge1xuXHRcdFx0dGhpcy5fc3BsaXRSYXRpb3NbaV0gPSBzO1xuXHRcdFx0cyAqPSAuNDtcblx0XHR9XG5cblx0XHR0aGlzLl90ZXhPZmZzZXRzWCA9IEFycmF5PG51bWJlcj4oLTEsIDEsIC0xLCAxKTtcblx0XHR0aGlzLl90ZXhPZmZzZXRzWSA9IEFycmF5PG51bWJlcj4oMSwgMSwgLTEsIC0xKTtcblx0XHR0aGlzLl9wU2Npc3NvclJlY3RzID0gbmV3IEFycmF5PFJlY3RhbmdsZT4oNCk7XG5cdFx0dGhpcy5fZGVwdGhMZW5zZXMgPSBuZXcgQXJyYXk8RnJlZU1hdHJpeFByb2plY3Rpb24+KCk7XG5cdFx0dGhpcy5fZGVwdGhDYW1lcmFzID0gbmV3IEFycmF5PENhbWVyYT4oKTtcblxuXHRcdGZvciAoaSA9IDA7IGkgPCB0aGlzLl9udW1DYXNjYWRlczsgKytpKSB7XG5cdFx0XHR0aGlzLl9kZXB0aExlbnNlc1tpXSA9IG5ldyBGcmVlTWF0cml4UHJvamVjdGlvbigpO1xuXHRcdFx0dGhpcy5fZGVwdGhDYW1lcmFzW2ldID0gbmV3IENhbWVyYSh0aGlzLl9kZXB0aExlbnNlc1tpXSk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIF9wU2V0RGVwdGhNYXBTaXplKHZhbHVlOm51bWJlciAvKnVpbnQqLylcblx0e1xuXHRcdHN1cGVyLl9wU2V0RGVwdGhNYXBTaXplKHZhbHVlKTtcblxuXHRcdHRoaXMuaW52YWxpZGF0ZVNjaXNzb3JSZWN0cygpO1xuXHR9XG5cblx0cHJpdmF0ZSBpbnZhbGlkYXRlU2Npc3NvclJlY3RzKClcblx0e1xuXHRcdHRoaXMuX3BTY2lzc29yUmVjdHNJbnZhbGlkID0gdHJ1ZTtcblx0fVxuXG5cdHB1YmxpYyBnZXQgbnVtQ2FzY2FkZXMoKTpudW1iZXIgLyppbnQqL1xuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX251bUNhc2NhZGVzO1xuXHR9XG5cblx0cHVibGljIHNldCBudW1DYXNjYWRlcyh2YWx1ZTpudW1iZXIgLyppbnQqLylcblx0e1xuXHRcdGlmICh2YWx1ZSA9PSB0aGlzLl9udW1DYXNjYWRlcylcblx0XHRcdHJldHVybjtcblxuXHRcdGlmICh2YWx1ZSA8IDEgfHwgdmFsdWUgPiA0KVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwibnVtQ2FzY2FkZXMgbXVzdCBiZSBhbiBpbnRlZ2VyIGJldHdlZW4gMSBhbmQgNFwiKTtcblxuXHRcdHRoaXMuX251bUNhc2NhZGVzID0gdmFsdWU7XG5cdFx0dGhpcy5pbnZhbGlkYXRlU2Npc3NvclJlY3RzKCk7XG5cdFx0dGhpcy5pbml0KCk7XG5cdFx0dGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudChFdmVudC5DSEFOR0UpKTtcblx0fVxuXG5cdHB1YmxpYyBwRHJhd0RlcHRoTWFwKHRhcmdldDpSZW5kZXJUZXh0dXJlLCBzY2VuZTpTY2VuZSwgcmVuZGVyZXI6SVJlbmRlcmVyKVxuXHR7XG5cdFx0aWYgKHRoaXMuX3BTY2lzc29yUmVjdHNJbnZhbGlkKVxuXHRcdFx0dGhpcy51cGRhdGVTY2lzc29yUmVjdHMoKTtcblxuXHRcdHRoaXMuX3BDYXN0ZXJDb2xsZWN0b3IuY3VsbFBsYW5lcyA9IHRoaXMuX3BDdWxsUGxhbmVzO1xuXHRcdHRoaXMuX3BDYXN0ZXJDb2xsZWN0b3IuY2FtZXJhID0gdGhpcy5fcE92ZXJhbGxEZXB0aENhbWVyYTtcblx0XHR0aGlzLl9wQ2FzdGVyQ29sbGVjdG9yLmNsZWFyKCk7XG5cdFx0c2NlbmUudHJhdmVyc2VQYXJ0aXRpb25zKHRoaXMuX3BDYXN0ZXJDb2xsZWN0b3IpO1xuXG5cdFx0cmVuZGVyZXIuX2lSZW5kZXJDYXNjYWRlcyh0aGlzLl9wQ2FzdGVyQ29sbGVjdG9yLCB0YXJnZXQsIHRoaXMuX251bUNhc2NhZGVzLCB0aGlzLl9wU2Npc3NvclJlY3RzLCB0aGlzLl9kZXB0aENhbWVyYXMpO1xuXHR9XG5cblx0cHJpdmF0ZSB1cGRhdGVTY2lzc29yUmVjdHMoKVxuXHR7XG5cdFx0dmFyIGhhbGY6bnVtYmVyID0gdGhpcy5fcERlcHRoTWFwU2l6ZSouNTtcblxuXHRcdHRoaXMuX3BTY2lzc29yUmVjdHNbMF0gPSBuZXcgUmVjdGFuZ2xlKDAsIDAsIGhhbGYsIGhhbGYpO1xuXHRcdHRoaXMuX3BTY2lzc29yUmVjdHNbMV0gPSBuZXcgUmVjdGFuZ2xlKGhhbGYsIDAsIGhhbGYsIGhhbGYpO1xuXHRcdHRoaXMuX3BTY2lzc29yUmVjdHNbMl0gPSBuZXcgUmVjdGFuZ2xlKDAsIGhhbGYsIGhhbGYsIGhhbGYpO1xuXHRcdHRoaXMuX3BTY2lzc29yUmVjdHNbM10gPSBuZXcgUmVjdGFuZ2xlKGhhbGYsIGhhbGYsIGhhbGYsIGhhbGYpO1xuXG5cdFx0dGhpcy5fcFNjaXNzb3JSZWN0c0ludmFsaWQgPSBmYWxzZTtcblx0fVxuXG5cdHB1YmxpYyBwVXBkYXRlRGVwdGhQcm9qZWN0aW9uKHZpZXdDYW1lcmE6Q2FtZXJhKVxuXHR7XG5cdFx0dmFyIG1hdHJpeDpNYXRyaXgzRDtcblx0XHR2YXIgcHJvamVjdGlvbjpJUHJvamVjdGlvbiA9IHZpZXdDYW1lcmEucHJvamVjdGlvbjtcblx0XHR2YXIgcHJvamVjdGlvbk5lYXI6bnVtYmVyID0gcHJvamVjdGlvbi5uZWFyO1xuXHRcdHZhciBwcm9qZWN0aW9uUmFuZ2U6bnVtYmVyID0gcHJvamVjdGlvbi5mYXIgLSBwcm9qZWN0aW9uTmVhcjtcblxuXHRcdHRoaXMucFVwZGF0ZVByb2plY3Rpb25Gcm9tRnJ1c3R1bUNvcm5lcnModmlld0NhbWVyYSwgdmlld0NhbWVyYS5wcm9qZWN0aW9uLmZydXN0dW1Db3JuZXJzLCB0aGlzLl9wTWF0cml4KTtcblx0XHR0aGlzLl9wTWF0cml4LmFwcGVuZFNjYWxlKC45NiwgLjk2LCAxKTtcblx0XHR0aGlzLl9wT3ZlcmFsbERlcHRoUHJvamVjdGlvbi5tYXRyaXggPSB0aGlzLl9wTWF0cml4O1xuXHRcdHRoaXMucFVwZGF0ZUN1bGxQbGFuZXModmlld0NhbWVyYSk7XG5cblx0XHRmb3IgKHZhciBpOm51bWJlciAvKmludCovID0gMDsgaSA8IHRoaXMuX251bUNhc2NhZGVzOyArK2kpIHtcblx0XHRcdG1hdHJpeCA9IHRoaXMuX2RlcHRoTGVuc2VzW2ldLm1hdHJpeDtcblxuXHRcdFx0dGhpcy5fbmVhclBsYW5lRGlzdGFuY2VzW2ldID0gcHJvamVjdGlvbk5lYXIgKyB0aGlzLl9zcGxpdFJhdGlvc1tpXSpwcm9qZWN0aW9uUmFuZ2U7XG5cdFx0XHR0aGlzLl9kZXB0aENhbWVyYXNbaV0udHJhbnNmb3JtID0gdGhpcy5fcE92ZXJhbGxEZXB0aENhbWVyYS50cmFuc2Zvcm07XG5cblx0XHRcdHRoaXMudXBkYXRlUHJvamVjdGlvblBhcnRpdGlvbihtYXRyaXgsIHRoaXMuX3NwbGl0UmF0aW9zW2ldLCB0aGlzLl90ZXhPZmZzZXRzWFtpXSwgdGhpcy5fdGV4T2Zmc2V0c1lbaV0pO1xuXG5cdFx0XHR0aGlzLl9kZXB0aExlbnNlc1tpXS5tYXRyaXggPSBtYXRyaXg7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSB1cGRhdGVQcm9qZWN0aW9uUGFydGl0aW9uKG1hdHJpeDpNYXRyaXgzRCwgc3BsaXRSYXRpbzpudW1iZXIsIHRleE9mZnNldFg6bnVtYmVyLCB0ZXhPZmZzZXRZOm51bWJlcilcblx0e1xuXHRcdHZhciByYXc6QXJyYXk8bnVtYmVyPiA9IE1hdHJpeDNEVXRpbHMuUkFXX0RBVEFfQ09OVEFJTkVSO1xuXHRcdHZhciB4TjpudW1iZXIsIHlOOm51bWJlciwgek46bnVtYmVyO1xuXHRcdHZhciB4RjpudW1iZXIsIHlGOm51bWJlciwgekY6bnVtYmVyO1xuXHRcdHZhciBtaW5YOm51bWJlciA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwgbWluWTpudW1iZXIgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksIG1pblo6bnVtYmVyO1xuXHRcdHZhciBtYXhYOm51bWJlciA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwgbWF4WTpudW1iZXIgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksIG1heFo6bnVtYmVyID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZO1xuXHRcdHZhciBpOm51bWJlciAvKnVpbnQqLyA9IDA7XG5cblx0XHR3aGlsZSAoaSA8IDEyKSB7XG5cdFx0XHR4TiA9IHRoaXMuX3BMb2NhbEZydXN0dW1baV07XG5cdFx0XHR5TiA9IHRoaXMuX3BMb2NhbEZydXN0dW1baSArIDFdO1xuXHRcdFx0ek4gPSB0aGlzLl9wTG9jYWxGcnVzdHVtW2kgKyAyXTtcblx0XHRcdHhGID0geE4gKyAodGhpcy5fcExvY2FsRnJ1c3R1bVtpICsgMTJdIC0geE4pKnNwbGl0UmF0aW87XG5cdFx0XHR5RiA9IHlOICsgKHRoaXMuX3BMb2NhbEZydXN0dW1baSArIDEzXSAtIHlOKSpzcGxpdFJhdGlvO1xuXHRcdFx0ekYgPSB6TiArICh0aGlzLl9wTG9jYWxGcnVzdHVtW2kgKyAxNF0gLSB6Tikqc3BsaXRSYXRpbztcblx0XHRcdGlmICh4TiA8IG1pblgpXG5cdFx0XHRcdG1pblggPSB4Tjtcblx0XHRcdGlmICh4TiA+IG1heFgpXG5cdFx0XHRcdG1heFggPSB4Tjtcblx0XHRcdGlmICh5TiA8IG1pblkpXG5cdFx0XHRcdG1pblkgPSB5Tjtcblx0XHRcdGlmICh5TiA+IG1heFkpXG5cdFx0XHRcdG1heFkgPSB5Tjtcblx0XHRcdGlmICh6TiA+IG1heFopXG5cdFx0XHRcdG1heFogPSB6Tjtcblx0XHRcdGlmICh4RiA8IG1pblgpXG5cdFx0XHRcdG1pblggPSB4Rjtcblx0XHRcdGlmICh4RiA+IG1heFgpXG5cdFx0XHRcdG1heFggPSB4Rjtcblx0XHRcdGlmICh5RiA8IG1pblkpXG5cdFx0XHRcdG1pblkgPSB5Rjtcblx0XHRcdGlmICh5RiA+IG1heFkpXG5cdFx0XHRcdG1heFkgPSB5Rjtcblx0XHRcdGlmICh6RiA+IG1heFopXG5cdFx0XHRcdG1heFogPSB6Rjtcblx0XHRcdGkgKz0gMztcblx0XHR9XG5cblx0XHRtaW5aID0gMTtcblxuXHRcdHZhciB3Om51bWJlciA9IChtYXhYIC0gbWluWCk7XG5cdFx0dmFyIGg6bnVtYmVyID0gKG1heFkgLSBtaW5ZKTtcblx0XHR2YXIgZDpudW1iZXIgPSAxLyhtYXhaIC0gbWluWik7XG5cblx0XHRpZiAobWluWCA8IDApXG5cdFx0XHRtaW5YIC09IHRoaXMuX3BTbmFwOyAvLyBiZWNhdXNlIGludCgpIHJvdW5kcyB1cCBmb3IgPCAwXG5cdFx0aWYgKG1pblkgPCAwKVxuXHRcdFx0bWluWSAtPSB0aGlzLl9wU25hcDtcblx0XHRtaW5YID0gTWF0aC5mbG9vcihtaW5YL3RoaXMuX3BTbmFwKSp0aGlzLl9wU25hcDtcblx0XHRtaW5ZID0gTWF0aC5mbG9vcihtaW5ZL3RoaXMuX3BTbmFwKSp0aGlzLl9wU25hcDtcblxuXHRcdHZhciBzbmFwMjpudW1iZXIgPSAyKnRoaXMuX3BTbmFwO1xuXHRcdHcgPSBNYXRoLmZsb29yKHcvc25hcDIgKyAxKSpzbmFwMjtcblx0XHRoID0gTWF0aC5mbG9vcihoL3NuYXAyICsgMSkqc25hcDI7XG5cblx0XHRtYXhYID0gbWluWCArIHc7XG5cdFx0bWF4WSA9IG1pblkgKyBoO1xuXG5cdFx0dyA9IDEvdztcblx0XHRoID0gMS9oO1xuXG5cdFx0cmF3WzBdID0gMip3O1xuXHRcdHJhd1s1XSA9IDIqaDtcblx0XHRyYXdbMTBdID0gZDtcblx0XHRyYXdbMTJdID0gLShtYXhYICsgbWluWCkqdztcblx0XHRyYXdbMTNdID0gLShtYXhZICsgbWluWSkqaDtcblx0XHRyYXdbMTRdID0gLW1pbloqZDtcblx0XHRyYXdbMTVdID0gMTtcblx0XHRyYXdbMV0gPSByYXdbMl0gPSByYXdbM10gPSByYXdbNF0gPSByYXdbNl0gPSByYXdbN10gPSByYXdbOF0gPSByYXdbOV0gPSByYXdbMTFdID0gMDtcblxuXHRcdG1hdHJpeC5jb3B5UmF3RGF0YUZyb20ocmF3KTtcblx0XHRtYXRyaXguYXBwZW5kU2NhbGUoLjk2LCAuOTYsIDEpO1xuXHRcdG1hdHJpeC5hcHBlbmRUcmFuc2xhdGlvbih0ZXhPZmZzZXRYLCB0ZXhPZmZzZXRZLCAwKTtcblx0XHRtYXRyaXguYXBwZW5kU2NhbGUoLjUsIC41LCAxKTtcblx0fVxuXG5cdHB1YmxpYyBhZGRFdmVudExpc3RlbmVyKHR5cGU6c3RyaW5nLCBsaXN0ZW5lcjpGdW5jdGlvbilcblx0e1xuXHRcdHRoaXMuX2NoYW5nZURpc3BhdGNoZXIuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcik7XG5cdH1cblxuXHRwdWJsaWMgcmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlOnN0cmluZywgbGlzdGVuZXI6RnVuY3Rpb24pXG5cdHtcblx0XHR0aGlzLl9jaGFuZ2VEaXNwYXRjaGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpO1xuXHR9XG5cblx0cHVibGljIGRpc3BhdGNoRXZlbnQoZXZlbnQ6RXZlbnQpXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fY2hhbmdlRGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcblx0fVxuXG5cdHB1YmxpYyBoYXNFdmVudExpc3RlbmVyKHR5cGU6c3RyaW5nKTpib29sZWFuXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fY2hhbmdlRGlzcGF0Y2hlci5oYXNFdmVudExpc3RlbmVyKHR5cGUpO1xuXHR9XG5cblx0Z2V0IF9pTmVhclBsYW5lRGlzdGFuY2VzKCk6QXJyYXk8bnVtYmVyPlxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX25lYXJQbGFuZURpc3RhbmNlcztcblx0fVxufVxuXG5leHBvcnQgPSBDYXNjYWRlU2hhZG93TWFwcGVyOyJdfQ==