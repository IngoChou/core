var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var URLLoaderDataFormat = require("awayjs-core/lib/net/URLLoaderDataFormat");
var ParserBase = require("awayjs-core/lib/parsers/ParserBase");
var ParserUtils = require("awayjs-core/lib/parsers/ParserUtils");
var ByteArray = require("awayjs-core/lib/utils/ByteArray");
var TextureUtils = require("awayjs-core/lib/utils/TextureUtils");
var ImageTexture = require("awayjs-core/lib/textures/ImageTexture");
/**
 * Texture2DParser provides a "parser" for natively supported image types (jpg, png). While it simply loads bytes into
 * a loader object, it wraps it in a BitmapDataResource so resource management can happen consistently without
 * exception cases.
 */
var Texture2DParser = (function (_super) {
    __extends(Texture2DParser, _super);
    /**
     * Creates a new Texture2DParser object.
     * @param uri The url or id of the data or file to be parsed.
     * @param extra The holder for extra contextual data that the parser might need.
     */
    function Texture2DParser() {
        _super.call(this, URLLoaderDataFormat.BLOB);
    }
    /**
     * Indicates whether or not a given file extension is supported by the parser.
     * @param extension The file extension of a potential file to be parsed.
     * @return Whether or not the given file type is supported.
     */
    Texture2DParser.supportsType = function (extension) {
        extension = extension.toLowerCase();
        return extension == "jpg" || extension == "jpeg" || extension == "png" || extension == "gif"; //|| extension == "bmp";//|| extension == "atf";
    };
    /**
     * Tests whether a data block can be parsed by the parser.
     * @param data The data block to potentially be parsed.
     * @return Whether or not the given data is supported.
     */
    Texture2DParser.supportsData = function (data) {
        if (data instanceof HTMLImageElement)
            return true;
        if (!(data instanceof ByteArray))
            return false;
        var ba = data;
        ba.position = 0;
        if (ba.readUnsignedShort() == 0xffd8)
            return true; // JPEG, maybe check for "JFIF" as well?
        ba.position = 0;
        if (ba.readShort() == 0x424D)
            return true; // BMP
        ba.position = 1;
        if (ba.readUTFBytes(3) == 'PNG')
            return true;
        ba.position = 0;
        if (ba.readUTFBytes(3) == 'GIF' && ba.readShort() == 0x3839 && ba.readByte() == 0x61)
            return true;
        ba.position = 0;
        if (ba.readUTFBytes(3) == 'ATF')
            return true;
        return false;
    };
    /**
     * @inheritDoc
     */
    Texture2DParser.prototype._pProceedParsing = function () {
        var _this = this;
        var asset;
        var sizeError = false;
        if (this._loadingImage) {
            return ParserBase.MORE_TO_PARSE;
        }
        else if (this._htmlImageElement) {
            if (TextureUtils.isHTMLImageElementValid(this._htmlImageElement)) {
                asset = new ImageTexture(this._htmlImageElement);
                this._pFinalizeAsset(asset, this._iFileName);
            }
        }
        else if (this.data instanceof HTMLImageElement) {
            if (TextureUtils.isHTMLImageElementValid(this.data)) {
                asset = new ImageTexture(this.data);
                this._pFinalizeAsset(asset, this._iFileName);
            }
            else {
                sizeError = true;
            }
        }
        else if (this.data instanceof ByteArray) {
            var ba = this.data;
            ba.position = 0;
            var htmlImageElement = ParserUtils.byteArrayToImage(this.data);
            if (TextureUtils.isHTMLImageElementValid(htmlImageElement)) {
                asset = new ImageTexture(htmlImageElement);
                this._pFinalizeAsset(asset, this._iFileName);
            }
            else {
                sizeError = true;
            }
        }
        else if (this.data instanceof ArrayBuffer) {
            this._htmlImageElement = ParserUtils.arrayBufferToImage(this.data);
            asset = new ImageTexture(this._htmlImageElement);
            this._pFinalizeAsset(asset, this._iFileName);
        }
        else if (this.data instanceof Blob) {
            this._htmlImageElement = ParserUtils.blobToImage(this.data);
            this._htmlImageElement.onload = function (event) { return _this.onLoadComplete(event); };
            this._loadingImage = true;
            return ParserBase.MORE_TO_PARSE;
        }
        if (sizeError == true) {
        }
        this._pContent = asset;
        return ParserBase.PARSING_DONE;
    };
    Texture2DParser.prototype.onLoadComplete = function (event) {
        this._loadingImage = false;
    };
    return Texture2DParser;
})(ParserBase);
module.exports = Texture2DParser;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1jb3JlL2xpYi9wYXJzZXJzL1RleHR1cmUyRFBhcnNlci50cyJdLCJuYW1lcyI6WyJUZXh0dXJlMkRQYXJzZXIiLCJUZXh0dXJlMkRQYXJzZXIuY29uc3RydWN0b3IiLCJUZXh0dXJlMkRQYXJzZXIuc3VwcG9ydHNUeXBlIiwiVGV4dHVyZTJEUGFyc2VyLnN1cHBvcnRzRGF0YSIsIlRleHR1cmUyRFBhcnNlci5fcFByb2NlZWRQYXJzaW5nIiwiVGV4dHVyZTJEUGFyc2VyLm9uTG9hZENvbXBsZXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxJQUFPLG1CQUFtQixXQUFZLHlDQUF5QyxDQUFDLENBQUM7QUFDakYsSUFBTyxVQUFVLFdBQWMsb0NBQW9DLENBQUMsQ0FBQztBQUNyRSxJQUFPLFdBQVcsV0FBYyxxQ0FBcUMsQ0FBQyxDQUFDO0FBQ3ZFLElBQU8sU0FBUyxXQUFjLGlDQUFpQyxDQUFDLENBQUM7QUFDakUsSUFBTyxZQUFZLFdBQWMsb0NBQW9DLENBQUMsQ0FBQztBQUN2RSxJQUFPLFlBQVksV0FBYyx1Q0FBdUMsQ0FBQyxDQUFDO0FBRzFFLEFBS0E7Ozs7R0FERztJQUNHLGVBQWU7SUFBU0EsVUFBeEJBLGVBQWVBLFVBQW1CQTtJQU92Q0E7Ozs7T0FJR0E7SUFDSEEsU0FaS0EsZUFBZUE7UUFjbkJDLGtCQUFNQSxtQkFBbUJBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO0lBQ2pDQSxDQUFDQTtJQUVERDs7OztPQUlHQTtJQUNXQSw0QkFBWUEsR0FBMUJBLFVBQTJCQSxTQUFnQkE7UUFHMUNFLFNBQVNBLEdBQUdBLFNBQVNBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBO1FBQ3BDQSxNQUFNQSxDQUFDQSxTQUFTQSxJQUFJQSxLQUFLQSxJQUFJQSxTQUFTQSxJQUFJQSxNQUFNQSxJQUFJQSxTQUFTQSxJQUFJQSxLQUFLQSxJQUFJQSxTQUFTQSxJQUFJQSxLQUFLQSxFQUFDQSxnREFBZ0RBO0lBRTlJQSxDQUFDQSxHQUY2RkE7SUFJOUZG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QUNBO1lBRWxEQSxFQUFFQSxDQUFDQSxDQUFDQSxZQUFZQSxDQUFDQSx1QkFBdUJBLENBQW9CQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDeEVBLEtBQUtBLEdBQUdBLElBQUlBLFlBQVlBLENBQW9CQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDdkRBLElBQUlBLENBQUNBLGVBQWVBLENBQVVBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO1lBQ3ZEQSxDQUFDQTtZQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDUEEsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDbEJBLENBQUNBO1FBRUZBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLFlBQVlBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBRTNDQSxJQUFJQSxFQUFFQSxHQUFhQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQTtZQUM3QkEsRUFBRUEsQ0FBQ0EsUUFBUUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDaEJBLElBQUlBLGdCQUFnQkEsR0FBb0JBLFdBQVdBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFFaEZBLEVBQUVBLENBQUNBLENBQUNBLFlBQVlBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDNURBLEtBQUtBLEdBQUdBLElBQUlBLFlBQVlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0E7Z0JBQzNDQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFVQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtZQUN2REEsQ0FBQ0E7WUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ1BBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBO1lBQ2xCQSxDQUFDQTtRQUVGQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxZQUFZQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUU3Q0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxHQUFHQSxXQUFXQSxDQUFDQSxrQkFBa0JBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBRW5FQSxLQUFLQSxHQUFHQSxJQUFJQSxZQUFZQSxDQUFDQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLENBQUNBO1lBQ2pEQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFVQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUV2REEsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsWUFBWUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFdENBLElBQUlBLENBQUNBLGlCQUFpQkEsR0FBR0EsV0FBV0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFFNURBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsTUFBTUEsR0FBR0EsVUFBQ0EsS0FBS0EsSUFBS0EsT0FBQUEsS0FBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsRUFBMUJBLENBQTBCQSxDQUFDQTtZQUN0RUEsSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFFMUJBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLGFBQWFBLENBQUNBO1FBQ2pDQSxDQUFDQTtRQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxJQUFJQSxJQUFJQSxDQUFDQSxDQUN0QkEsQ0FBQ0E7UUFJREEsQ0FBQ0E7UUFFREEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFFdkJBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLFlBQVlBLENBQUNBO0lBRWhDQSxDQUFDQTtJQUVNSix3Q0FBY0EsR0FBckJBLFVBQXNCQSxLQUFLQTtRQUUxQkssSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsS0FBS0EsQ0FBQ0E7SUFDNUJBLENBQUNBO0lBQ0ZMLHNCQUFDQTtBQUFEQSxDQTlJQSxBQThJQ0EsRUE5STZCLFVBQVUsRUE4SXZDO0FBRUQsQUFBeUIsaUJBQWhCLGVBQWUsQ0FBQyIsImZpbGUiOiJwYXJzZXJzL1RleHR1cmUyRFBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSUFzc2V0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9saWJyYXJ5L0lBc3NldFwiKTtcbmltcG9ydCBVUkxMb2FkZXJEYXRhRm9ybWF0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9uZXQvVVJMTG9hZGVyRGF0YUZvcm1hdFwiKTtcbmltcG9ydCBQYXJzZXJCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvcGFyc2Vycy9QYXJzZXJCYXNlXCIpO1xuaW1wb3J0IFBhcnNlclV0aWxzXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvcGFyc2Vycy9QYXJzZXJVdGlsc1wiKTtcbmltcG9ydCBCeXRlQXJyYXlcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi91dGlscy9CeXRlQXJyYXlcIik7XG5pbXBvcnQgVGV4dHVyZVV0aWxzXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdXRpbHMvVGV4dHVyZVV0aWxzXCIpO1xuaW1wb3J0IEltYWdlVGV4dHVyZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3RleHR1cmVzL0ltYWdlVGV4dHVyZVwiKTtcbmltcG9ydCBUZXh0dXJlMkRCYXNlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3RleHR1cmVzL1RleHR1cmUyREJhc2VcIik7XG5cbi8qKlxuICogVGV4dHVyZTJEUGFyc2VyIHByb3ZpZGVzIGEgXCJwYXJzZXJcIiBmb3IgbmF0aXZlbHkgc3VwcG9ydGVkIGltYWdlIHR5cGVzIChqcGcsIHBuZykuIFdoaWxlIGl0IHNpbXBseSBsb2FkcyBieXRlcyBpbnRvXG4gKiBhIGxvYWRlciBvYmplY3QsIGl0IHdyYXBzIGl0IGluIGEgQml0bWFwRGF0YVJlc291cmNlIHNvIHJlc291cmNlIG1hbmFnZW1lbnQgY2FuIGhhcHBlbiBjb25zaXN0ZW50bHkgd2l0aG91dFxuICogZXhjZXB0aW9uIGNhc2VzLlxuICovXG5jbGFzcyBUZXh0dXJlMkRQYXJzZXIgZXh0ZW5kcyBQYXJzZXJCYXNlXG57XG5cdHByaXZhdGUgX3N0YXJ0ZWRQYXJzaW5nOmJvb2xlYW47XG5cdHByaXZhdGUgX2RvbmVQYXJzaW5nOmJvb2xlYW47XG5cdHByaXZhdGUgX2xvYWRpbmdJbWFnZTpib29sZWFuO1xuXHRwcml2YXRlIF9odG1sSW1hZ2VFbGVtZW50OkhUTUxJbWFnZUVsZW1lbnQ7XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgVGV4dHVyZTJEUGFyc2VyIG9iamVjdC5cblx0ICogQHBhcmFtIHVyaSBUaGUgdXJsIG9yIGlkIG9mIHRoZSBkYXRhIG9yIGZpbGUgdG8gYmUgcGFyc2VkLlxuXHQgKiBAcGFyYW0gZXh0cmEgVGhlIGhvbGRlciBmb3IgZXh0cmEgY29udGV4dHVhbCBkYXRhIHRoYXQgdGhlIHBhcnNlciBtaWdodCBuZWVkLlxuXHQgKi9cblx0Y29uc3RydWN0b3IoKVxuXHR7XG5cdFx0c3VwZXIoVVJMTG9hZGVyRGF0YUZvcm1hdC5CTE9CKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBJbmRpY2F0ZXMgd2hldGhlciBvciBub3QgYSBnaXZlbiBmaWxlIGV4dGVuc2lvbiBpcyBzdXBwb3J0ZWQgYnkgdGhlIHBhcnNlci5cblx0ICogQHBhcmFtIGV4dGVuc2lvbiBUaGUgZmlsZSBleHRlbnNpb24gb2YgYSBwb3RlbnRpYWwgZmlsZSB0byBiZSBwYXJzZWQuXG5cdCAqIEByZXR1cm4gV2hldGhlciBvciBub3QgdGhlIGdpdmVuIGZpbGUgdHlwZSBpcyBzdXBwb3J0ZWQuXG5cdCAqL1xuXHRwdWJsaWMgc3RhdGljIHN1cHBvcnRzVHlwZShleHRlbnNpb246c3RyaW5nKTpib29sZWFuXG5cdHtcblxuXHRcdGV4dGVuc2lvbiA9IGV4dGVuc2lvbi50b0xvd2VyQ2FzZSgpO1xuXHRcdHJldHVybiBleHRlbnNpb24gPT0gXCJqcGdcIiB8fCBleHRlbnNpb24gPT0gXCJqcGVnXCIgfHwgZXh0ZW5zaW9uID09IFwicG5nXCIgfHwgZXh0ZW5zaW9uID09IFwiZ2lmXCI7Ly98fCBleHRlbnNpb24gPT0gXCJibXBcIjsvL3x8IGV4dGVuc2lvbiA9PSBcImF0ZlwiO1xuXG5cdH1cblxuXHQvKipcblx0ICogVGVzdHMgd2hldGhlciBhIGRhdGEgYmxvY2sgY2FuIGJlIHBhcnNlZCBieSB0aGUgcGFyc2VyLlxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgZGF0YSBibG9jayB0byBwb3RlbnRpYWxseSBiZSBwYXJzZWQuXG5cdCAqIEByZXR1cm4gV2hldGhlciBvciBub3QgdGhlIGdpdmVuIGRhdGEgaXMgc3VwcG9ydGVkLlxuXHQgKi9cblx0cHVibGljIHN0YXRpYyBzdXBwb3J0c0RhdGEoZGF0YTphbnkpOmJvb2xlYW5cblx0e1xuXG5cdFx0aWYgKGRhdGEgIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudClcblx0XHRcdHJldHVybiB0cnVlO1xuXG5cdFx0aWYgKCEoZGF0YSBpbnN0YW5jZW9mIEJ5dGVBcnJheSkpXG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cblx0XHR2YXIgYmE6Qnl0ZUFycmF5ID0gPEJ5dGVBcnJheT4gZGF0YTtcblx0XHRiYS5wb3NpdGlvbiA9IDA7XG5cblx0XHRpZiAoYmEucmVhZFVuc2lnbmVkU2hvcnQoKSA9PSAweGZmZDgpXG5cdFx0XHRyZXR1cm4gdHJ1ZTsgLy8gSlBFRywgbWF5YmUgY2hlY2sgZm9yIFwiSkZJRlwiIGFzIHdlbGw/XG5cblx0XHRiYS5wb3NpdGlvbiA9IDA7XG5cdFx0aWYgKGJhLnJlYWRTaG9ydCgpID09IDB4NDI0RClcblx0XHRcdHJldHVybiB0cnVlOyAvLyBCTVBcblxuXHRcdGJhLnBvc2l0aW9uID0gMTtcblx0XHRpZiAoYmEucmVhZFVURkJ5dGVzKDMpID09ICdQTkcnKVxuXHRcdFx0cmV0dXJuIHRydWU7XG5cblx0XHRiYS5wb3NpdGlvbiA9IDA7XG5cdFx0aWYgKGJhLnJlYWRVVEZCeXRlcygzKSA9PSAnR0lGJyAmJiBiYS5yZWFkU2hvcnQoKSA9PSAweDM4MzkgJiYgYmEucmVhZEJ5dGUoKSA9PSAweDYxKVxuXHRcdFx0cmV0dXJuIHRydWU7XG5cblx0XHRiYS5wb3NpdGlvbiA9IDA7XG5cdFx0aWYgKGJhLnJlYWRVVEZCeXRlcygzKSA9PSAnQVRGJylcblx0XHRcdHJldHVybiB0cnVlO1xuXG5cdFx0cmV0dXJuIGZhbHNlO1xuXG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfcFByb2NlZWRQYXJzaW5nKCk6Ym9vbGVhblxuXHR7XG5cblx0XHR2YXIgYXNzZXQ6VGV4dHVyZTJEQmFzZTtcblx0XHR2YXIgc2l6ZUVycm9yOmJvb2xlYW4gPSBmYWxzZTtcblxuXHRcdGlmICh0aGlzLl9sb2FkaW5nSW1hZ2UpIHtcblx0XHRcdHJldHVybiBQYXJzZXJCYXNlLk1PUkVfVE9fUEFSU0U7XG5cdFx0fSBlbHNlIGlmICh0aGlzLl9odG1sSW1hZ2VFbGVtZW50KSB7XG5cdFx0XHRpZiAoVGV4dHVyZVV0aWxzLmlzSFRNTEltYWdlRWxlbWVudFZhbGlkKHRoaXMuX2h0bWxJbWFnZUVsZW1lbnQpKSB7XG5cdFx0XHRcdGFzc2V0ID0gbmV3IEltYWdlVGV4dHVyZSh0aGlzLl9odG1sSW1hZ2VFbGVtZW50KTtcblx0XHRcdFx0dGhpcy5fcEZpbmFsaXplQXNzZXQoPElBc3NldD4gYXNzZXQsIHRoaXMuX2lGaWxlTmFtZSk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmICh0aGlzLmRhdGEgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50KSB7Ly8gUGFyc2UgSFRNTEltYWdlRWxlbWVudFxuXG5cdFx0XHRpZiAoVGV4dHVyZVV0aWxzLmlzSFRNTEltYWdlRWxlbWVudFZhbGlkKDxIVE1MSW1hZ2VFbGVtZW50PiB0aGlzLmRhdGEpKSB7XG5cdFx0XHRcdGFzc2V0ID0gbmV3IEltYWdlVGV4dHVyZSg8SFRNTEltYWdlRWxlbWVudD4gdGhpcy5kYXRhKTtcblx0XHRcdFx0dGhpcy5fcEZpbmFsaXplQXNzZXQoPElBc3NldD4gYXNzZXQsIHRoaXMuX2lGaWxlTmFtZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRzaXplRXJyb3IgPSB0cnVlO1xuXHRcdFx0fVxuXG5cdFx0fSBlbHNlIGlmICh0aGlzLmRhdGEgaW5zdGFuY2VvZiBCeXRlQXJyYXkpIHsgLy8gUGFyc2UgYSBCeXRlQXJyYXlcblxuXHRcdFx0dmFyIGJhOkJ5dGVBcnJheSA9IHRoaXMuZGF0YTtcblx0XHRcdGJhLnBvc2l0aW9uID0gMDtcblx0XHRcdHZhciBodG1sSW1hZ2VFbGVtZW50OkhUTUxJbWFnZUVsZW1lbnQgPSBQYXJzZXJVdGlscy5ieXRlQXJyYXlUb0ltYWdlKHRoaXMuZGF0YSk7XG5cblx0XHRcdGlmIChUZXh0dXJlVXRpbHMuaXNIVE1MSW1hZ2VFbGVtZW50VmFsaWQoaHRtbEltYWdlRWxlbWVudCkpIHtcblx0XHRcdFx0YXNzZXQgPSBuZXcgSW1hZ2VUZXh0dXJlKGh0bWxJbWFnZUVsZW1lbnQpO1xuXHRcdFx0XHR0aGlzLl9wRmluYWxpemVBc3NldCg8SUFzc2V0PiBhc3NldCwgdGhpcy5faUZpbGVOYW1lKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHNpemVFcnJvciA9IHRydWU7XG5cdFx0XHR9XG5cblx0XHR9IGVsc2UgaWYgKHRoaXMuZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7Ly8gUGFyc2UgYW4gQXJyYXlCdWZmZXJcblxuXHRcdFx0dGhpcy5faHRtbEltYWdlRWxlbWVudCA9IFBhcnNlclV0aWxzLmFycmF5QnVmZmVyVG9JbWFnZSh0aGlzLmRhdGEpO1xuXG5cdFx0XHRhc3NldCA9IG5ldyBJbWFnZVRleHR1cmUodGhpcy5faHRtbEltYWdlRWxlbWVudCk7XG5cdFx0XHR0aGlzLl9wRmluYWxpemVBc3NldCg8SUFzc2V0PiBhc3NldCwgdGhpcy5faUZpbGVOYW1lKTtcblxuXHRcdH0gZWxzZSBpZiAodGhpcy5kYXRhIGluc3RhbmNlb2YgQmxvYikgeyAvLyBQYXJzZSBhIEJsb2JcblxuXHRcdFx0dGhpcy5faHRtbEltYWdlRWxlbWVudCA9IFBhcnNlclV0aWxzLmJsb2JUb0ltYWdlKHRoaXMuZGF0YSk7XG5cblx0XHRcdHRoaXMuX2h0bWxJbWFnZUVsZW1lbnQub25sb2FkID0gKGV2ZW50KSA9PiB0aGlzLm9uTG9hZENvbXBsZXRlKGV2ZW50KTtcblx0XHRcdHRoaXMuX2xvYWRpbmdJbWFnZSA9IHRydWU7XG5cblx0XHRcdHJldHVybiBQYXJzZXJCYXNlLk1PUkVfVE9fUEFSU0U7XG5cdFx0fVxuXG5cdFx0aWYgKHNpemVFcnJvciA9PSB0cnVlKSAvLyBHZW5lcmF0ZSBuZXcgQ2hlY2tlcmJvYXJkIHRleHR1cmUgbWF0ZXJpYWxcblx0XHR7XG4vL1x0XHRcdFx0YXNzZXQgPSBuZXcgQml0bWFwVGV4dHVyZShEZWZhdWx0TWF0ZXJpYWxNYW5hZ2VyLmNyZWF0ZUNoZWNrZXJlZEJpdG1hcERhdGEoKSwgZmFsc2UpO1xuLy9cdFx0XHRcdHRoaXMuX3BGaW5hbGl6ZUFzc2V0KDxJQXNzZXQ+IGFzc2V0LCB0aGlzLl9pRmlsZU5hbWUpO1xuLy9cdFx0XHRcdHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgYXdheS5ldmVudHMuQXNzZXRFdmVudChhd2F5LmV2ZW50cy5Bc3NldEV2ZW50LlRFWFRVUkVfU0laRV9FUlJPUiwgPElBc3NldD4gYXNzZXQpKTtcblx0XHR9XG5cblx0XHR0aGlzLl9wQ29udGVudCA9IGFzc2V0O1xuXG5cdFx0cmV0dXJuIFBhcnNlckJhc2UuUEFSU0lOR19ET05FO1xuXG5cdH1cblxuXHRwdWJsaWMgb25Mb2FkQ29tcGxldGUoZXZlbnQpXG5cdHtcblx0XHR0aGlzLl9sb2FkaW5nSW1hZ2UgPSBmYWxzZTtcblx0fVxufVxuXG5leHBvcnQgPSBUZXh0dXJlMkRQYXJzZXI7Il19