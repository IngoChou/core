var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var URLLoaderDataFormat = require("awayjs-core/lib/net/URLLoaderDataFormat");
var ParserBase = require("awayjs-core/lib/parsers/ParserBase");
var ParserUtils = require("awayjs-core/lib/parsers/ParserUtils");
var ByteArray = require("awayjs-core/lib/utils/ByteArray");
var TextureUtils = require("awayjs-core/lib/utils/TextureUtils");
var ImageTexture = require("awayjs-core/lib/textures/ImageTexture");
/**
 * Texture2DParser provides a "parser" for natively supported image types (jpg, png). While it simply loads bytes into
 * a loader object, it wraps it in a BitmapDataResource so resource management can happen consistently without
 * exception cases.
 */
var Texture2DParser = (function (_super) {
    __extends(Texture2DParser, _super);
    /**
     * Creates a new Texture2DParser object.
     * @param uri The url or id of the data or file to be parsed.
     * @param extra The holder for extra contextual data that the parser might need.
     */
    function Texture2DParser() {
        _super.call(this, URLLoaderDataFormat.BLOB);
    }
    /**
     * Indicates whether or not a given file extension is supported by the parser.
     * @param extension The file extension of a potential file to be parsed.
     * @return Whether or not the given file type is supported.
     */
    Texture2DParser.supportsType = function (extension) {
        extension = extension.toLowerCase();
        return extension == "jpg" || extension == "jpeg" || extension == "png" || extension == "gif"; //|| extension == "bmp";//|| extension == "atf";
    };
    /**
     * Tests whether a data block can be parsed by the parser.
     * @param data The data block to potentially be parsed.
     * @return Whether or not the given data is supported.
     */
    Texture2DParser.supportsData = function (data) {
        if (data instanceof HTMLImageElement)
            return true;
        if (!(data instanceof ByteArray))
            return false;
        var ba = data;
        ba.position = 0;
        if (ba.readUnsignedShort() == 0xffd8)
            return true; // JPEG, maybe check for "JFIF" as well?
        ba.position = 0;
        if (ba.readShort() == 0x424D)
            return true; // BMP
        ba.position = 1;
        if (ba.readUTFBytes(3) == 'PNG')
            return true;
        ba.position = 0;
        if (ba.readUTFBytes(3) == 'GIF' && ba.readShort() == 0x3839 && ba.readByte() == 0x61)
            return true;
        ba.position = 0;
        if (ba.readUTFBytes(3) == 'ATF')
            return true;
        return false;
    };
    /**
     * @inheritDoc
     */
    Texture2DParser.prototype._pProceedParsing = function () {
        var _this = this;
        var asset;
        var sizeError = false;
        if (this._loadingImage) {
            return ParserBase.MORE_TO_PARSE;
        }
        else if (this._htmlImageElement) {
            if (TextureUtils.isHTMLImageElementValid(this._htmlImageElement)) {
                asset = new ImageTexture(this._htmlImageElement);
                this._pFinalizeAsset(asset, this._iFileName);
            }
        }
        else if (this.data instanceof HTMLImageElement) {
            if (TextureUtils.isHTMLImageElementValid(this.data)) {
                asset = new ImageTexture(this.data);
                this._pFinalizeAsset(asset, this._iFileName);
            }
            else {
                sizeError = true;
            }
        }
        else if (this.data instanceof ByteArray) {
            var ba = this.data;
            ba.position = 0;
            var htmlImageElement = ParserUtils.byteArrayToImage(this.data);
            if (TextureUtils.isHTMLImageElementValid(htmlImageElement)) {
                asset = new ImageTexture(htmlImageElement);
                this._pFinalizeAsset(asset, this._iFileName);
            }
            else {
                sizeError = true;
            }
        }
        else if (this.data instanceof ArrayBuffer) {
            this._htmlImageElement = ParserUtils.arrayBufferToImage(this.data);
            asset = new ImageTexture(this._htmlImageElement);
            this._pFinalizeAsset(asset, this._iFileName);
        }
        else if (this.data instanceof Blob) {
            this._htmlImageElement = ParserUtils.blobToImage(this.data);
            this._htmlImageElement.onload = function (event) { return _this.onLoadComplete(event); };
            this._loadingImage = true;
            return ParserBase.MORE_TO_PARSE;
        }
        if (sizeError == true) {
        }
        this._pContent = asset;
        return ParserBase.PARSING_DONE;
    };
    Texture2DParser.prototype.onLoadComplete = function (event) {
        this._loadingImage = false;
    };
    return Texture2DParser;
})(ParserBase);
module.exports = Texture2DParser;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1jb3JlL2xpYi9wYXJzZXJzL1RleHR1cmUyRFBhcnNlci50cyJdLCJuYW1lcyI6WyJUZXh0dXJlMkRQYXJzZXIiLCJUZXh0dXJlMkRQYXJzZXIuY29uc3RydWN0b3IiLCJUZXh0dXJlMkRQYXJzZXIuc3VwcG9ydHNUeXBlIiwiVGV4dHVyZTJEUGFyc2VyLnN1cHBvcnRzRGF0YSIsIlRleHR1cmUyRFBhcnNlci5fcFByb2NlZWRQYXJzaW5nIiwiVGV4dHVyZTJEUGFyc2VyLm9uTG9hZENvbXBsZXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxJQUFPLG1CQUFtQixXQUFZLHlDQUF5QyxDQUFDLENBQUM7QUFDakYsSUFBTyxVQUFVLFdBQWMsb0NBQW9DLENBQUMsQ0FBQztBQUNyRSxJQUFPLFdBQVcsV0FBYyxxQ0FBcUMsQ0FBQyxDQUFDO0FBQ3ZFLElBQU8sU0FBUyxXQUFjLGlDQUFpQyxDQUFDLENBQUM7QUFDakUsSUFBTyxZQUFZLFdBQWMsb0NBQW9DLENBQUMsQ0FBQztBQUN2RSxJQUFPLFlBQVksV0FBYyx1Q0FBdUMsQ0FBQyxDQUFDO0FBRzFFLEFBS0E7Ozs7R0FERztJQUNHLGVBQWU7SUFBU0EsVUFBeEJBLGVBQWVBLFVBQW1CQTtJQU92Q0E7Ozs7T0FJR0E7SUFDSEEsU0FaS0EsZUFBZUE7UUFjbkJDLGtCQUFNQSxtQkFBbUJBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO0lBQ2pDQSxDQUFDQTtJQUVERDs7OztPQUlHQTtJQUNXQSw0QkFBWUEsR0FBMUJBLFVBQTJCQSxTQUFnQkE7UUFHMUNFLFNBQVNBLEdBQUdBLFNBQVNBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBO1FBQ3BDQSxNQUFNQSxDQUFDQSxTQUFTQSxJQUFJQSxLQUFLQSxJQUFJQSxTQUFTQSxJQUFJQSxNQUFNQSxJQUFJQSxTQUFTQSxJQUFJQSxLQUFLQSxJQUFJQSxTQUFTQSxJQUFJQSxLQUFLQSxFQUFDQSxnREFBZ0RBO0lBRTlJQSxDQUFDQSxHQUY2RkE7SUFJOUZG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QUNBO1lBRWxEQSxFQUFFQSxDQUFDQSxDQUFDQSxZQUFZQSxDQUFDQSx1QkFBdUJBLENBQW9CQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDeEVBLEtBQUtBLEdBQUdBLElBQUlBLFlBQVlBLENBQW9CQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDdkRBLElBQUlBLENBQUNBLGVBQWVBLENBQVVBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO1lBQ3ZEQSxDQUFDQTtZQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDUEEsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDbEJBLENBQUNBO1FBRUZBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLFlBQVlBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBRTNDQSxJQUFJQSxFQUFFQSxHQUFhQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQTtZQUM3QkEsRUFBRUEsQ0FBQ0EsUUFBUUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDaEJBLElBQUlBLGdCQUFnQkEsR0FBb0JBLFdBQVdBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFFaEZBLEVBQUVBLENBQUNBLENBQUNBLFlBQVlBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDNURBLEtBQUtBLEdBQUdBLElBQUlBLFlBQVlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0E7Z0JBQzNDQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFVQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtZQUN2REEsQ0FBQ0E7WUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ1BBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBO1lBQ2xCQSxDQUFDQTtRQUVGQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxZQUFZQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUU3Q0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxHQUFHQSxXQUFXQSxDQUFDQSxrQkFBa0JBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBRW5FQSxLQUFLQSxHQUFHQSxJQUFJQSxZQUFZQSxDQUFDQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLENBQUNBO1lBQ2pEQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFVQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUV2REEsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsWUFBWUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFdENBLElBQUlBLENBQUNBLGlCQUFpQkEsR0FBR0EsV0FBV0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFFNURBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsTUFBTUEsR0FBR0EsVUFBQ0EsS0FBS0EsSUFBS0EsT0FBQUEsS0FBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsRUFBMUJBLENBQTBCQSxDQUFDQTtZQUN0RUEsSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFFMUJBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLGFBQWFBLENBQUNBO1FBQ2pDQSxDQUFDQTtRQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxJQUFJQSxJQUFJQSxDQUFDQSxDQUN0QkEsQ0FBQ0E7UUFJREEsQ0FBQ0E7UUFFREEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFFdkJBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLFlBQVlBLENBQUNBO0lBRWhDQSxDQUFDQTtJQUVNSix3Q0FBY0EsR0FBckJBLFVBQXNCQSxLQUFLQTtRQUUxQkssSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsS0FBS0EsQ0FBQ0E7SUFDNUJBLENBQUNBO0lBQ0ZMLHNCQUFDQTtBQUFEQSxDQTlJQSxBQThJQ0EsRUE5STZCLFVBQVUsRUE4SXZDO0FBRUQsQUFBeUIsaUJBQWhCLGVBQWUsQ0FBQyIsImZpbGUiOiJwYXJzZXJzL1RleHR1cmUyRFBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSUFzc2V0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9saWJyYXJ5L0lBc3NldFwiKTtcclxuaW1wb3J0IFVSTExvYWRlckRhdGFGb3JtYXRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL25ldC9VUkxMb2FkZXJEYXRhRm9ybWF0XCIpO1xyXG5pbXBvcnQgUGFyc2VyQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3BhcnNlcnMvUGFyc2VyQmFzZVwiKTtcclxuaW1wb3J0IFBhcnNlclV0aWxzXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvcGFyc2Vycy9QYXJzZXJVdGlsc1wiKTtcclxuaW1wb3J0IEJ5dGVBcnJheVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3V0aWxzL0J5dGVBcnJheVwiKTtcclxuaW1wb3J0IFRleHR1cmVVdGlsc1x0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3V0aWxzL1RleHR1cmVVdGlsc1wiKTtcclxuaW1wb3J0IEltYWdlVGV4dHVyZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3RleHR1cmVzL0ltYWdlVGV4dHVyZVwiKTtcclxuaW1wb3J0IFRleHR1cmUyREJhc2VcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvVGV4dHVyZTJEQmFzZVwiKTtcclxuXHJcbi8qKlxyXG4gKiBUZXh0dXJlMkRQYXJzZXIgcHJvdmlkZXMgYSBcInBhcnNlclwiIGZvciBuYXRpdmVseSBzdXBwb3J0ZWQgaW1hZ2UgdHlwZXMgKGpwZywgcG5nKS4gV2hpbGUgaXQgc2ltcGx5IGxvYWRzIGJ5dGVzIGludG9cclxuICogYSBsb2FkZXIgb2JqZWN0LCBpdCB3cmFwcyBpdCBpbiBhIEJpdG1hcERhdGFSZXNvdXJjZSBzbyByZXNvdXJjZSBtYW5hZ2VtZW50IGNhbiBoYXBwZW4gY29uc2lzdGVudGx5IHdpdGhvdXRcclxuICogZXhjZXB0aW9uIGNhc2VzLlxyXG4gKi9cclxuY2xhc3MgVGV4dHVyZTJEUGFyc2VyIGV4dGVuZHMgUGFyc2VyQmFzZVxyXG57XHJcblx0cHJpdmF0ZSBfc3RhcnRlZFBhcnNpbmc6Ym9vbGVhbjtcclxuXHRwcml2YXRlIF9kb25lUGFyc2luZzpib29sZWFuO1xyXG5cdHByaXZhdGUgX2xvYWRpbmdJbWFnZTpib29sZWFuO1xyXG5cdHByaXZhdGUgX2h0bWxJbWFnZUVsZW1lbnQ6SFRNTEltYWdlRWxlbWVudDtcclxuXHJcblx0LyoqXHJcblx0ICogQ3JlYXRlcyBhIG5ldyBUZXh0dXJlMkRQYXJzZXIgb2JqZWN0LlxyXG5cdCAqIEBwYXJhbSB1cmkgVGhlIHVybCBvciBpZCBvZiB0aGUgZGF0YSBvciBmaWxlIHRvIGJlIHBhcnNlZC5cclxuXHQgKiBAcGFyYW0gZXh0cmEgVGhlIGhvbGRlciBmb3IgZXh0cmEgY29udGV4dHVhbCBkYXRhIHRoYXQgdGhlIHBhcnNlciBtaWdodCBuZWVkLlxyXG5cdCAqL1xyXG5cdGNvbnN0cnVjdG9yKClcclxuXHR7XHJcblx0XHRzdXBlcihVUkxMb2FkZXJEYXRhRm9ybWF0LkJMT0IpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogSW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IGEgZ2l2ZW4gZmlsZSBleHRlbnNpb24gaXMgc3VwcG9ydGVkIGJ5IHRoZSBwYXJzZXIuXHJcblx0ICogQHBhcmFtIGV4dGVuc2lvbiBUaGUgZmlsZSBleHRlbnNpb24gb2YgYSBwb3RlbnRpYWwgZmlsZSB0byBiZSBwYXJzZWQuXHJcblx0ICogQHJldHVybiBXaGV0aGVyIG9yIG5vdCB0aGUgZ2l2ZW4gZmlsZSB0eXBlIGlzIHN1cHBvcnRlZC5cclxuXHQgKi9cclxuXHRwdWJsaWMgc3RhdGljIHN1cHBvcnRzVHlwZShleHRlbnNpb246c3RyaW5nKTpib29sZWFuXHJcblx0e1xyXG5cclxuXHRcdGV4dGVuc2lvbiA9IGV4dGVuc2lvbi50b0xvd2VyQ2FzZSgpO1xyXG5cdFx0cmV0dXJuIGV4dGVuc2lvbiA9PSBcImpwZ1wiIHx8IGV4dGVuc2lvbiA9PSBcImpwZWdcIiB8fCBleHRlbnNpb24gPT0gXCJwbmdcIiB8fCBleHRlbnNpb24gPT0gXCJnaWZcIjsvL3x8IGV4dGVuc2lvbiA9PSBcImJtcFwiOy8vfHwgZXh0ZW5zaW9uID09IFwiYXRmXCI7XHJcblxyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogVGVzdHMgd2hldGhlciBhIGRhdGEgYmxvY2sgY2FuIGJlIHBhcnNlZCBieSB0aGUgcGFyc2VyLlxyXG5cdCAqIEBwYXJhbSBkYXRhIFRoZSBkYXRhIGJsb2NrIHRvIHBvdGVudGlhbGx5IGJlIHBhcnNlZC5cclxuXHQgKiBAcmV0dXJuIFdoZXRoZXIgb3Igbm90IHRoZSBnaXZlbiBkYXRhIGlzIHN1cHBvcnRlZC5cclxuXHQgKi9cclxuXHRwdWJsaWMgc3RhdGljIHN1cHBvcnRzRGF0YShkYXRhOmFueSk6Ym9vbGVhblxyXG5cdHtcclxuXHJcblx0XHRpZiAoZGF0YSAgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50KVxyXG5cdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHJcblx0XHRpZiAoIShkYXRhIGluc3RhbmNlb2YgQnl0ZUFycmF5KSlcclxuXHRcdFx0cmV0dXJuIGZhbHNlO1xyXG5cclxuXHRcdHZhciBiYTpCeXRlQXJyYXkgPSA8Qnl0ZUFycmF5PiBkYXRhO1xyXG5cdFx0YmEucG9zaXRpb24gPSAwO1xyXG5cclxuXHRcdGlmIChiYS5yZWFkVW5zaWduZWRTaG9ydCgpID09IDB4ZmZkOClcclxuXHRcdFx0cmV0dXJuIHRydWU7IC8vIEpQRUcsIG1heWJlIGNoZWNrIGZvciBcIkpGSUZcIiBhcyB3ZWxsP1xyXG5cclxuXHRcdGJhLnBvc2l0aW9uID0gMDtcclxuXHRcdGlmIChiYS5yZWFkU2hvcnQoKSA9PSAweDQyNEQpXHJcblx0XHRcdHJldHVybiB0cnVlOyAvLyBCTVBcclxuXHJcblx0XHRiYS5wb3NpdGlvbiA9IDE7XHJcblx0XHRpZiAoYmEucmVhZFVURkJ5dGVzKDMpID09ICdQTkcnKVxyXG5cdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHJcblx0XHRiYS5wb3NpdGlvbiA9IDA7XHJcblx0XHRpZiAoYmEucmVhZFVURkJ5dGVzKDMpID09ICdHSUYnICYmIGJhLnJlYWRTaG9ydCgpID09IDB4MzgzOSAmJiBiYS5yZWFkQnl0ZSgpID09IDB4NjEpXHJcblx0XHRcdHJldHVybiB0cnVlO1xyXG5cclxuXHRcdGJhLnBvc2l0aW9uID0gMDtcclxuXHRcdGlmIChiYS5yZWFkVVRGQnl0ZXMoMykgPT0gJ0FURicpXHJcblx0XHRcdHJldHVybiB0cnVlO1xyXG5cclxuXHRcdHJldHVybiBmYWxzZTtcclxuXHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBfcFByb2NlZWRQYXJzaW5nKCk6Ym9vbGVhblxyXG5cdHtcclxuXHJcblx0XHR2YXIgYXNzZXQ6VGV4dHVyZTJEQmFzZTtcclxuXHRcdHZhciBzaXplRXJyb3I6Ym9vbGVhbiA9IGZhbHNlO1xyXG5cclxuXHRcdGlmICh0aGlzLl9sb2FkaW5nSW1hZ2UpIHtcclxuXHRcdFx0cmV0dXJuIFBhcnNlckJhc2UuTU9SRV9UT19QQVJTRTtcclxuXHRcdH0gZWxzZSBpZiAodGhpcy5faHRtbEltYWdlRWxlbWVudCkge1xyXG5cdFx0XHRpZiAoVGV4dHVyZVV0aWxzLmlzSFRNTEltYWdlRWxlbWVudFZhbGlkKHRoaXMuX2h0bWxJbWFnZUVsZW1lbnQpKSB7XHJcblx0XHRcdFx0YXNzZXQgPSBuZXcgSW1hZ2VUZXh0dXJlKHRoaXMuX2h0bWxJbWFnZUVsZW1lbnQpO1xyXG5cdFx0XHRcdHRoaXMuX3BGaW5hbGl6ZUFzc2V0KDxJQXNzZXQ+IGFzc2V0LCB0aGlzLl9pRmlsZU5hbWUpO1xyXG5cdFx0XHR9XHJcblx0XHR9IGVsc2UgaWYgKHRoaXMuZGF0YSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpIHsvLyBQYXJzZSBIVE1MSW1hZ2VFbGVtZW50XHJcblxyXG5cdFx0XHRpZiAoVGV4dHVyZVV0aWxzLmlzSFRNTEltYWdlRWxlbWVudFZhbGlkKDxIVE1MSW1hZ2VFbGVtZW50PiB0aGlzLmRhdGEpKSB7XHJcblx0XHRcdFx0YXNzZXQgPSBuZXcgSW1hZ2VUZXh0dXJlKDxIVE1MSW1hZ2VFbGVtZW50PiB0aGlzLmRhdGEpO1xyXG5cdFx0XHRcdHRoaXMuX3BGaW5hbGl6ZUFzc2V0KDxJQXNzZXQ+IGFzc2V0LCB0aGlzLl9pRmlsZU5hbWUpO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHNpemVFcnJvciA9IHRydWU7XHJcblx0XHRcdH1cclxuXHJcblx0XHR9IGVsc2UgaWYgKHRoaXMuZGF0YSBpbnN0YW5jZW9mIEJ5dGVBcnJheSkgeyAvLyBQYXJzZSBhIEJ5dGVBcnJheVxyXG5cclxuXHRcdFx0dmFyIGJhOkJ5dGVBcnJheSA9IHRoaXMuZGF0YTtcclxuXHRcdFx0YmEucG9zaXRpb24gPSAwO1xyXG5cdFx0XHR2YXIgaHRtbEltYWdlRWxlbWVudDpIVE1MSW1hZ2VFbGVtZW50ID0gUGFyc2VyVXRpbHMuYnl0ZUFycmF5VG9JbWFnZSh0aGlzLmRhdGEpO1xyXG5cclxuXHRcdFx0aWYgKFRleHR1cmVVdGlscy5pc0hUTUxJbWFnZUVsZW1lbnRWYWxpZChodG1sSW1hZ2VFbGVtZW50KSkge1xyXG5cdFx0XHRcdGFzc2V0ID0gbmV3IEltYWdlVGV4dHVyZShodG1sSW1hZ2VFbGVtZW50KTtcclxuXHRcdFx0XHR0aGlzLl9wRmluYWxpemVBc3NldCg8SUFzc2V0PiBhc3NldCwgdGhpcy5faUZpbGVOYW1lKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRzaXplRXJyb3IgPSB0cnVlO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0fSBlbHNlIGlmICh0aGlzLmRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgey8vIFBhcnNlIGFuIEFycmF5QnVmZmVyXHJcblxyXG5cdFx0XHR0aGlzLl9odG1sSW1hZ2VFbGVtZW50ID0gUGFyc2VyVXRpbHMuYXJyYXlCdWZmZXJUb0ltYWdlKHRoaXMuZGF0YSk7XHJcblxyXG5cdFx0XHRhc3NldCA9IG5ldyBJbWFnZVRleHR1cmUodGhpcy5faHRtbEltYWdlRWxlbWVudCk7XHJcblx0XHRcdHRoaXMuX3BGaW5hbGl6ZUFzc2V0KDxJQXNzZXQ+IGFzc2V0LCB0aGlzLl9pRmlsZU5hbWUpO1xyXG5cclxuXHRcdH0gZWxzZSBpZiAodGhpcy5kYXRhIGluc3RhbmNlb2YgQmxvYikgeyAvLyBQYXJzZSBhIEJsb2JcclxuXHJcblx0XHRcdHRoaXMuX2h0bWxJbWFnZUVsZW1lbnQgPSBQYXJzZXJVdGlscy5ibG9iVG9JbWFnZSh0aGlzLmRhdGEpO1xyXG5cclxuXHRcdFx0dGhpcy5faHRtbEltYWdlRWxlbWVudC5vbmxvYWQgPSAoZXZlbnQpID0+IHRoaXMub25Mb2FkQ29tcGxldGUoZXZlbnQpO1xyXG5cdFx0XHR0aGlzLl9sb2FkaW5nSW1hZ2UgPSB0cnVlO1xyXG5cclxuXHRcdFx0cmV0dXJuIFBhcnNlckJhc2UuTU9SRV9UT19QQVJTRTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoc2l6ZUVycm9yID09IHRydWUpIC8vIEdlbmVyYXRlIG5ldyBDaGVja2VyYm9hcmQgdGV4dHVyZSBtYXRlcmlhbFxyXG5cdFx0e1xyXG4vL1x0XHRcdFx0YXNzZXQgPSBuZXcgQml0bWFwVGV4dHVyZShEZWZhdWx0TWF0ZXJpYWxNYW5hZ2VyLmNyZWF0ZUNoZWNrZXJlZEJpdG1hcERhdGEoKSwgZmFsc2UpO1xyXG4vL1x0XHRcdFx0dGhpcy5fcEZpbmFsaXplQXNzZXQoPElBc3NldD4gYXNzZXQsIHRoaXMuX2lGaWxlTmFtZSk7XHJcbi8vXHRcdFx0XHR0aGlzLmRpc3BhdGNoRXZlbnQobmV3IGF3YXkuZXZlbnRzLkFzc2V0RXZlbnQoYXdheS5ldmVudHMuQXNzZXRFdmVudC5URVhUVVJFX1NJWkVfRVJST1IsIDxJQXNzZXQ+IGFzc2V0KSk7XHJcblx0XHR9XHJcblxyXG5cdFx0dGhpcy5fcENvbnRlbnQgPSBhc3NldDtcclxuXHJcblx0XHRyZXR1cm4gUGFyc2VyQmFzZS5QQVJTSU5HX0RPTkU7XHJcblxyXG5cdH1cclxuXHJcblx0cHVibGljIG9uTG9hZENvbXBsZXRlKGV2ZW50KVxyXG5cdHtcclxuXHRcdHRoaXMuX2xvYWRpbmdJbWFnZSA9IGZhbHNlO1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0ID0gVGV4dHVyZTJEUGFyc2VyOyJdfQ==