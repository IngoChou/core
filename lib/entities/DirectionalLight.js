var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var NullBounds = require("awayjs-core/lib/bounds/NullBounds");
var LightBase = require("awayjs-core/lib/core/base/LightBase");
var Matrix3D = require("awayjs-core/lib/core/geom/Matrix3D");
var Vector3D = require("awayjs-core/lib/core/geom/Vector3D");
var DirectionalLightNode = require("awayjs-core/lib/core/partition/DirectionalLightNode");

var DirectionalShadowMapper = require("awayjs-core/lib/materials/shadowmappers/DirectionalShadowMapper");

var DirectionalLight = (function (_super) {
    __extends(DirectionalLight, _super);
    function DirectionalLight(xDir, yDir, zDir) {
        if (typeof xDir === "undefined") { xDir = 0; }
        if (typeof yDir === "undefined") { yDir = -1; }
        if (typeof zDir === "undefined") { zDir = 1; }
        _super.call(this);

        this._pIsEntity = true;

        this.direction = new Vector3D(xDir, yDir, zDir);

        this._sceneDirection = new Vector3D();
    }
    Object.defineProperty(DirectionalLight.prototype, "sceneDirection", {
        get: function () {
            if (this._pSceneTransformDirty)
                this.pUpdateSceneTransform();

            return this._sceneDirection;
        },
        enumerable: true,
        configurable: true
    });

    Object.defineProperty(DirectionalLight.prototype, "direction", {
        get: function () {
            return this._direction;
        },
        set: function (value) {
            this._direction = value;

            if (!this._tmpLookAt)
                this._tmpLookAt = new Vector3D();

            this._tmpLookAt.x = this.x + this._direction.x;
            this._tmpLookAt.y = this.y + this._direction.y;
            this._tmpLookAt.z = this.z + this._direction.z;

            this.lookAt(this._tmpLookAt);
        },
        enumerable: true,
        configurable: true
    });


    /**
    *
    * @returns {away.bounds.NullBounds}
    */
    DirectionalLight.prototype.pCreateDefaultBoundingVolume = function () {
        //directional lights are to be considered global, hence always in view
        return new NullBounds();
    };

    /**
    *
    */
    DirectionalLight.prototype.pUpdateBounds = function () {
    };

    //@override
    DirectionalLight.prototype.pUpdateSceneTransform = function () {
        _super.prototype.pUpdateSceneTransform.call(this);
        this.sceneTransform.copyColumnTo(2, this._sceneDirection);
        this._sceneDirection.normalize();
    };

    //@override
    DirectionalLight.prototype.pCreateShadowMapper = function () {
        return new DirectionalShadowMapper();
    };

    /**
    * @protected
    */
    DirectionalLight.prototype.pCreateEntityPartitionNode = function () {
        return new DirectionalLightNode(this);
    };

    //override
    DirectionalLight.prototype.iGetObjectProjectionMatrix = function (entity, camera, target) {
        if (typeof target === "undefined") { target = null; }
        var raw = new Array();
        var bounds = entity.bounds;
        var m = new Matrix3D();

        m.copyFrom(entity.getRenderSceneTransform(camera));
        m.append(this.inverseSceneTransform);

        if (!this._projAABBPoints)
            this._projAABBPoints = [];

        m.transformVectors(bounds.aabbPoints, this._projAABBPoints);

        var xMin = Infinity, xMax = -Infinity;
        var yMin = Infinity, yMax = -Infinity;
        var zMin = Infinity, zMax = -Infinity;
        var d;
        for (var i = 0; i < 24;) {
            d = this._projAABBPoints[i++];

            if (d < xMin)
                xMin = d;

            if (d > xMax)
                xMax = d;

            d = this._projAABBPoints[i++];

            if (d < yMin)
                yMin = d;

            if (d > yMax)
                yMax = d;

            d = this._projAABBPoints[i++];

            if (d < zMin)
                zMin = d;

            if (d > zMax)
                zMax = d;
        }

        var invXRange = 1 / (xMax - xMin);
        var invYRange = 1 / (yMax - yMin);
        var invZRange = 1 / (zMax - zMin);
        raw[0] = 2 * invXRange;
        raw[5] = 2 * invYRange;
        raw[10] = invZRange;
        raw[12] = -(xMax + xMin) * invXRange;
        raw[13] = -(yMax + yMin) * invYRange;
        raw[14] = -zMin * invZRange;
        raw[1] = raw[2] = raw[3] = raw[4] = raw[6] = raw[7] = raw[8] = raw[9] = raw[11] = 0;
        raw[15] = 1;

        if (!target)
            target = new Matrix3D();

        target.copyRawDataFrom(raw);
        target.prepend(m);

        return target;
    };

    DirectionalLight.prototype._iCollectRenderables = function (renderer) {
        //nothing to do here
    };
    return DirectionalLight;
})(LightBase);

module.exports = DirectionalLight;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVudGl0aWVzL0RpcmVjdGlvbmFsTGlnaHQudHMiXSwibmFtZXMiOlsiRGlyZWN0aW9uYWxMaWdodCIsIkRpcmVjdGlvbmFsTGlnaHQuY29uc3RydWN0b3IiLCJEaXJlY3Rpb25hbExpZ2h0LnBDcmVhdGVEZWZhdWx0Qm91bmRpbmdWb2x1bWUiLCJEaXJlY3Rpb25hbExpZ2h0LnBVcGRhdGVCb3VuZHMiLCJEaXJlY3Rpb25hbExpZ2h0LnBVcGRhdGVTY2VuZVRyYW5zZm9ybSIsIkRpcmVjdGlvbmFsTGlnaHQucENyZWF0ZVNoYWRvd01hcHBlciIsIkRpcmVjdGlvbmFsTGlnaHQucENyZWF0ZUVudGl0eVBhcnRpdGlvbk5vZGUiLCJEaXJlY3Rpb25hbExpZ2h0LmlHZXRPYmplY3RQcm9qZWN0aW9uTWF0cml4IiwiRGlyZWN0aW9uYWxMaWdodC5faUNvbGxlY3RSZW5kZXJhYmxlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNkRBQ3FFO0FBQ3JFLDhEQUFzRTtBQUN0RSw0REFBcUU7QUFDckUsNERBQXFFO0FBQ3JFLHlGQUErRjs7QUFLL0Ysd0dBQTZHOztBQUU3RztJQUErQkEsbUNBQVNBO0lBT3ZDQSwwQkFBWUEsSUFBZUEsRUFBRUEsSUFBZ0JBLEVBQUVBLElBQWVBO1FBQWxEQyxtQ0FBQUEsSUFBSUEsR0FBVUEsQ0FBQ0E7QUFBQUEsUUFBRUEsbUNBQUFBLElBQUlBLEdBQVVBLENBQUNBLENBQUNBO0FBQUFBLFFBQUVBLG1DQUFBQSxJQUFJQSxHQUFVQSxDQUFDQTtBQUFBQSxRQUU3REEsV0FBTUEsS0FBQUEsQ0FBQ0E7O1FBRVBBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBOztRQUV0QkEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsSUFBSUEsUUFBUUEsQ0FBQ0EsSUFBSUEsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0E7O1FBRS9DQSxJQUFJQSxDQUFDQSxlQUFlQSxHQUFHQSxJQUFJQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUN0Q0Es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SUEsR0FBVUEsQ0FBQ0EsUUFBUUE7UUFDbkRBLElBQUlBLElBQUlBLEdBQVVBLFFBQVFBLEVBQUVBLElBQUlBLEdBQVVBLENBQUNBLFFBQVFBO1FBQ25EQSxJQUFJQSxJQUFJQSxHQUFVQSxRQUFRQSxFQUFFQSxJQUFJQSxHQUFVQSxDQUFDQSxRQUFRQTtRQUNuREEsSUFBSUEsQ0FBQ0E7UUFDTEEsS0FBS0EsSUFBSUEsQ0FBQ0EsR0FBVUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsRUFBRUEsRUFBR0E7WUFDL0JBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBOztZQUU3QkEsSUFBSUEsQ0FBQ0EsR0FBR0EsSUFBSUE7Z0JBQ1hBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBOztZQUVWQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQTtnQkFDWEEsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7O1lBRVZBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBOztZQUU3QkEsSUFBSUEsQ0FBQ0EsR0FBR0EsSUFBSUE7Z0JBQ1hBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBOztZQUVWQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQTtnQkFDWEEsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7O1lBRVZBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBOztZQUU3QkEsSUFBSUEsQ0FBQ0EsR0FBR0EsSUFBSUE7Z0JBQ1hBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBOztZQUVWQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQTtnQkFDWEEsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7U0FDVkE7O1FBRURBLElBQUlBLFNBQVNBLEdBQVVBLENBQUNBLEdBQUNBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBO1FBQ3RDQSxJQUFJQSxTQUFTQSxHQUFVQSxDQUFDQSxHQUFDQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUN0Q0EsSUFBSUEsU0FBU0EsR0FBVUEsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDdENBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUNBLFNBQVNBO1FBQ3BCQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFDQSxTQUFTQTtRQUNwQkEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsU0FBU0E7UUFDbkJBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLEdBQUNBLFNBQVNBO1FBQ2xDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFDQSxTQUFTQTtRQUNsQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsR0FBQ0EsU0FBU0E7UUFDekJBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBO1FBQ25GQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQTs7UUFFWEEsSUFBSUEsQ0FBQ0EsTUFBTUE7WUFDVkEsTUFBTUEsR0FBR0EsSUFBSUEsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7O1FBRXpCQSxNQUFNQSxDQUFDQSxlQUFlQSxDQUFDQSxHQUFHQSxDQUFDQTtRQUMzQkEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7O1FBRWpCQSxPQUFPQSxNQUFNQTtJQUNkQSxDQUFDQTs7SUFFRFAsa0RBQUFBLFVBQTRCQSxRQUFrQkE7UUFFN0NRLG9CQUFvQkE7SUFDckJBLENBQUNBO0lBQ0ZSLHdCQUFDQTtBQUFEQSxDQUFDQSxFQTFKOEIsU0FBUyxFQTBKdkM7O0FBRUQsaUNBQTBCLENBQUEiLCJmaWxlIjoiZW50aXRpZXMvRGlyZWN0aW9uYWxMaWdodC5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvcm9iYmF0ZW1hbi9XZWJzdG9ybVByb2plY3RzL2F3YXlqcy1jb3JlLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCb3VuZGluZ1ZvbHVtZUJhc2VcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvYm91bmRzL0JvdW5kaW5nVm9sdW1lQmFzZVwiKTtcbmltcG9ydCBOdWxsQm91bmRzXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ib3VuZHMvTnVsbEJvdW5kc1wiKTtcbmltcG9ydCBMaWdodEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvYmFzZS9MaWdodEJhc2VcIik7XG5pbXBvcnQgTWF0cml4M0RcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9nZW9tL01hdHJpeDNEXCIpO1xuaW1wb3J0IFZlY3RvcjNEXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvZ2VvbS9WZWN0b3IzRFwiKTtcbmltcG9ydCBEaXJlY3Rpb25hbExpZ2h0Tm9kZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL3BhcnRpdGlvbi9EaXJlY3Rpb25hbExpZ2h0Tm9kZVwiKTtcbmltcG9ydCBFbnRpdHlOb2RlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL3BhcnRpdGlvbi9FbnRpdHlOb2RlXCIpO1xuaW1wb3J0IElSZW5kZXJlclx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9yZW5kZXIvSVJlbmRlcmVyXCIpO1xuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XG5pbXBvcnQgSUVudGl0eVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9lbnRpdGllcy9JRW50aXR5XCIpO1xuaW1wb3J0IERpcmVjdGlvbmFsU2hhZG93TWFwcGVyXHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9tYXRlcmlhbHMvc2hhZG93bWFwcGVycy9EaXJlY3Rpb25hbFNoYWRvd01hcHBlclwiKTtcblxuY2xhc3MgRGlyZWN0aW9uYWxMaWdodCBleHRlbmRzIExpZ2h0QmFzZSBpbXBsZW1lbnRzIElFbnRpdHlcbntcblx0cHJpdmF0ZSBfZGlyZWN0aW9uOlZlY3RvcjNEO1xuXHRwcml2YXRlIF90bXBMb29rQXQ6VmVjdG9yM0Q7XG5cdHByaXZhdGUgX3NjZW5lRGlyZWN0aW9uOlZlY3RvcjNEO1xuXHRwcml2YXRlIF9wcm9qQUFCQlBvaW50czpBcnJheTxudW1iZXI+O1xuXG5cdGNvbnN0cnVjdG9yKHhEaXI6bnVtYmVyID0gMCwgeURpcjpudW1iZXIgPSAtMSwgekRpcjpudW1iZXIgPSAxKVxuXHR7XG5cdFx0c3VwZXIoKTtcblxuXHRcdHRoaXMuX3BJc0VudGl0eSA9IHRydWU7XG5cblx0XHR0aGlzLmRpcmVjdGlvbiA9IG5ldyBWZWN0b3IzRCh4RGlyLCB5RGlyLCB6RGlyKTtcblxuXHRcdHRoaXMuX3NjZW5lRGlyZWN0aW9uID0gbmV3IFZlY3RvcjNEKCk7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHNjZW5lRGlyZWN0aW9uKCk6VmVjdG9yM0Rcblx0e1xuXHRcdGlmICh0aGlzLl9wU2NlbmVUcmFuc2Zvcm1EaXJ0eSlcblx0XHRcdHRoaXMucFVwZGF0ZVNjZW5lVHJhbnNmb3JtKCk7XG5cblx0XHRyZXR1cm4gdGhpcy5fc2NlbmVEaXJlY3Rpb247XG5cdH1cblxuXHRwdWJsaWMgZ2V0IGRpcmVjdGlvbigpOlZlY3RvcjNEXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fZGlyZWN0aW9uO1xuXHR9XG5cblx0cHVibGljIHNldCBkaXJlY3Rpb24odmFsdWU6VmVjdG9yM0QpXG5cdHtcblx0XHR0aGlzLl9kaXJlY3Rpb24gPSB2YWx1ZTtcblxuXHRcdGlmICghdGhpcy5fdG1wTG9va0F0KVxuXHRcdFx0dGhpcy5fdG1wTG9va0F0ID0gbmV3IFZlY3RvcjNEKCk7XG5cblx0XHR0aGlzLl90bXBMb29rQXQueCA9IHRoaXMueCArIHRoaXMuX2RpcmVjdGlvbi54O1xuXHRcdHRoaXMuX3RtcExvb2tBdC55ID0gdGhpcy55ICsgdGhpcy5fZGlyZWN0aW9uLnk7XG5cdFx0dGhpcy5fdG1wTG9va0F0LnogPSB0aGlzLnogKyB0aGlzLl9kaXJlY3Rpb24uejtcblxuXHRcdHRoaXMubG9va0F0KHRoaXMuX3RtcExvb2tBdCk7XG5cdH1cblxuXHQvKipcblx0ICpcblx0ICogQHJldHVybnMge2F3YXkuYm91bmRzLk51bGxCb3VuZHN9XG5cdCAqL1xuXHRwdWJsaWMgcENyZWF0ZURlZmF1bHRCb3VuZGluZ1ZvbHVtZSgpOkJvdW5kaW5nVm9sdW1lQmFzZVxuXHR7XG5cdFx0Ly9kaXJlY3Rpb25hbCBsaWdodHMgYXJlIHRvIGJlIGNvbnNpZGVyZWQgZ2xvYmFsLCBoZW5jZSBhbHdheXMgaW4gdmlld1xuXHRcdHJldHVybiBuZXcgTnVsbEJvdW5kcygpO1xuXHR9XG5cblx0LyoqXG5cdCAqXG5cdCAqL1xuXHRwdWJsaWMgcFVwZGF0ZUJvdW5kcygpXG5cdHtcblx0fVxuXG5cdC8vQG92ZXJyaWRlXG5cdHB1YmxpYyBwVXBkYXRlU2NlbmVUcmFuc2Zvcm0oKVxuXHR7XG5cdFx0c3VwZXIucFVwZGF0ZVNjZW5lVHJhbnNmb3JtKCk7XG5cdFx0dGhpcy5zY2VuZVRyYW5zZm9ybS5jb3B5Q29sdW1uVG8oMiwgdGhpcy5fc2NlbmVEaXJlY3Rpb24pO1xuXHRcdHRoaXMuX3NjZW5lRGlyZWN0aW9uLm5vcm1hbGl6ZSgpO1xuXHR9XG5cblx0Ly9Ab3ZlcnJpZGVcblx0cHVibGljIHBDcmVhdGVTaGFkb3dNYXBwZXIoKTpEaXJlY3Rpb25hbFNoYWRvd01hcHBlclxuXHR7XG5cdFx0cmV0dXJuIG5ldyBEaXJlY3Rpb25hbFNoYWRvd01hcHBlcigpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBwcm90ZWN0ZWRcblx0ICovXG5cdHB1YmxpYyBwQ3JlYXRlRW50aXR5UGFydGl0aW9uTm9kZSgpOkVudGl0eU5vZGVcblx0e1xuXHRcdHJldHVybiBuZXcgRGlyZWN0aW9uYWxMaWdodE5vZGUodGhpcyk7XG5cdH1cblxuXHQvL292ZXJyaWRlXG5cdHB1YmxpYyBpR2V0T2JqZWN0UHJvamVjdGlvbk1hdHJpeChlbnRpdHk6SUVudGl0eSwgY2FtZXJhOkNhbWVyYSwgdGFyZ2V0Ok1hdHJpeDNEID0gbnVsbCk6TWF0cml4M0Rcblx0e1xuXHRcdHZhciByYXc6QXJyYXk8bnVtYmVyPiA9IG5ldyBBcnJheTxudW1iZXI+KCk7XG5cdFx0dmFyIGJvdW5kczpCb3VuZGluZ1ZvbHVtZUJhc2UgPSBlbnRpdHkuYm91bmRzO1xuXHRcdHZhciBtOk1hdHJpeDNEID0gbmV3IE1hdHJpeDNEKCk7XG5cblx0XHRtLmNvcHlGcm9tKGVudGl0eS5nZXRSZW5kZXJTY2VuZVRyYW5zZm9ybShjYW1lcmEpKTtcblx0XHRtLmFwcGVuZCh0aGlzLmludmVyc2VTY2VuZVRyYW5zZm9ybSk7XG5cblx0XHRpZiAoIXRoaXMuX3Byb2pBQUJCUG9pbnRzKVxuXHRcdFx0dGhpcy5fcHJvakFBQkJQb2ludHMgPSBbXTtcblxuXHRcdG0udHJhbnNmb3JtVmVjdG9ycyhib3VuZHMuYWFiYlBvaW50cywgdGhpcy5fcHJvakFBQkJQb2ludHMpO1xuXG5cdFx0dmFyIHhNaW46bnVtYmVyID0gSW5maW5pdHksIHhNYXg6bnVtYmVyID0gLUluZmluaXR5O1xuXHRcdHZhciB5TWluOm51bWJlciA9IEluZmluaXR5LCB5TWF4Om51bWJlciA9IC1JbmZpbml0eTtcblx0XHR2YXIgek1pbjpudW1iZXIgPSBJbmZpbml0eSwgek1heDpudW1iZXIgPSAtSW5maW5pdHk7XG5cdFx0dmFyIGQ6bnVtYmVyO1xuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IDI0Oykge1xuXHRcdFx0ZCA9IHRoaXMuX3Byb2pBQUJCUG9pbnRzW2krK107XG5cblx0XHRcdGlmIChkIDwgeE1pbilcblx0XHRcdFx0eE1pbiA9IGQ7XG5cblx0XHRcdGlmIChkID4geE1heClcblx0XHRcdFx0eE1heCA9IGQ7XG5cblx0XHRcdGQgPSB0aGlzLl9wcm9qQUFCQlBvaW50c1tpKytdO1xuXG5cdFx0XHRpZiAoZCA8IHlNaW4pXG5cdFx0XHRcdHlNaW4gPSBkO1xuXG5cdFx0XHRpZiAoZCA+IHlNYXgpXG5cdFx0XHRcdHlNYXggPSBkO1xuXG5cdFx0XHRkID0gdGhpcy5fcHJvakFBQkJQb2ludHNbaSsrXTtcblxuXHRcdFx0aWYgKGQgPCB6TWluKVxuXHRcdFx0XHR6TWluID0gZDtcblxuXHRcdFx0aWYgKGQgPiB6TWF4KVxuXHRcdFx0XHR6TWF4ID0gZDtcblx0XHR9XG5cblx0XHR2YXIgaW52WFJhbmdlOm51bWJlciA9IDEvKHhNYXggLSB4TWluKTtcblx0XHR2YXIgaW52WVJhbmdlOm51bWJlciA9IDEvKHlNYXggLSB5TWluKTtcblx0XHR2YXIgaW52WlJhbmdlOm51bWJlciA9IDEvKHpNYXggLSB6TWluKTtcblx0XHRyYXdbMF0gPSAyKmludlhSYW5nZTtcblx0XHRyYXdbNV0gPSAyKmludllSYW5nZTtcblx0XHRyYXdbMTBdID0gaW52WlJhbmdlO1xuXHRcdHJhd1sxMl0gPSAtKHhNYXggKyB4TWluKSppbnZYUmFuZ2U7XG5cdFx0cmF3WzEzXSA9IC0oeU1heCArIHlNaW4pKmludllSYW5nZTtcblx0XHRyYXdbMTRdID0gLXpNaW4qaW52WlJhbmdlO1xuXHRcdHJhd1sxXSA9IHJhd1syXSA9IHJhd1szXSA9IHJhd1s0XSA9IHJhd1s2XSA9IHJhd1s3XSA9IHJhd1s4XSA9IHJhd1s5XSA9IHJhd1sxMV0gPSAwO1xuXHRcdHJhd1sxNV0gPSAxO1xuXG5cdFx0aWYgKCF0YXJnZXQpXG5cdFx0XHR0YXJnZXQgPSBuZXcgTWF0cml4M0QoKTtcblxuXHRcdHRhcmdldC5jb3B5UmF3RGF0YUZyb20ocmF3KTtcblx0XHR0YXJnZXQucHJlcGVuZChtKTtcblxuXHRcdHJldHVybiB0YXJnZXQ7XG5cdH1cblxuXHRwdWJsaWMgX2lDb2xsZWN0UmVuZGVyYWJsZXMocmVuZGVyZXI6SVJlbmRlcmVyKVxuXHR7XG5cdFx0Ly9ub3RoaW5nIHRvIGRvIGhlcmVcblx0fVxufVxuXG5leHBvcnQgPSBEaXJlY3Rpb25hbExpZ2h0OyJdfQ==