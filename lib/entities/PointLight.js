var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var BoundingSphere = require("awayjs-core/lib/bounds/BoundingSphere");

var LightBase = require("awayjs-core/lib/core/base/LightBase");

var Matrix3D = require("awayjs-core/lib/core/geom/Matrix3D");
var Vector3D = require("awayjs-core/lib/core/geom/Vector3D");

var PointLightNode = require("awayjs-core/lib/core/partition/PointLightNode");

var CubeMapShadowMapper = require("awayjs-core/lib/materials/shadowmappers/CubeMapShadowMapper");

var PointLight = (function (_super) {
    __extends(PointLight, _super);
    function PointLight() {
        _super.call(this);
        this._pRadius = 90000;
        this._pFallOff = 100000;

        this._pIsEntity = true;

        this._pFallOffFactor = 1 / (this._pFallOff * this._pFallOff - this._pRadius * this._pRadius);
    }
    PointLight.prototype.pCreateShadowMapper = function () {
        return new CubeMapShadowMapper();
    };

    Object.defineProperty(PointLight.prototype, "radius", {
        get: function () {
            return this._pRadius;
        },
        set: function (value) {
            this._pRadius = value;

            if (this._pRadius < 0) {
                this._pRadius = 0;
            } else if (this._pRadius > this._pFallOff) {
                this._pFallOff = this._pRadius;
                this.pInvalidateBounds();
            }
            this._pFallOffFactor = 1 / (this._pFallOff * this._pFallOff - this._pRadius * this._pRadius);
        },
        enumerable: true,
        configurable: true
    });


    PointLight.prototype.iFallOffFactor = function () {
        return this._pFallOffFactor;
    };

    Object.defineProperty(PointLight.prototype, "fallOff", {
        get: function () {
            return this._pFallOff;
        },
        set: function (value) {
            this._pFallOff = value;

            if (this._pFallOff < 0)
                this._pFallOff = 0;

            if (this._pFallOff < this._pRadius)
                this._pRadius = this._pFallOff;

            this._pFallOffFactor = 1 / (this._pFallOff * this._pFallOff - this._pRadius * this._pRadius);
            this.pInvalidateBounds();
        },
        enumerable: true,
        configurable: true
    });


    /**
    * @protected
    */
    PointLight.prototype.pCreateEntityPartitionNode = function () {
        return new PointLightNode(this);
    };

    PointLight.prototype.pUpdateBounds = function () {
        this._pBounds.fromSphere(new Vector3D(), this._pFallOff);
        this._pBoundsInvalid = false;
    };

    PointLight.prototype.pCreateDefaultBoundingVolume = function () {
        //point lights are culled based on their falloff radius
        return new BoundingSphere();
    };

    PointLight.prototype.iGetObjectProjectionMatrix = function (entity, camera, target) {
        if (typeof target === "undefined") { target = null; }
        var raw = new Array(16);
        var bounds = entity.bounds;
        var m = new Matrix3D();

        // todo: do not use lookAt on Light
        m.copyFrom(entity.getRenderSceneTransform(camera));
        m.append(this._pParent.inverseSceneTransform);
        this.lookAt(m.position);

        m.copyFrom(entity.getRenderSceneTransform(camera));
        m.append(this.inverseSceneTransform);

        var box = bounds.aabb;
        var v1 = m.deltaTransformVector(new Vector3D(box.left, box.bottom, box.front));
        var v2 = m.deltaTransformVector(new Vector3D(box.right, box.top, box.back));
        var d1 = v1.x * v1.x + v1.y * v1.y + v1.z * v1.z;
        var d2 = v2.x * v2.x + v2.y * v2.y + v2.z * v2.z;
        var d = Math.sqrt(d1 > d2 ? d1 : d2);
        var zMin;
        var zMax;

        var z = m.rawData[14];
        zMin = z - d;
        zMax = z + d;

        raw[5] = raw[0] = zMin / d;
        raw[10] = zMax / (zMax - zMin);
        raw[11] = 1;
        raw[1] = raw[2] = raw[3] = raw[4] = raw[6] = raw[7] = raw[8] = raw[9] = raw[12] = raw[13] = raw[15] = 0;
        raw[14] = -zMin * raw[10];

        if (!target)
            target = new Matrix3D();

        target.copyRawDataFrom(raw);
        target.prepend(m);

        return target;
    };

    PointLight.prototype._iCollectRenderables = function (renderer) {
        //nothing to do here
    };
    return PointLight;
})(LightBase);

module.exports = PointLight;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVudGl0aWVzL1BvaW50TGlnaHQudHMiXSwibmFtZXMiOlsiUG9pbnRMaWdodCIsIlBvaW50TGlnaHQuY29uc3RydWN0b3IiLCJQb2ludExpZ2h0LnBDcmVhdGVTaGFkb3dNYXBwZXIiLCJQb2ludExpZ2h0LmlGYWxsT2ZmRmFjdG9yIiwiUG9pbnRMaWdodC5wQ3JlYXRlRW50aXR5UGFydGl0aW9uTm9kZSIsIlBvaW50TGlnaHQucFVwZGF0ZUJvdW5kcyIsIlBvaW50TGlnaHQucENyZWF0ZURlZmF1bHRCb3VuZGluZ1ZvbHVtZSIsIlBvaW50TGlnaHQuaUdldE9iamVjdFByb2plY3Rpb25NYXRyaXgiLCJQb2ludExpZ2h0Ll9pQ29sbGVjdFJlbmRlcmFibGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxxRUFBNEU7O0FBRTVFLDhEQUFzRTs7QUFFdEUsNERBQXFFO0FBQ3JFLDREQUFxRTs7QUFFckUsNkVBQW9GOztBQUlwRixnR0FBc0c7O0FBRXRHO0lBQXlCQSw2QkFBU0E7SUFNakNBO1FBRUNDLFdBQU1BLEtBQUFBLENBQUNBO1FBTlJBLEtBQU9BLFFBQVFBLEdBQVVBLEtBQUtBLENBQUNBO1FBQy9CQSxLQUFPQSxTQUFTQSxHQUFVQSxNQUFNQSxDQUFDQTs7UUFPaENBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBOztRQUV0QkEsSUFBSUEsQ0FBQ0EsZUFBZUEsR0FBR0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7SUFDdkZBLENBQUNBO0lBRURELDJDQUFBQTtRQUVDRSxPQUFPQSxJQUFJQSxtQkFBbUJBLENBQUNBLENBQUNBO0lBQ2pDQSxDQUFDQTs7SUFFREY7UUFBQUEsS0FBQUE7WUFFQ0EsT0FBT0EsSUFBSUEsQ0FBQ0EsUUFBUUE7UUFDckJBLENBQUNBO1FBRURBLEtBQUFB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LENBQUNBLENBQUNBLFFBQVFBLENBQUNBOztRQUV2QkEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsdUJBQXVCQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUNsREEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EscUJBQXFCQSxDQUFDQTs7UUFFcENBLElBQUlBLEdBQUdBLEdBQU9BLE1BQU1BLENBQUNBLElBQUlBO1FBQ3pCQSxJQUFJQSxFQUFFQSxHQUFZQSxDQUFDQSxDQUFDQSxvQkFBb0JBLENBQUNBLElBQUlBLFFBQVFBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLEVBQUVBLEdBQUdBLENBQUNBLE1BQU1BLEVBQUVBLEdBQUdBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBQ3ZGQSxJQUFJQSxFQUFFQSxHQUFZQSxDQUFDQSxDQUFDQSxvQkFBb0JBLENBQUNBLElBQUlBLFFBQVFBLENBQUNBLEdBQUdBLENBQUNBLEtBQUtBLEVBQUVBLEdBQUdBLENBQUNBLEdBQUdBLEVBQUVBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ3BGQSxJQUFJQSxFQUFFQSxHQUFVQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUNqREEsSUFBSUEsRUFBRUEsR0FBVUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDakRBLElBQUlBLENBQUNBLEdBQVVBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLEdBQUdBLEVBQUVBLEdBQUVBLEVBQUVBLEdBQUdBLEVBQUVBLENBQUNBO1FBQzFDQSxJQUFJQSxJQUFJQTtRQUNSQSxJQUFJQSxJQUFJQTs7UUFFUkEsSUFBSUEsQ0FBQ0EsR0FBVUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsRUFBRUEsQ0FBQ0E7UUFDNUJBLElBQUlBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBO1FBQ1pBLElBQUlBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBOztRQUVaQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxHQUFDQSxDQUFDQTtRQUN4QkEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsR0FBQ0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDNUJBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBO1FBQ1hBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBO1FBQ3ZHQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxHQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQTs7UUFFdkJBLElBQUlBLENBQUNBLE1BQU1BO1lBQ1ZBLE1BQU1BLEdBQUdBLElBQUlBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBOztRQUV6QkEsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsR0FBR0EsQ0FBQ0E7UUFDM0JBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBOztRQUVqQkEsT0FBT0EsTUFBTUE7SUFDZEEsQ0FBQ0E7O0lBRURQLDRDQUFBQSxVQUE0QkEsUUFBa0JBO1FBRTdDUSxvQkFBb0JBO0lBQ3JCQSxDQUFDQTtJQUNGUixrQkFBQ0E7QUFBREEsQ0FBQ0EsRUFoSXdCLFNBQVMsRUFnSWpDOztBQUVELDJCQUFvQixDQUFBIiwiZmlsZSI6ImVudGl0aWVzL1BvaW50TGlnaHQuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL3JvYmJhdGVtYW4vV2Vic3Rvcm1Qcm9qZWN0cy9hd2F5anMtY29yZS8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQm91bmRpbmdTcGhlcmVcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ib3VuZHMvQm91bmRpbmdTcGhlcmVcIik7XG5pbXBvcnQgQm91bmRpbmdWb2x1bWVCYXNlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2JvdW5kcy9Cb3VuZGluZ1ZvbHVtZUJhc2VcIik7XG5pbXBvcnQgTGlnaHRCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2Jhc2UvTGlnaHRCYXNlXCIpO1xuaW1wb3J0IEJveFx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvZ2VvbS9Cb3hcIik7XG5pbXBvcnQgTWF0cml4M0RcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9nZW9tL01hdHJpeDNEXCIpO1xuaW1wb3J0IFZlY3RvcjNEXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvZ2VvbS9WZWN0b3IzRFwiKTtcbmltcG9ydCBFbnRpdHlOb2RlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL3BhcnRpdGlvbi9FbnRpdHlOb2RlXCIpO1xuaW1wb3J0IFBvaW50TGlnaHROb2RlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9wYXJ0aXRpb24vUG9pbnRMaWdodE5vZGVcIik7XG5pbXBvcnQgSVJlbmRlcmVyXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL3JlbmRlci9JUmVuZGVyZXJcIik7XG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcbmltcG9ydCBJRW50aXR5XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2VudGl0aWVzL0lFbnRpdHlcIik7XG5pbXBvcnQgQ3ViZU1hcFNoYWRvd01hcHBlclx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9tYXRlcmlhbHMvc2hhZG93bWFwcGVycy9DdWJlTWFwU2hhZG93TWFwcGVyXCIpO1xuXG5jbGFzcyBQb2ludExpZ2h0IGV4dGVuZHMgTGlnaHRCYXNlIGltcGxlbWVudHMgSUVudGl0eVxue1xuXHRwdWJsaWMgX3BSYWRpdXM6bnVtYmVyID0gOTAwMDA7XG5cdHB1YmxpYyBfcEZhbGxPZmY6bnVtYmVyID0gMTAwMDAwO1xuXHRwdWJsaWMgX3BGYWxsT2ZmRmFjdG9yOm51bWJlcjtcblxuXHRjb25zdHJ1Y3RvcigpXG5cdHtcblx0XHRzdXBlcigpO1xuXG5cdFx0dGhpcy5fcElzRW50aXR5ID0gdHJ1ZTtcblxuXHRcdHRoaXMuX3BGYWxsT2ZmRmFjdG9yID0gMS8odGhpcy5fcEZhbGxPZmYqdGhpcy5fcEZhbGxPZmYgLSB0aGlzLl9wUmFkaXVzKnRoaXMuX3BSYWRpdXMpO1xuXHR9XG5cblx0cHVibGljIHBDcmVhdGVTaGFkb3dNYXBwZXIoKTpDdWJlTWFwU2hhZG93TWFwcGVyXG5cdHtcblx0XHRyZXR1cm4gbmV3IEN1YmVNYXBTaGFkb3dNYXBwZXIoKTtcblx0fVxuXG5cdHB1YmxpYyBnZXQgcmFkaXVzKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fcFJhZGl1cztcblx0fVxuXG5cdHB1YmxpYyBzZXQgcmFkaXVzKHZhbHVlOm51bWJlcilcblx0e1xuXHRcdHRoaXMuX3BSYWRpdXMgPSB2YWx1ZTtcblxuXHRcdGlmICh0aGlzLl9wUmFkaXVzIDwgMCkge1xuXHRcdFx0dGhpcy5fcFJhZGl1cyA9IDA7XG5cdFx0fSBlbHNlIGlmICh0aGlzLl9wUmFkaXVzID4gdGhpcy5fcEZhbGxPZmYpIHtcblx0XHRcdHRoaXMuX3BGYWxsT2ZmID0gdGhpcy5fcFJhZGl1cztcblx0XHRcdHRoaXMucEludmFsaWRhdGVCb3VuZHMoKTtcblx0XHR9XG5cdFx0dGhpcy5fcEZhbGxPZmZGYWN0b3IgPSAxLyggdGhpcy5fcEZhbGxPZmYqdGhpcy5fcEZhbGxPZmYgLSB0aGlzLl9wUmFkaXVzKnRoaXMuX3BSYWRpdXMgKTtcblx0fVxuXG5cdHB1YmxpYyBpRmFsbE9mZkZhY3RvcigpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3BGYWxsT2ZmRmFjdG9yO1xuXHR9XG5cblx0cHVibGljIGdldCBmYWxsT2ZmKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fcEZhbGxPZmY7XG5cdH1cblxuXHRwdWJsaWMgc2V0IGZhbGxPZmYodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fcEZhbGxPZmYgPSB2YWx1ZTtcblxuXHRcdGlmICh0aGlzLl9wRmFsbE9mZiA8IDApXG5cdFx0XHR0aGlzLl9wRmFsbE9mZiA9IDA7XG5cblx0XHRpZiAodGhpcy5fcEZhbGxPZmYgPCB0aGlzLl9wUmFkaXVzKVxuXHRcdFx0dGhpcy5fcFJhZGl1cyA9IHRoaXMuX3BGYWxsT2ZmO1xuXG5cdFx0dGhpcy5fcEZhbGxPZmZGYWN0b3IgPSAxLyggdGhpcy5fcEZhbGxPZmYqdGhpcy5fcEZhbGxPZmYgLSB0aGlzLl9wUmFkaXVzKnRoaXMuX3BSYWRpdXMpO1xuXHRcdHRoaXMucEludmFsaWRhdGVCb3VuZHMoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAcHJvdGVjdGVkXG5cdCAqL1xuXHRwdWJsaWMgcENyZWF0ZUVudGl0eVBhcnRpdGlvbk5vZGUoKTpFbnRpdHlOb2RlXG5cdHtcblx0XHRyZXR1cm4gbmV3IFBvaW50TGlnaHROb2RlKHRoaXMpO1xuXHR9XG5cblx0cHVibGljIHBVcGRhdGVCb3VuZHMoKVxuXHR7XG5cdFx0dGhpcy5fcEJvdW5kcy5mcm9tU3BoZXJlKG5ldyBWZWN0b3IzRCgpLCB0aGlzLl9wRmFsbE9mZik7XG5cdFx0dGhpcy5fcEJvdW5kc0ludmFsaWQgPSBmYWxzZTtcblx0fVxuXG5cdHB1YmxpYyBwQ3JlYXRlRGVmYXVsdEJvdW5kaW5nVm9sdW1lKCk6Qm91bmRpbmdWb2x1bWVCYXNlXG5cdHtcblx0XHQvL3BvaW50IGxpZ2h0cyBhcmUgY3VsbGVkIGJhc2VkIG9uIHRoZWlyIGZhbGxvZmYgcmFkaXVzXG5cdFx0cmV0dXJuIG5ldyBCb3VuZGluZ1NwaGVyZSgpO1xuXHR9XG5cblx0cHVibGljIGlHZXRPYmplY3RQcm9qZWN0aW9uTWF0cml4KGVudGl0eTpJRW50aXR5LCBjYW1lcmE6Q2FtZXJhLCB0YXJnZXQ6TWF0cml4M0QgPSBudWxsKTpNYXRyaXgzRFxuXHR7XG5cdFx0dmFyIHJhdzpudW1iZXJbXSA9IG5ldyBBcnJheTxudW1iZXI+KDE2KTtcblx0XHR2YXIgYm91bmRzOkJvdW5kaW5nVm9sdW1lQmFzZSA9IGVudGl0eS5ib3VuZHM7XG5cdFx0dmFyIG06TWF0cml4M0QgPSBuZXcgTWF0cml4M0QoKTtcblxuXHRcdC8vIHRvZG86IGRvIG5vdCB1c2UgbG9va0F0IG9uIExpZ2h0XG5cdFx0bS5jb3B5RnJvbShlbnRpdHkuZ2V0UmVuZGVyU2NlbmVUcmFuc2Zvcm0oY2FtZXJhKSk7XG5cdFx0bS5hcHBlbmQodGhpcy5fcFBhcmVudC5pbnZlcnNlU2NlbmVUcmFuc2Zvcm0pO1xuXHRcdHRoaXMubG9va0F0KG0ucG9zaXRpb24pO1xuXG5cdFx0bS5jb3B5RnJvbShlbnRpdHkuZ2V0UmVuZGVyU2NlbmVUcmFuc2Zvcm0oY2FtZXJhKSk7XG5cdFx0bS5hcHBlbmQodGhpcy5pbnZlcnNlU2NlbmVUcmFuc2Zvcm0pO1xuXG5cdFx0dmFyIGJveDpCb3ggPSBib3VuZHMuYWFiYjtcblx0XHR2YXIgdjE6VmVjdG9yM0QgPSBtLmRlbHRhVHJhbnNmb3JtVmVjdG9yKG5ldyBWZWN0b3IzRChib3gubGVmdCwgYm94LmJvdHRvbSwgYm94LmZyb250KSk7XG5cdFx0dmFyIHYyOlZlY3RvcjNEID0gbS5kZWx0YVRyYW5zZm9ybVZlY3RvcihuZXcgVmVjdG9yM0QoYm94LnJpZ2h0LCBib3gudG9wLCBib3guYmFjaykpO1xuXHRcdHZhciBkMTpudW1iZXIgPSB2MS54KnYxLnggKyB2MS55KnYxLnkgKyB2MS56KnYxLno7XG5cdFx0dmFyIGQyOm51bWJlciA9IHYyLngqdjIueCArIHYyLnkqdjIueSArIHYyLnoqdjIuejtcblx0XHR2YXIgZDpudW1iZXIgPSBNYXRoLnNxcnQoZDEgPiBkMj8gZDEgOiBkMik7XG5cdFx0dmFyIHpNaW46bnVtYmVyO1xuXHRcdHZhciB6TWF4Om51bWJlcjtcblxuXHRcdHZhciB6Om51bWJlciA9IG0ucmF3RGF0YVsxNF07XG5cdFx0ek1pbiA9IHogLSBkO1xuXHRcdHpNYXggPSB6ICsgZDtcblxuXHRcdHJhd1s1XSA9IHJhd1swXSA9IHpNaW4vZDtcblx0XHRyYXdbMTBdID0gek1heC8oek1heCAtIHpNaW4pO1xuXHRcdHJhd1sxMV0gPSAxO1xuXHRcdHJhd1sxXSA9IHJhd1syXSA9IHJhd1szXSA9IHJhd1s0XSA9IHJhd1s2XSA9IHJhd1s3XSA9IHJhd1s4XSA9IHJhd1s5XSA9IHJhd1sxMl0gPSByYXdbMTNdID0gcmF3WzE1XSA9IDA7XG5cdFx0cmF3WzE0XSA9IC16TWluKnJhd1sxMF07XG5cblx0XHRpZiAoIXRhcmdldClcblx0XHRcdHRhcmdldCA9IG5ldyBNYXRyaXgzRCgpO1xuXG5cdFx0dGFyZ2V0LmNvcHlSYXdEYXRhRnJvbShyYXcpO1xuXHRcdHRhcmdldC5wcmVwZW5kKG0pO1xuXG5cdFx0cmV0dXJuIHRhcmdldDtcblx0fVxuXG5cdHB1YmxpYyBfaUNvbGxlY3RSZW5kZXJhYmxlcyhyZW5kZXJlcjpJUmVuZGVyZXIpXG5cdHtcblx0XHQvL25vdGhpbmcgdG8gZG8gaGVyZVxuXHR9XG59XG5cbmV4cG9ydCA9IFBvaW50TGlnaHQ7Il19